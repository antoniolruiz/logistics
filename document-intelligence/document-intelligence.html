<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light mode colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-primary: #e5e7eb;
            --border-secondary: #d1d5db;
            --accent-primary: #3b82f6;
            --accent-secondary: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-primary: #374151;
            --border-secondary: #4b5563;
            --accent-primary: #60a5fa;
            --accent-secondary: #3b82f6;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .bg-white { background-color: var(--bg-primary) !important; }
        .bg-gray-50 { background-color: var(--bg-secondary) !important; }
        .bg-gray-100 { background-color: var(--bg-tertiary) !important; }
        .text-gray-900 { color: var(--text-primary) !important; }
        .text-gray-700 { color: var(--text-secondary) !important; }
        .text-gray-600 { color: var(--text-secondary) !important; }
        .text-gray-500 { color: var(--text-tertiary) !important; }
        .border-gray-200 { border-color: var(--border-primary) !important; }
        .border-gray-300 { border-color: var(--border-secondary) !important; }
        
        .font-google-sans {
            font-family: 'Roboto', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #message {
            white-space: pre-wrap;
            text-align: left;
            background-color: #fef2f2;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
            color: #b91c1c;
        }
        .translate-x-full {
             transform: translateX(100%);
        }
        .side-panel-tab.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .editable-field {
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
            border-radius: 0.375rem;
            padding: 0.15em 0.35em;
        }
        .editable-field:hover, .editable-field:focus {
            background: #e0e7ff;
            border: 1px solid #6366f1;
            outline: none;
        }
        .editable-input:focus {
            background: #eef2ff;
            border: 1.5px solid #6366f1;
            outline: none;
        }
        .editable-table-cell {
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
            border-radius: 0.375rem;
        }
        .editable-table-cell:hover, .editable-table-cell:focus {
            background: #e0e7ff;
            border: 1px solid #6366f1;
            outline: none;
        }
        .field-block, .mt-1.flex.items-center.p-2.border.bg-gray-50.rounded-md { margin-bottom: 1.1rem !important; }
        
        /* Progress bar rotation and animation */
        #progressBar {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 50%, #3b82f6 100%);
            background-size: 200% 100%;
            animation: progressShimmer 2s ease-in-out infinite;
        }
        
        @keyframes progressShimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Animated dots */
        .animated-dots {
            display: inline-block;
            animation: dotAnimation 1.5s infinite;
        }
        
        @keyframes dotAnimation {
            0% { content: ""; }
            25% { content: "."; }
            50% { content: ".."; }
            75% { content: "..."; }
            100% { content: ""; }
        }
        
        .animated-dots::after {
            content: "";
            animation: dotAnimation 1.5s infinite;
        }
        
        /* Coordinate overlay styles */
        .coordinate-overlay {
            position: absolute;
            border: 4px solid #ef4444;
            background-color: rgba(239, 68, 68, 0.4);
            pointer-events: none;
            z-index: 15;
            transition: opacity 0.2s ease-in-out;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.8), inset 0 0 10px rgba(239, 68, 68, 0.3);
            border-radius: 4px;
        }
        
        .field-with-coordinates {
            position: relative;
        }
        
        .field-with-coordinates:hover .coordinate-overlay {
            opacity: 1;
        }
        
        .carousel-container {
            position: relative;
            overflow: visible;
        }
        
        /* Compact UI styles */
        .compact-field {
            margin-bottom: 0.75rem !important;
        }
        
        .compact-field label {
            margin-bottom: 0.25rem !important;
            font-size: 0.875rem !important;
        }
        
        .compact-field .field-container {
            padding: 0.5rem !important;
            min-height: 2.25rem;
        }
        
        /* Ensure full visibility */
        .grid-container {
            min-height: fit-content;
        }
        
        /* Table cell hover effects */
        .editable-table-cell:hover {
            background-color: #f3f4f6 !important;
            cursor: pointer;
        }
        
        /* Enhanced table styling */
        .data-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table th:first-child {
            border-top-left-radius: 8px;
        }
        
        .data-table th:last-child {
            border-top-right-radius: 8px;
        }
        
        .data-table tr:last-child td:first-child {
            border-bottom-left-radius: 8px;
        }
        
        .data-table tr:last-child td:last-child {
            border-bottom-right-radius: 8px;
        }

        /* Modern Settings Panel Styles */
        .settings-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            box-shadow: 0 20px 25px -5px var(--shadow), 0 10px 10px -5px var(--shadow);
        }

        .settings-tab {
            padding: 0.75rem 1.5rem;
            border-bottom: 2px solid transparent;
            color: var(--text-tertiary);
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .settings-tab:hover {
            color: var(--text-secondary);
            background-color: var(--bg-secondary);
        }

        .settings-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            background-color: var(--bg-secondary);
        }

        .settings-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .settings-section h3 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .settings-section p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .form-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-secondary);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }



        .confidence-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Modern Range Slider Styles */
        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            outline: none;
            transition: all 0.2s ease;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .range-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
        }

        .confidence-range-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .confidence-range-container:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            min-width: 80px;
            justify-content: center;
        }

        .confidence-preview {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            border: 1px solid var(--border-primary);
        }

        .range-value-display {
            background: var(--accent-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            min-width: 50px;
            text-align: center;
        }

        .confidence-col.collapsed {
            display: none;
        }

        th.confidence-col.collapsed {
            display: table-cell !important; /* Override to keep header visible */
            width: 60px; /* Shrink the header width */
        }

        th.confidence-col.collapsed > div > span {
            display: none; /* Hide only the text in the header */
        }

        #confidenceChevron {
            transition: transform 0.2s ease-in-out;
        }
        
        #confidenceChevron.collapsed {
            transform: rotate(-90deg);
        }

        /* Compact Mode Styles */
        body.compact-mode .container {
            padding: 1rem !important;
        }
        
        body.compact-mode .settings-section {
            padding: 1rem !important;
            margin-bottom: 1rem !important;
        }
        
        body.compact-mode .space-y-4 > * + * {
            margin-top: 0.75rem !important;
        }
        
        body.compact-mode .mb-8 {
            margin-bottom: 1.5rem !important;
        }

        /* Dark mode specific overrides */
        [data-theme="dark"] .bg-gray-100 {
            background-color: var(--bg-tertiary) !important;
        }
        
        [data-theme="dark"] .border-gray-200 {
            border-color: var(--border-primary) !important;
        }
        
        [data-theme="dark"] .text-gray-900 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .text-gray-700 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .text-gray-600 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .text-gray-500 {
            color: var(--text-tertiary) !important;
        }

        /* Dark mode form inputs */
        [data-theme="dark"] .form-input {
            background: var(--bg-tertiary) !important;
            border-color: var(--border-secondary) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode select elements */
        [data-theme="dark"] select {
            background: var(--bg-tertiary) !important;
            border-color: var(--border-secondary) !important;
            color: var(--text-primary) !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
            <header class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <img id="vectorLogo" src="https://cdn-eblmdf.nitrocdn.com/vVuBUVEtyJTDzFmiTWcmAlTgwfLlYdtZ/assets/images/optimized/rev-d91b495/www.withvector.com/wp-content/uploads/2024/09/vector-logo.png" alt="Vector Logo" style="height:38px; width:auto;" class="rounded-lg shadow-sm hover:scale-105 transition-transform duration-200 cursor-pointer" />
                    <button id="settingsBtn" class="p-2 rounded-full bg-orange-500 hover:bg-orange-600 text-white shadow-lg transition-all duration-200 hover:scale-105" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                        </svg>
                    </button>
                </div>
                <div class="text-center">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 font-google-sans">Document Intelligence</h1>
                    <p class="mt-2 text-gray-600">Upload a document, and our AI will extract key details into a structured format.</p>
                </div>
            </header>

            <div id="aiConfigSection" class="settings-panel rounded-xl p-6 mb-8 hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-900 mb-2">Settings</h1>
                    <p class="text-gray-600">Manage your account settings and preferences.</p>
                </div>

                <!-- Settings Navigation Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-8" aria-label="Settings Tabs">
                        <button id="settingsTabGeneral" class="settings-tab active">General</button>
                        <button id="settingsTabAI" class="settings-tab">AI Models</button>
                        <button id="settingsTabConfidence" class="settings-tab">Confidence</button>
                        <button id="settingsTabAppearance" class="settings-tab">Appearance</button>
                    </nav>
                </div>

                <!-- General Settings Tab -->
                <div id="settingsContentGeneral" class="settings-content">
                    <div class="settings-section">
                        <h3>Application Preferences</h3>
                        <p>Configure general application behavior and preferences.</p>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                 <div>
                                    <label class="text-sm font-medium text-gray-700">Auto-save results</label>
                                    <p class="text-xs text-gray-500">Automatically save parsed results to local storage</p>
                    </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoSaveToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Show coordinate overlays</label>
                                    <p class="text-xs text-gray-500">Display red rectangles when hovering over extracted fields</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="coordinateOverlaysToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Models Settings Tab -->
                <div id="settingsContentAI" class="settings-content hidden">
                    <div class="settings-section">
                        <h3>AI Model Configuration</h3>
                        <p>Choose your preferred AI model and configure API access for document parsing.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="modelSelector" class="block text-sm font-medium text-gray-700 mb-2">Selected AI Model</label>
                                <select id="modelSelector" class="form-input w-full">
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                                    <option value="gemini-2.5-pro" selected>Gemini 2.5 Pro (Recommended)</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gpt-4o">OpenAI GPT-4o</option>
                        <option value="claude-4">Claude 4</option>
                    </select>
                </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Use custom parsing prompt</label>
                                    <p class="text-xs text-gray-500">Customize the AI instructions for document parsing</p>
                    </div>
                                <button id="editBolPromptBtn" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium">
                                    Edit Prompt
                                </button>
                </div>
                    </div>
                    </div>

                    <div id="googleKeyContainer" class="settings-section">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3>Google AI API Key</h3>
                                <p class="text-xs text-gray-500 mt-1">Required for Gemini models</p>
                            </div>
                            <button id="howToBtn" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg hover:bg-green-200 transition-colors text-sm font-medium">
                                Get Key
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <input type="password" id="googleApiKeyInput" placeholder="Enter your Google AI API Key" class="form-input w-full">
                        </div>
                    </div>

                    <div id="openaiKeyContainer" class="settings-section hidden">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3>OpenAI API Key</h3>
                                <p class="text-xs text-gray-500 mt-1">Required for GPT and Claude models</p>
                            </div>
                            <button id="howToBtnOpenAI" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg hover:bg-green-200 transition-colors text-sm font-medium">
                                Get Key
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <input type="password" id="openaiApiKeyInput" placeholder="Enter your OpenAI API Key" class="form-input w-full">
                        </div>
                    </div>
                </div>

                <!-- Confidence Settings Tab -->
                <div id="settingsContentConfidence" class="settings-content hidden">
                    <div class="settings-section">
                        <h3>Confidence Level Settings</h3>
                        <p>Adjust confidence thresholds to control how extracted data accuracy is displayed.</p>
                        
                        <!-- High Confidence Setting -->
                        <div class="confidence-range-container">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="confidence-color bg-green-500"></div>
                                    <div>
                                        <label for="highConfidenceSlider" class="text-sm font-medium text-gray-700">High Confidence</label>
                                        <p class="text-xs text-gray-500">Fields with excellent extraction accuracy</p>
                                    </div>
                                </div>
                                <div class="range-value-display" id="highValueDisplay">95%</div>
                            </div>
                            <div class="mt-3">
                                <input type="range" id="highConfidenceSlider" min="85" max="100" value="95" class="range-slider">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>85%</span>
                                    <span>Perfect (100%)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Medium Confidence Setting -->
                        <div class="confidence-range-container">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="confidence-color bg-orange-500"></div>
                                    <div>
                                        <label for="mediumConfidenceSlider" class="text-sm font-medium text-gray-700">Medium Confidence</label>
                                        <p class="text-xs text-gray-500">Fields with good extraction accuracy</p>
                                    </div>
                                </div>
                                <div class="range-value-display" id="mediumValueDisplay">80%</div>
                            </div>
                            <div class="mt-3">
                                <input type="range" id="mediumConfidenceSlider" min="60" max="94" value="80" class="range-slider">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>60%</span>
                                    <span>94%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Low Confidence Info -->
                        <div class="confidence-range-container">
                            <div class="flex items-center gap-3">
                                <div class="confidence-color bg-red-500"></div>
                                <div class="flex-1">
                                    <label class="text-sm font-medium text-gray-700">Low Confidence</label>
                                    <p class="text-xs text-gray-500">Fields below medium threshold - requires manual review</p>
                                </div>
                                <div class="confidence-badge bg-red-500">
                                    <span id="lowRangeDisplay">&lt; 80%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Live Preview -->
                        <div class="mt-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Preview</h4>
                            <div class="confidence-preview">
                                <div class="preview-item">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                    <span>High: <span id="previewHigh">95%+</span></span>
                                </div>
                                <div class="preview-item">
                                    <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                                    <span>Medium: <span id="previewMedium">80%-94%</span></span>
                                </div>
                                <div class="preview-item">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <span>Low: <span id="previewLow">&lt;80%</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Show confidence indicators</label>
                                    <p class="text-xs text-gray-500">Display colored dots next to extracted fields</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="showConfidenceIndicators" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-between items-center">
                            <button id="resetConfidenceDefaults" class="text-sm text-gray-600 hover:text-gray-800 transition-colors">
                                Reset to Defaults
                            </button>
                            <button id="saveConfidenceSettings" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Appearance Settings Tab -->
                <div id="settingsContentAppearance" class="settings-content hidden">
                    <div class="settings-section">
                        <h3>Theme Preferences</h3>
                        <p>Customize the appearance of the application.</p>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Dark Mode</label>
                                    <p class="text-xs text-gray-500">Switch between light and dark themes</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="darkModeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Compact Mode</label>
                                    <p class="text-xs text-gray-500">Reduce spacing for more content on screen</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="compactModeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="bolContent">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-lg font-medium text-gray-700 font-google-sans">Upload Document (PDF)</label>
                </div>
                 <label for="bolUpload" class="flex flex-col items-center justify-center w-full min-h-[16rem] border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition p-4">
                     <div id="bol-prompt-text" class="flex flex-col items-center justify-center text-center">
                         <svg class="w-10 h-10 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                         <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload a PDF</span></p>
                         <p id="pdfFileName" class="text-sm text-green-600 font-semibold mt-2"></p>
                     </div>
                     <div id="bol-preview-container" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                     <input id="bolUpload" type="file" class="hidden" accept="application/pdf" />
                 </label>
                <div class="text-center mt-8 mb-8">
                    <button id="parseBolBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">Analyze Document</button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="loading" class="text-center my-4 hidden px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-2xl mx-auto">
            <div class="flex items-center justify-center mb-2">
                <span id="progressLabel" class="text-xl font-semibold text-blue-600">Loading...</span>
            </div>
            <div class="w-full bg-blue-100 rounded-full h-6 relative overflow-hidden">
                <div id="progressBar" class="h-6 bg-blue-500 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
            </div>
        </div>
    </div>
    <div id="messageContainer" class="hidden px-4 sm:px-6 lg:px-8">
         <div id="message" class="text-red-600 font-medium"></div>
    </div>
    
    <div id="resultsWrapper" class="hidden">
         <div id="bolResultContainer" class="hidden mt-6 px-4 sm:px-6 lg:px-8">
             <div class="flex justify-between items-center mb-6 py-4 border-b border-gray-200">
                 <h2 class="text-xl font-semibold text-gray-800">Extracted Details</h2>
                 <div class="flex items-center gap-3">
                     <button id="rawResultsBtn" class="text-gray-700 font-medium py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors bg-white">
                        Raw Results
                     </button>
                     <button id="printBolBtn" class="text-gray-700 font-medium py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors bg-white">
                         Print Results
                     </button>
                     <button id="exportBolBtn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                         Export Data
                     </button>
                 </div>
             </div>
            <div id="bolResultCard" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                </div>
        </div>
    </div>

    <div id="sidePanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="sidePanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-google-sans font-bold">API Key Help</h2>
                <button id="closePanelBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
             <div class="border-b border-gray-200">
                <nav class="flex" aria-label="Side Panel Tabs">
                    <button id="panelTabKey" class="side-panel-tab active flex-1 border-b-2 py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Get API Key</button>
                    <button id="panelTabBilling" class="side-panel-tab flex-1 border-b-2 border-transparent py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Enable Billing</button>
                </nav>
            </div>
            <div id="panelContentKey" class="p-6 overflow-y-auto flex-grow">
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google AI Studio</h3>
                        <p class="mb-3 text-sm">Navigate to <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com</a> and sign in with your Google account.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-1.png" alt="Google AI Studio Homepage" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Get API Key</h3>
                        <p class="mb-3 text-sm">Once in AI Studio, click <b>"Get API key"</b> from the left-hand menu.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-2.png" alt="Get API Key button" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Create API key in a new project</h3>
                        <p class="mb-3 text-sm">A dialog will appear. Click on <b>"Create API key in new project"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-3.png" alt="Create API Key in new project" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Copy Your Key</h3>
                        <p class="mb-3 text-sm">Your new API key will be displayed. Click the copy icon to copy the key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-4.png" alt="Copy new API key" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 5: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "Google AI API Key" input field.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-5.png" alt="Paste key into the application" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            </div>
            <div id="panelContentBilling" class="p-6 overflow-y-auto flex-grow hidden">
                 <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google Cloud Console</h3>
                        <p class="mb-3 text-sm">Navigate to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a> and select the project associated with your API key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-1.png" alt="Google Cloud Console" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Open Billing Menu</h3>
                        <p class="mb-3 text-sm">Click the main navigation menu (hamburger icon) and select <b>"Billing"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-2.png" alt="Billing Menu" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Link a Billing Account</h3>
                        <p class="mb-3 text-sm">If your project doesn't have a billing account, you'll see a prompt to <b>"Link a billing account"</b>. Click it. If you need to create one, select <b>"Manage billing accounts"</b> and then <b>"Create account"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-3.png" alt="Link billing account" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Set Up Payment</h3>
                        <p class="mb-3 text-sm">Follow the on-screen instructions to provide your payment information and complete the setup.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-4.png" alt="Payment information" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="promptSidePanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="promptSidePanel" class="fixed top-0 right-0 h-full w-full max-w-lg bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-google-sans font-bold">Edit Prompt</h2>
                <button id="closePromptPanelBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
            <div id="promptPanelContentBol" class="p-6 overflow-y-auto flex-grow flex flex-col">
                <label for="bolPromptTextarea" class="font-semibold mb-2">Document Prompt</label>
                <textarea id="bolPromptTextarea" class="w-full flex-grow p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"></textarea>
                 <div class="mt-4 flex gap-4">
                     <button id="saveBolPromptBtn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Save</button>
                     <button id="resetBolPromptBtn" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Reset to Default</button>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="imageZoomModal" class="hidden fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-[100] p-4">
        <button id="closeZoomModal" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
        <button id="zoomPrevBtn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
        <img id="zoomedImage" src="" class="max-w-full max-h-full">
         <button id="zoomNextBtn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
    </div>

    <div id="fieldEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[100]">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="editModalTitle" class="text-lg font-bold mb-4">Edit Field</h3>
            <div id="editModalContent">
                </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancelEditBtn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button id="saveEditBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <div id="rawJsonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[100]">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
            <h3 class="text-lg font-bold mb-4">Raw JSON Output</h3>
            <pre id="rawJsonContent" class="bg-gray-100 p-4 rounded-md overflow-x-auto text-sm" style="max-height: 60vh;"></pre>
            <div class="mt-6 flex justify-end gap-4">
                <button id="closeRawJsonBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        // DOM Elements
        const modelSelector = document.getElementById('modelSelector');
        const googleKeyContainer = document.getElementById('googleKeyContainer');
        const openaiKeyContainer = document.getElementById('openaiKeyContainer');
        const googleApiKeyInput = document.getElementById('googleApiKeyInput');
        const openaiApiKeyInput = document.getElementById('openaiApiKeyInput');
        const loading = document.getElementById('loading');
        const messageContainer = document.getElementById('messageContainer');
        const message = document.getElementById('message');
        const resultsWrapper = document.getElementById('resultsWrapper');
        
        // Settings Elements
        const settingsBtn = document.getElementById('settingsBtn');
        const aiConfigSectionElement = document.getElementById('aiConfigSection');
        const highConfidenceThreshold = document.getElementById('highConfidenceSlider');
        const mediumConfidenceThreshold = document.getElementById('mediumConfidenceSlider');
        const saveConfidenceSettings = document.getElementById('saveConfidenceSettings');
        const resetConfidenceDefaults = document.getElementById('resetConfidenceDefaults');
        
        // Settings Tab Elements
        const settingsTabGeneral = document.getElementById('settingsTabGeneral');
        const settingsTabAI = document.getElementById('settingsTabAI');
        const settingsTabConfidence = document.getElementById('settingsTabConfidence');
        const settingsTabAppearance = document.getElementById('settingsTabAppearance');
        const settingsContentGeneral = document.getElementById('settingsContentGeneral');
        const settingsContentAI = document.getElementById('settingsContentAI');
        const settingsContentConfidence = document.getElementById('settingsContentConfidence');
        const settingsContentAppearance = document.getElementById('settingsContentAppearance');
        
        // Theme and Preference Elements
        const darkModeToggle = document.getElementById('darkModeToggle');
        const compactModeToggle = document.getElementById('compactModeToggle');
        const autoSaveToggle = document.getElementById('autoSaveToggle');
        const coordinateOverlaysToggle = document.getElementById('coordinateOverlaysToggle');
        const showConfidenceIndicators = document.getElementById('showConfidenceIndicators');
        // Confidence Settings
        let confidenceSettings = {
            high: 95,
            medium: 80
        };
        
        // Load saved settings
        const savedSettings = localStorage.getItem('confidenceSettings');
        if (savedSettings) {
            confidenceSettings = JSON.parse(savedSettings);
            if (highConfidenceThreshold) highConfidenceThreshold.value = confidenceSettings.high;
            if (mediumConfidenceThreshold) mediumConfidenceThreshold.value = confidenceSettings.medium;
        }
        
        // Load theme and preference settings
        const savedTheme = localStorage.getItem('theme') || 'light';
        const savedCompactMode = localStorage.getItem('compactMode') === 'true';
        const savedAutoSave = localStorage.getItem('autoSave') === 'true';
        const savedCoordinateOverlays = localStorage.getItem('coordinateOverlays') !== 'false'; // default true
        const savedShowConfidenceIndicators = localStorage.getItem('showConfidenceIndicators') !== 'false'; // default true
        
        // Apply saved settings
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            if (darkModeToggle) darkModeToggle.checked = true;
        }
        if (savedCompactMode) {
            document.body.classList.add('compact-mode');
            if (compactModeToggle) compactModeToggle.checked = true;
        }
        if (savedAutoSave && autoSaveToggle) autoSaveToggle.checked = true;
        if (coordinateOverlaysToggle) coordinateOverlaysToggle.checked = savedCoordinateOverlays;
        if (showConfidenceIndicators) showConfidenceIndicators.checked = savedShowConfidenceIndicators;
        
        // BoL Elements
        const bolUpload = document.getElementById('bolUpload');
        const bolPromptText = document.getElementById('bol-prompt-text');
        const pdfFileNameDisplay = document.getElementById('pdfFileName');
        const bolPreviewContainer = document.getElementById('bol-preview-container');
        const parseBolBtn = document.getElementById('parseBolBtn');
        const bolResultContainer = document.getElementById('bolResultContainer');
        const exportBolBtn = document.getElementById('exportBolBtn');
        const bolResultCard = document.getElementById('bolResultCard');

        // Modal Elements
        const imageZoomModal = document.getElementById('imageZoomModal');
        const zoomedImage = document.getElementById('zoomedImage');
        const closeZoomModal = document.getElementById('closeZoomModal');
        const zoomPrevBtn = document.getElementById('zoomPrevBtn');
        const zoomNextBtn = document.getElementById('zoomNextBtn');
        const fieldEditModal = document.getElementById('fieldEditModal');
        const editModalTitle = document.getElementById('editModalTitle');
        const editModalContent = document.getElementById('editModalContent');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');

        // Side Panel Elements
        const howToBtn = document.getElementById('howToBtn');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const panelTabKey = document.getElementById('panelTabKey');
        const panelTabBilling = document.getElementById('panelTabBilling');
        const panelContentKey = document.getElementById('panelContentKey');
        const panelContentBilling = document.getElementById('panelContentBilling');
        
        // Prompt Panel Elements
        const editBolPromptBtn = document.getElementById('editBolPromptBtn');
        const promptSidePanelOverlay = document.getElementById('promptSidePanelOverlay');
        const promptSidePanel = document.getElementById('promptSidePanel');
        const closePromptPanelBtn = document.getElementById('closePromptPanelBtn');
        const promptPanelContentBol = document.getElementById('promptPanelContentBol');
        const bolPromptTextarea = document.getElementById('bolPromptTextarea');
        const saveBolPromptBtn = document.getElementById('saveBolPromptBtn');
        const resetBolPromptBtn = document.getElementById('resetBolPromptBtn');
        
        let bolFile = null;
        let bolPageImages = [];
        let currentBolPageIndex = 0;
        let rawJsonResult = '';

        const defaultBolPrompt = `You are an expert at parsing shipping documents. Your task is to analyze all the following pages from a single Bill of Lading (BoL) and consolidate all information into a single JSON object.
Aggregate the data from all provided pages to find the most complete information for each field. Scrutinize every page for line items under tables like "Shipping Details" to create a comprehensive list of all unique items.

Extract the following fields and return them in one JSON object. If a field is not present across any of the pages, use "N/A" as the value.

For EACH field, you must provide:
1. The extracted value
2. Bounding box coordinates in PIXELS from the image provided. The image origin (0,0) is at the TOP-LEFT.
3. Confidence score (0-100) representing how certain you are about the accuracy of the extracted value

Use this format: {"value": "extracted_text", "coordinates": {"page": 1, "x": 150, "y": 300, "width": 225, "height": 30}, "confidence": 95}. The coordinates are in pixels of the image for that page.

COORDINATE SYSTEM: Use standard image coordinates where:
- Origin (0,0) is at the TOP-LEFT of the page
- X increases going RIGHT
- Y increases going DOWN
- Measure coordinates precisely from the visible text location

- "order_number": The order, appointment, or pickup number.
- "seal_number": The seal number for the trailer.
- "date": The pickup or shipping date.
- "carrier": The name of the carrier.
- "origin": The full address of the shipper/origin.
- "destination": The full address of the consignee/destination.
- "signed": Whether the BoL shows evidence of being signed by the driver (look for signatures, signature lines that are filled, or "Signature" fields with names/marks). Return true/false.
- "contents": An array of objects, where each object represents a unique line item found across all pages. Each object should contain:
    - "item_number": The item or SKU number for the product (if available).
    - "description": The description of the goods.
    - "amount": The total quantity or number of units (e.g., pallets, cases).
    - "weight": The total weight of the items.
    - "use_by_date": The use by, best by, or expiration date for the item (if available).
- "scac": The Standard Carrier Alpha Code (a 2-4 letter code).
- "delivery_number": The delivery or pro number.
- "bol_number": The primary Bill of Lading number.
- "shipment_number": The shipment ID or number.
- "temperature": The required transit temperature (e.g., 34-40°F).
- "customer": The name of the receiving company (the consignee, distinct from the destination address).
- "vendor": The name of the shipping company (the shipper, distinct from the origin address).

For fields where coordinates cannot be determined, use {"page": 0, "x": 0, "y": 0, "width": 0, "height": 0} and confidence: 0.

Return the JSON in this exact structure:
{
  "order_number": {"value": "...", "coordinates": {...}, "confidence": 95},
  "seal_number": {"value": "...", "coordinates": {...}, "confidence": 85},
  "date": {"value": "...", "coordinates": {...}, "confidence": 90},
  "carrier": {"value": "...", "coordinates": {...}, "confidence": 88},
  "origin": {"value": "...", "coordinates": {...}, "confidence": 92},
  "destination": {"value": "...", "coordinates": {...}, "confidence": 91},
  "customer": {"value": "...", "coordinates": {...}, "confidence": 90},
  "vendor": {"value": "...", "coordinates": {...}, "confidence": 90},
  "signed": {"value": true/false, "coordinates": {...}, "confidence": 75},
  "scac": {"value": "...", "coordinates": {...}, "confidence": 80},
  "delivery_number": {"value": "...", "coordinates": {...}, "confidence": 87},
  "bol_number": {"value": "...", "coordinates": {...}, "confidence": 98},
  "shipment_number": {"value": "...", "coordinates": {...}, "confidence": 89},
  "temperature": {"value": "...", "coordinates": {...}, "confidence": 70},
  "contents": [
    {
      "item_number": {"value": "...", "coordinates": {...}, "confidence": 85},
      "description": {"value": "...", "coordinates": {...}, "confidence": 90},
      "amount": {"value": "...", "coordinates": {...}, "confidence": 88},
      "weight": {"value": "...", "coordinates": {...}, "confidence": 82},
      "use_by_date": {"value": "...", "coordinates": {...}, "confidence": 75}
    }
  ]
}

Only output the final, consolidated JSON object. Do not include any other text, explanations, or markdown formatting.`;

        const defaultGoogleApiKey = "AIzaSyDe0pVIFyKI_SiTpVMlpbt1Gtdg3uF9WbU";
        googleApiKeyInput.value = defaultGoogleApiKey;

        bolPromptTextarea.value = defaultBolPrompt;

        // --- Dynamic API Key Help Content ---
        const keyHelpContent = {
            gemini: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google AI Studio</h3>
                        <p class="mb-3 text-sm">Navigate to <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com</a> and sign in with your Google account.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-1.png" alt="Google AI Studio Homepage" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Get API Key</h3>
                        <p class="mb-3 text-sm">Once in AI Studio, click <b>"Get API key"</b> from the left-hand menu.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-2.png" alt="Get API Key button" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Create API key in a new project</h3>
                        <p class="mb-3 text-sm">A dialog will appear. Click on <b>"Create API key in new project"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-3.png" alt="Create API Key in new project" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Copy Your Key</h3>
                        <p class="mb-3 text-sm">Your new API key will be displayed. Click the copy icon to copy the key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-4.png" alt="Copy new API key" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 5: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "Google AI API Key" input field.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-5.png" alt="Paste key into the application" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            `,
            gpt: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to OpenAI Platform</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">platform.openai.com/api-keys</a> and sign in with your OpenAI account.</p>
                        <img src="https://platform.openai.com/static/images/api-keys.png" alt="OpenAI API Keys" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Create a New API Key</h3>
                        <p class="mb-3 text-sm">Click <b>"Create new secret key"</b>. Name your key and copy it. <b>Store it securely</b> as you won't be able to see it again.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "OpenAI API Key" input field.</p>
                    </div>
                </div>
            `,
            claude: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Anthropic Console</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://console.anthropic.com/account/keys" target="_blank" class="text-blue-600 hover:underline">console.anthropic.com/account/keys</a> and sign in or create an Anthropic account.</p>
                        <img src="https://placehold.co/600x300/e2e8f0/334155?text=Anthropic+Console" alt="Anthropic Console" class="rounded-lg border shadow-sm">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Create an API Key</h3>
                        <p class="mb-3 text-sm">Click <b>"Create Key"</b>, give it a name, and copy the key. <b>Store it securely</b> as you won't be able to see it again.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "OpenAI API Key" input field (used for Claude as well).</p>
                    </div>
                </div>
            `
        };

        const billingHelpContent = {
            gemini: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google Cloud Console</h3>
                        <p class="mb-3 text-sm">Navigate to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a> and select the project associated with your API key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-1.png" alt="Google Cloud Console" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Open Billing Menu</h3>
                        <p class="mb-3 text-sm">Click the main navigation menu (hamburger icon) and select <b>"Billing"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-2.png" alt="Billing Menu" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Link a Billing Account</h3>
                        <p class="mb-3 text-sm">If your project doesn't have a billing account, you'll see a prompt to <b>"Link a billing account"</b>. Click it. If you need to create one, select <b>"Manage billing accounts"</b> and then <b>"Create account"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-3.png" alt="Link billing account" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Set Up Payment</h3>
                        <p class="mb-3 text-sm">Follow the on-screen instructions to provide your payment information and complete the setup.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-4.png" alt="Payment information" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            `,
            gpt: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to OpenAI Billing</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://platform.openai.com/account/billing/overview" target="_blank" class="text-blue-600 hover:underline">platform.openai.com/account/billing/overview</a> and sign in.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Add a Payment Method</h3>
                        <p class="mb-3 text-sm">Click <b>"Add payment method"</b> and follow the instructions to add your credit card or other payment method.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Set Usage Limits (Optional)</h3>
                        <p class="mb-3 text-sm">You can set usage limits to control your spending in the <b>"Usage limits"</b> tab.</p>
                    </div>
                </div>
            `,
            claude: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Anthropic Console Billing</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://console.anthropic.com/account/billing" target="_blank" class="text-blue-600 hover:underline">console.anthropic.com/account/billing</a> and sign in.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Add a Payment Method</h3>
                        <p class="mb-3 text-sm">Click <b>"Add payment method"</b> and follow the instructions to add your credit card or other payment method.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Review Usage and Limits</h3>
                        <p class="mb-3 text-sm">Monitor your usage and set limits as needed to control your spending.</p>
                    </div>
                </div>
            `
        };

        function getCurrentProvider() {
            const val = modelSelector.value;
            if (val.startsWith('gemini')) return 'gemini';
            if (val.startsWith('gpt')) return 'gpt';
            if (val.startsWith('claude')) return 'claude';
            return 'gemini'; // fallback
        }

        function updateKeyHelpPanel() {
            const provider = getCurrentProvider();
            panelContentKey.innerHTML = keyHelpContent[provider];
            panelContentBilling.innerHTML = billingHelpContent[provider];
        }

        modelSelector.addEventListener('input', () => {
            const isGpt = modelSelector.value.startsWith('gpt');
            const isClaude = modelSelector.value.startsWith('claude');
            googleKeyContainer.classList.toggle('hidden', isGpt || isClaude);
            openaiKeyContainer.classList.toggle('hidden', !(isGpt || isClaude));
            checkAllInputs();
            updateKeyHelpPanel();
        });

        googleApiKeyInput.addEventListener('input', checkAllInputs);
        openaiApiKeyInput.addEventListener('input', checkAllInputs);

        bolUpload.addEventListener('change', async (event) => {
            if (event.target.files.length === 0) return;
            bolFile = event.target.files[0];
            pdfFileNameDisplay.textContent = bolFile.name;
            bolPromptText.classList.add('hidden');
            
            // Immediately enable the button if key is present
            checkAllInputs(); 

            bolPreviewContainer.innerHTML = '<div class="text-center col-span-full">Rendering PDF...</div>';

            try {
                bolPageImages = await renderPdfToImages(bolFile);
                bolPreviewContainer.innerHTML = '';
                bolPageImages.forEach(imgDataUrl => {
                    const img = document.createElement('img');
                    img.src = imgDataUrl;
                    img.className = 'w-full h-auto object-cover rounded-lg border shadow-sm';
                    img.alt = 'Bill of Lading Page';
                    img.addEventListener('click', () => openImageZoomModal());
                    bolPreviewContainer.appendChild(img);
                });
            } catch (error) {
                displayMessage(`Error rendering PDF: ${error.message}`);
                bolPreviewContainer.innerHTML = '';
                bolPromptText.classList.remove('hidden');
                pdfFileNameDisplay.textContent = '';
                bolFile = null; // Reset the file on failure
                bolPageImages = []; // Reset images
                checkAllInputs(); // Disable button on failure
            }
        });
        
        parseBolBtn.addEventListener('click', handleBolParsing);
        exportBolBtn.addEventListener('click', handleExportBolData);

        howToBtn.addEventListener('click', () => {
            updateKeyHelpPanel();
            sidePanel.classList.remove('translate-x-full');
            sidePanelOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });

        const closePanel = () => {
            sidePanel.classList.add('translate-x-full');
            sidePanelOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        };
        closePanelBtn.addEventListener('click', closePanel);
        sidePanelOverlay.addEventListener('click', closePanel);
        
        // Prompt Panel Listeners
        editBolPromptBtn.addEventListener('click', () => openPromptPanel());

        const openPromptPanel = () => {
            promptSidePanel.classList.remove('translate-x-full');
            promptSidePanelOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        
        const closePromptPanel = () => {
            promptSidePanel.classList.add('translate-x-full');
            promptSidePanelOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        };

        closePromptPanelBtn.addEventListener('click', closePromptPanel);
        promptSidePanelOverlay.addEventListener('click', closePromptPanel);
        saveBolPromptBtn.addEventListener('click', closePromptPanel);
        resetBolPromptBtn.addEventListener('click', () => { bolPromptTextarea.value = defaultBolPrompt; });

        // Side Panel Tab switching
        panelTabKey.addEventListener('click', () => switchSidePanelTab('key'));
        panelTabBilling.addEventListener('click', () => switchSidePanelTab('billing'));
        
        // Modal Listeners
        closeZoomModal.addEventListener('click', () => {
            imageZoomModal.classList.add('hidden');
            imageZoomModal.classList.remove('flex');
        });
        imageZoomModal.addEventListener('click', (e) => {
             if (e.target === imageZoomModal) {
                imageZoomModal.classList.add('hidden');
                imageZoomModal.classList.remove('flex');
            }
        });

        cancelEditBtn.addEventListener('click', () => {
             fieldEditModal.classList.add('hidden');
             fieldEditModal.classList.remove('flex');
        });
        saveEditBtn.addEventListener('click', () => {
            try {
                const fieldId = saveEditBtn.dataset.fieldId;
                const input = document.getElementById('edit-input');
                const targetSpan = document.querySelector(`[data-field-id="${fieldId}"]`);
                if (targetSpan && input) {
                    targetSpan.textContent = input.value || 'N/A';
                }
            } catch(error) {
                console.error("Error saving field:", error);
            } finally {
                fieldEditModal.classList.add('hidden');
                fieldEditModal.classList.remove('flex');
            }
        });
        fieldEditModal.addEventListener('click', (e) => {
             if (e.target === fieldEditModal) {
                fieldEditModal.classList.add('hidden');
                fieldEditModal.classList.remove('flex');
            }
        });

        const printBolBtn = document.getElementById('printBolBtn');
        if (printBolBtn) {
            printBolBtn.addEventListener('click', () => {
                const printContents = bolResultCard.cloneNode(true);

                // --- Modify content for printing ---
                
                // 1. Remove image carousel
                const carousel = printContents.querySelector('#mainCarouselContainer');
                if (carousel) carousel.remove();

                // 2. Remove all buttons (add/remove row, etc.)
                printContents.querySelectorAll('button').forEach(btn => btn.remove());

                // 3. Remove Confidence column from the main details table
                const mainTable = printContents.querySelector('.lg\\:col-span-3 .data-table');
                if (mainTable) {
                    const header = mainTable.querySelector('thead tr');
                    if(header && header.children[2]) header.children[2].remove(); // Remove 3rd TH
                    
                    mainTable.querySelectorAll('tbody tr').forEach(row => {
                        if(row.children[2]) row.children[2].remove(); // Remove 3rd TD
                    });
                }
                
                // 4. Remove Actions column from Contents table
                const contentsTable = printContents.querySelector('#contentsTable');
                if (contentsTable) {
                    const contentHeader = contentsTable.querySelector('thead tr');
                    if(contentHeader && contentHeader.lastElementChild) contentHeader.lastElementChild.remove();
                    
                    contentsTable.querySelectorAll('tbody tr').forEach(row => {
                         if(row.lastElementChild) row.lastElementChild.remove();
                    });
                }

                // 5. Style the 'Contents' label as a proper heading
                const contentsLabel = printContents.querySelector('label.block');
                if (contentsLabel && contentsLabel.textContent === 'Contents') {
                    const newHeading = document.createElement('h3');
                    newHeading.textContent = 'Contents';
                    contentsLabel.replaceWith(newHeading);
                }

                // --- Create print-friendly window ---

                const printWindow = window.open('', '', 'width=900,height=700');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Print Document Analysis</title>
                        <style>
                            @page {
                                size: A4 portrait;
                                margin: 0.75in;
                            }
                            body { 
                                font-family: 'Inter', sans-serif; 
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                            }
                            h2, h3 { 
                                font-family: 'Roboto', sans-serif;
                                font-weight: 600;
                                margin-top: 0;
                                margin-bottom: 1.5rem;
                                color: #111;
                            }
                            h2 { font-size: 22pt; }
                            h3 { font-size: 14pt; margin-top: 2rem; }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                font-size: 9pt; 
                                page-break-inside: avoid;
                            }
                            th, td { 
                                border: 1px solid #999; 
                                padding: 0.5rem; 
                                text-align: left;
                                vertical-align: top;
                            }
                            th { 
                                background-color: #f2f2f2 !important;
                                font-weight: 600;
                            }
                            /* The 'about:blank' footer is a browser setting. This stylesheet provides a clean layout for printing. */
                        </style>
                    </head>
                    <body>
                        <h2>Extracted Details</h2>
                        ${printContents.innerHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { 
                    printWindow.print(); 
                    printWindow.close(); 
                }, 500);
            });
        }

        // --- Core Functions ---
        
        function switchSidePanelTab(tabName) {
            if (tabName === 'key') {
                panelTabKey.classList.add('active');
                panelTabBilling.classList.remove('active');
                panelContentKey.classList.remove('hidden');
                panelContentBilling.classList.add('hidden');
            } else {
                panelTabKey.classList.remove('active');
                panelTabBilling.classList.add('active');
                panelContentKey.classList.add('hidden');
                panelContentBilling.classList.remove('hidden');
            }
        }
        
        function hasApiKey() {
            const model = modelSelector.value;
            const googleKey = googleApiKeyInput.value.trim();
            const openaiKey = openaiApiKeyInput.value.trim();
            return (model.startsWith('gpt') || model.startsWith('claude')) ? !!openaiKey : !!googleKey;
        }

        function checkAllInputs() {
            const hasKey = hasApiKey();
            parseBolBtn.disabled = !(hasKey && bolFile);
        }

        // Remove spinner loader references and add progress bar logic
        // --- Progress Bar Logic ---
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');

        let progressInterval = null;
        let messageRotationInterval = null;
        let currentMessageIndex = 0;
        let currentProgress = 0;

        const progressMessages = [
            "Ingesting BoL PDF",
            "Parsing documents", 
            "Organizing content", 
            "Finalizing output"
        ];

        function setProgress(targetProgress, message = null) {
            // Update progress bar width
            currentProgress = targetProgress;
            progressBar.style.width = currentProgress + '%';
            
            // Update message if provided
            if (message) {
                progressLabel.innerHTML = message + '<span class="animated-dots"></span>';
            }
        }

        function startMessageRotation() {
            // Clear any existing rotation
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
            }
            
            // Start rotating messages
            messageRotationInterval = setInterval(() => {
                const message = progressMessages[currentMessageIndex];
                progressLabel.innerHTML = message + '<span class="animated-dots"></span>';
                currentMessageIndex = (currentMessageIndex + 1) % progressMessages.length;
            }, 2000); // Change message every 2 seconds
        }

        function stopMessageRotation() {
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
                messageRotationInterval = null;
            }
        }

        function startContinuousProgress() {
            // Start a background progress that slowly increments
            const backgroundInterval = setInterval(() => {
                if (currentProgress < 95) { // Don't go above 95% until explicitly set to 100%
                    currentProgress += 0.5;
                    progressBar.style.width = currentProgress + '%';
                }
            }, 100); // Update every 100ms for smooth background progress
            
            return backgroundInterval;
        }

        // --- Update handleBolParsing and PDF rendering to use progress bar ---
        async function handleBolParsing() {
            resetUI();
            document.getElementById('bolContent').classList.add('hidden');
            loading.classList.remove('hidden');
            currentProgress = 0;
            setProgress(0, 'Ingesting BoL PDF');
            
            // Start message rotation
            startMessageRotation();

            if (bolPageImages.length === 0) {
                stopMessageRotation();
                displayMessage("Please upload a PDF and wait for pages to render.");
                loading.classList.add('hidden');
                return;
            }

            const selectedModel = modelSelector.value;
            let backgroundProgressInterval = null;

            try {
                setProgress(25, 'Parsing documents');
                const apiKey = getApiKey();
                const prompt = bolPromptTextarea.value;
                let resultText = '';
                const imageParts = bolPageImages.map(imgDataUrl => ({
                    inlineData: { mimeType: 'image/jpeg', data: imgDataUrl.split(',')[1] }
                }));

                // Start background progress during API calls
                backgroundProgressInterval = startContinuousProgress();

                if (selectedModel.startsWith('gemini')) {
                    setProgress(50, 'Organizing content');
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }, ...imageParts] }],
                        generationConfig: { "response_mime_type": "application/json" }
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    setProgress(75, 'Finalizing output');
                    const result = await response.json();
                    resultText = result.candidates[0].content.parts[0].text;
                } else if (selectedModel === 'claude-4') {
                    setProgress(50, 'Organizing content');
                    const apiUrl = 'https://api.anthropic.com/v1/messages';
                    const imageContent = bolPageImages.map(imgDataUrl => ({
                        type: 'image',
                        source: { type: 'base64', media_type: 'image/jpeg', data: imgDataUrl.split(',')[1] }
                    }));
                    const payload = {
                        model: 'claude-4-opus-20250514',
                        max_tokens: 4096,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'text', text: prompt },
                                    ...imageContent
                                ]
                            }
                        ]
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`Claude 4 API Error: ${response.status} ${await response.text()}`);
                    setProgress(75, 'Finalizing output');
                    const result = await response.json();
                    const textBlock = result.content.find(c => c.type === 'text');
                    if (!textBlock) throw new Error('Claude 4 did not return a text response.');
                    resultText = textBlock.text;
                } else {
                    setProgress(50, 'Organizing content');
                    const apiUrl = "https://api.openai.com/v1/chat/completions";
                    const imageContent = bolPageImages.map(imgDataUrl => ({
                         type: 'image_url', image_url: { url: imgDataUrl } 
                    }));
                    const payload = {
                        model: selectedModel,
                        response_format: { "type": "json_object" },
                        messages: [{ role: 'user', content: [ { type: 'text', text: prompt }, ...imageContent]}]
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    setProgress(75, 'Finalizing output');
                    const result = await response.json();
                    resultText = result.choices[0].message.content;
                }
                
                // Clear background progress
                if (backgroundProgressInterval) {
                    clearInterval(backgroundProgressInterval);
                }
                
                rawJsonResult = resultText;
                setProgress(90, 'Finalizing output');
                const consolidatedData = JSON.parse(resultText);
                stopMessageRotation();
                setProgress(100, 'Done');
                displayBolResults(consolidatedData);
                setTimeout(() => { loading.classList.add('hidden'); }, 800);
            } catch (error) {
                if (backgroundProgressInterval) {
                    clearInterval(backgroundProgressInterval);
                }
                stopMessageRotation();
                loading.classList.add('hidden');
                document.getElementById('bolContent').classList.remove('hidden');
                displayMessage(error.message);
                setProgress(0, 'Error');
            } finally {
                // loading.classList.add('hidden');
            }
        }

        // Update PDF rendering to show progress
        async function renderPdfToImages(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async (event) => {
                    try {
                        setProgress(20, 'Processing PDF pages');
                        const typedarray = new Uint8Array(event.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                        const pageImages = [];
                        
                        // Start background progress during page rendering
                        const backgroundProgressInterval = startContinuousProgress();
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 1.5 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            pageImages.push(canvas.toDataURL('image/jpeg'));
                            setProgress(20 + Math.round((i/pdf.numPages)*20), `Converting page ${i} of ${pdf.numPages}`);
                        }
                        
                        // Clear background progress
                        clearInterval(backgroundProgressInterval);
                        
                        setProgress(40, 'PDF processing complete');
                        resolve(pageImages);
                    } catch (error) {
                        setProgress(0, 'Error');
                        reject(error);
                    }
                };
                setProgress(10, 'Reading PDF file');
                fileReader.readAsArrayBuffer(file);
            });
        }

        function displayBolResults(data) {
            bolResultCard.innerHTML = '';
            currentBolPageIndex = 0; // Reset page index

            // Store coordinate data globally for coordinate overlay functionality
            window.coordinateData = data;

            const updateBolCarousel = () => {
                const img = bolResultCard.querySelector('#carouselImage');
                const pageCounter = bolResultCard.querySelector('#pageCounter');
                if (img && pageCounter) {
                    img.src = bolPageImages[currentBolPageIndex];
                    img.alt = `Document Page ${currentBolPageIndex + 1}`;
                    pageCounter.textContent = `${currentBolPageIndex + 1} / ${bolPageImages.length}`;
                    
                    // Update coordinate overlays when page changes
                    updateCoordinateOverlays();
                }
                const zoomImg = document.getElementById('zoomedImage');
                if(zoomImg) {
                    zoomImg.src = bolPageImages[currentBolPageIndex];
                }
            };
            
            const createCarousel = () => {
                const carouselContainer = document.createElement('div');
                carouselContainer.className = 'md:col-span-1 relative carousel-container';
                carouselContainer.id = 'carouselContainer';

                const img = document.createElement('img');
                img.id = 'carouselImage';
                img.src = bolPageImages.length > 0 ? bolPageImages[0] : '';
                img.className = 'rounded-lg border shadow-md w-full h-auto cursor-pointer';
                img.alt = 'Document Page 1';
                img.addEventListener('click', () => openImageZoomModal());
                img.addEventListener('load', () => {
                    // Update overlays when image loads
                    setTimeout(() => updateCoordinateOverlays(), 100);
                });

                const prevBtn = document.createElement('button');
                prevBtn.className = 'absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 z-20';
                prevBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>';
                prevBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentBolPageIndex = (currentBolPageIndex - 1 + bolPageImages.length) % bolPageImages.length;
                    updateBolCarousel();
                });
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 z-20';
                nextBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>';
                 nextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentBolPageIndex = (currentBolPageIndex + 1) % bolPageImages.length;
                    updateBolCarousel();
                });

                const pageCounter = document.createElement('div');
                pageCounter.id = 'pageCounter';
                pageCounter.className = 'absolute bottom-2 left-1/2 -translate-x-1/2 bg-black bg-opacity-70 text-white text-xs font-semibold px-2 py-1 rounded-full z-20';
                
                carouselContainer.append(img, prevBtn, nextBtn, pageCounter);

                if (bolPageImages.length <= 1) {
                    prevBtn.classList.add('hidden');
                    nextBtn.classList.add('hidden');
                }
                
                updateBolCarousel();
                return carouselContainer;
            };

            // Helper function to extract value from coordinate object or use direct value
            const getValue = (field) => {
                if (typeof field === 'object' && field.value !== undefined) {
                    return field.value;
                }
                return field || 'N/A';
            };

            // Helper function to extract coordinates
            const getCoordinates = (field) => {
                if (typeof field === 'object' && field.coordinates) {
                    return field.coordinates;
                }
                return null;
            };

            // Helper function to extract confidence score
            const getConfidence = (field) => {
                if (typeof field === 'object' && field.confidence !== undefined) {
                    return field.confidence;
                }
                return 0;
            };

            let contentsHtml = `
                    <table class="w-full text-sm mt-1 data-table border border-gray-300 rounded-lg overflow-hidden" id="contentsTable">
                        <thead>
                           <tr class="border-b-2 border-gray-300 bg-gray-100">
                                <th class="p-3 text-left font-semibold text-gray-700 border-r border-gray-300">Item #</th>
                                <th class="p-3 text-left font-semibold text-gray-700 border-r border-gray-300">Description</th>
                                <th class="p-3 text-left font-semibold text-gray-700 border-r border-gray-300">Amount</th>
                                <th class="p-3 text-left font-semibold text-gray-700 border-r border-gray-300">Weight</th>
                                <th class="p-3 text-left font-semibold text-gray-700 border-r border-gray-300">Use By Date</th>
                                <th class="p-3 text-center font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${(data.contents || []).map((item, idx) => {
                            const getConfidenceIndicator = (field) => {
                                const confidence = getConfidence(field);
                                const hasCoords = getCoordinates(field) && getCoordinates(field).x > 0;
                                if (!hasCoords) return '';
                                
                                let indicatorColor = 'bg-gray-400';
                                if (confidence >= confidenceSettings.high) indicatorColor = 'bg-green-500';
                                else if (confidence >= confidenceSettings.medium) indicatorColor = 'bg-orange-500';
                                else if (confidence > 0) indicatorColor = 'bg-red-500';
                                
                                return `<span class="w-2 h-2 ${indicatorColor} rounded-full inline-block mr-2" title="Confidence: ${confidence}%"></span>`;
                            };
                            
                            return `
                            <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors" data-row="${idx}">
                                <td class="p-3 editable-table-cell field-with-coordinates border-r border-gray-200" data-col="item_number" data-coordinates='${getCoordinates(item.item_number) ? JSON.stringify(getCoordinates(item.item_number)) : ''}'>${getConfidenceIndicator(item.item_number)}${getValue(item.item_number)}</td>
                                <td class="p-3 editable-table-cell field-with-coordinates border-r border-gray-200" data-col="description" data-coordinates='${getCoordinates(item.description) ? JSON.stringify(getCoordinates(item.description)) : ''}'>${getConfidenceIndicator(item.description)}${getValue(item.description)}</td>
                                <td class="p-3 editable-table-cell field-with-coordinates border-r border-gray-200" data-col="amount" data-coordinates='${getCoordinates(item.amount) ? JSON.stringify(getCoordinates(item.amount)) : ''}'>${getConfidenceIndicator(item.amount)}${getValue(item.amount)}</td>
                                <td class="p-3 editable-table-cell field-with-coordinates border-r border-gray-200" data-col="weight" data-coordinates='${getCoordinates(item.weight) ? JSON.stringify(getCoordinates(item.weight)) : ''}'>${getConfidenceIndicator(item.weight)}${getValue(item.weight)}</td>
                                <td class="p-3 editable-table-cell field-with-coordinates border-r border-gray-200" data-col="use_by_date" data-coordinates='${getCoordinates(item.use_by_date) ? JSON.stringify(getCoordinates(item.use_by_date)) : ''}'>${getConfidenceIndicator(item.use_by_date)}${getValue(item.use_by_date)}</td>
                                <td class="p-3 text-center"><button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg transition-colors" title="Remove row">&minus;</button></td>
                            </tr>`;
                        }).join('')}
                        </tbody>
                    </table>
                    <div class="mt-2 text-right">
                        <button id="addRowBtn" class="bg-blue-100 text-blue-700 font-semibold px-3 py-1 rounded hover:bg-blue-200 transition">+ Add Row</button>
                    </div>
            `;

            const mainDiv = document.createElement('div');
            mainDiv.className = 'grid grid-cols-1 lg:grid-cols-5 gap-4 grid-container';
            mainDiv.innerHTML = `
                <div class="lg:col-span-2">
                    <div id="mainCarouselContainer" class="relative">
                        </div>
                </div>
                <div class="lg:col-span-3">
                    <div class="border border-gray-300 rounded-lg overflow-hidden bg-white shadow-sm mb-4">
                        <table class="w-full data-table">
                            <thead>
                                <tr class="bg-gray-100 border-b-2 border-gray-300">
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-r border-gray-300">Order Information</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-r border-gray-300">Value</th>
                                    <th id="confidenceHeader" class="px-4 py-3 text-center text-sm font-semibold text-gray-700 confidence-col cursor-pointer group" title="Toggle Confidence Column">
                                        <div class="flex items-center justify-center gap-2">
                                            <span>Confidence(%)</span>
                                            <svg id="confidenceChevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 group-hover:text-gray-800">
                                                <path d="m6 9 6 6 6-6"/>
                                            </svg>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${createDisplayField('bol_number', 'BoL Number', getValue(data.bol_number), getCoordinates(data.bol_number), getConfidence(data.bol_number))}
                                ${createDisplayField('order_number', 'Order #', getValue(data.order_number), getCoordinates(data.order_number), getConfidence(data.order_number))}
                                ${createDisplayField('seal_number', 'Seal Number', getValue(data.seal_number), getCoordinates(data.seal_number), getConfidence(data.seal_number))}
                                ${createDisplayField('shipment_number', 'Shipment #', getValue(data.shipment_number), getCoordinates(data.shipment_number), getConfidence(data.shipment_number))}
                                ${createDisplayField('delivery_number', 'Delivery #', getValue(data.delivery_number), getCoordinates(data.delivery_number), getConfidence(data.delivery_number))}
                                ${createDisplayField('scac', 'SCAC', getValue(data.scac), getCoordinates(data.scac), getConfidence(data.scac))}
                                ${createDisplayField('date', 'Date', getValue(data.date), getCoordinates(data.date), getConfidence(data.date))}
                                ${createDisplayField('carrier', 'Carrier', getValue(data.carrier), getCoordinates(data.carrier), getConfidence(data.carrier))}
                                ${createDisplayField('temperature', 'Temperature', getValue(data.temperature), getCoordinates(data.temperature), getConfidence(data.temperature))}
                                ${createDisplayField('signed', 'Signed?', getValue(data.signed) === true ? 'Yes' : getValue(data.signed) === false ? 'No' : getValue(data.signed), getCoordinates(data.signed), getConfidence(data.signed))}
                                ${createDisplayField('origin', 'Origin', getValue(data.origin), getCoordinates(data.origin), getConfidence(data.origin))}
                                ${createDisplayField('destination', 'Destination', getValue(data.destination), getCoordinates(data.destination), getConfidence(data.destination))}
                                ${createDisplayField('vendor', 'Vendor', getValue(data.vendor), getCoordinates(data.vendor), getConfidence(data.vendor))}
                                ${createDisplayField('customer', 'Customer', getValue(data.customer), getCoordinates(data.customer), getConfidence(data.customer))}
                            </tbody>
                        </table>
                    </div>
                    <div class="border border-gray-200 rounded-lg bg-white shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mb-2 px-3 pt-3">Contents</label>
                        <div class="p-3 pt-1 overflow-x-auto">${contentsHtml}</div>
                    </div>
                </div>
            `;
            bolResultCard.appendChild(mainDiv);
            if (bolPageImages.length > 0) {
                bolResultCard.querySelector('#mainCarouselContainer').appendChild(createCarousel());
            }
            
            // Collapsible confidence column logic
            const confidenceHeader = bolResultCard.querySelector('#confidenceHeader');
            if (confidenceHeader) {
                const confidenceChevron = bolResultCard.querySelector('#confidenceChevron');
                const allConfidenceCells = bolResultCard.querySelectorAll('.confidence-col');

                const setConfidenceCollapsed = (isCollapsed) => {
                    if (confidenceChevron) {
                        confidenceChevron.classList.toggle('collapsed', isCollapsed);
                    }
                    allConfidenceCells.forEach(col => {
                        col.classList.toggle('collapsed', isCollapsed);
                    });
                };

                // Collapse by default
                setConfidenceCollapsed(true);

                confidenceHeader.addEventListener('click', () => {
                    const isCurrentlyCollapsed = confidenceChevron ? confidenceChevron.classList.contains('collapsed') : true;
                    setConfidenceCollapsed(!isCurrentlyCollapsed);
                });
            }

            // Re-attach listeners for dynamically created elements
            bolResultCard.querySelectorAll('[data-action="edit"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const wrapper = e.currentTarget.closest('div');
                    const fieldId = wrapper.querySelector('span[data-field-id]').dataset.fieldId;
                    const fieldLabel = wrapper.querySelector('label').textContent;
                    const currentValue = wrapper.querySelector('span[data-field-id]').textContent;
                    openEditModal(fieldId, fieldLabel, currentValue);
                });
            });

             bolResultCard.querySelectorAll('#carouselImage').forEach(img => {
                 img.addEventListener('click', () => openImageZoomModal());
            });
            
            resultsWrapper.classList.remove('hidden');
            bolResultContainer.classList.remove('hidden');
            attachContentsTableListeners();
        }

        function createDisplayField(id, label, value, coordinates = null, confidence = 0) {
            const coordsData = coordinates ? JSON.stringify(coordinates) : '';
            const coordsClass = coordinates ? 'field-with-coordinates' : '';
            const hasCoords = coordinates && coordinates.x > 0 && coordinates.y > 0;
            
            // Determine confidence indicator color using configurable thresholds
            let indicatorColor = 'bg-gray-400';
            let confidenceTextColor = 'text-gray-600';
            
            if (confidence >= confidenceSettings.high) {
                indicatorColor = 'bg-green-500';
                confidenceTextColor = 'text-green-700';
            } else if (confidence >= confidenceSettings.medium) {
                indicatorColor = 'bg-orange-500';
                confidenceTextColor = 'text-orange-700';
            } else if (confidence > 0) {
                indicatorColor = 'bg-red-500';
                confidenceTextColor = 'text-red-700';
            }
            
            const confidenceDisplay = confidence > 0 ? `${confidence.toFixed(1)}%` : 'N/A';
            const coordsIndicator = hasCoords ? `<span class="w-2 h-2 ${indicatorColor} rounded-full inline-block" title="Hover field to see source location"></span>` : '';
            
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 border-r border-gray-200 bg-gray-50">
                        <div class="flex items-center gap-2">
                            ${coordsIndicator}
                            <span class="text-sm font-medium text-gray-700">${label}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 border-r border-gray-200 ${coordsClass}">
                        <span class="text-sm text-gray-900 editable-field" data-field-id="${id}" data-coordinates='${coordsData}' tabindex="0" title="${value || 'N/A'}">${value || 'N/A'}</span>
                    </td>
                    <td class="px-4 py-3 text-center confidence-col">
                        <span class="text-sm font-medium ${confidenceTextColor}">${confidenceDisplay}</span>
                    </td>
                </tr>`;
        }
        
        function openEditModal(fieldId, fieldLabel, currentValue) {
            editModalTitle.textContent = `Edit ${fieldLabel}`;
            editModalContent.innerHTML = `<textarea id="edit-input" class="w-full rounded-md border-gray-300 shadow-sm" rows="3">${currentValue === 'N/A' ? '' : currentValue}</textarea>`;
            saveEditBtn.dataset.fieldId = fieldId;
            fieldEditModal.classList.remove('hidden');
            fieldEditModal.classList.add('flex');
        }
        
        function openImageZoomModal() {
            zoomedImage.src = bolPageImages[currentBolPageIndex];
            imageZoomModal.classList.remove('hidden');
            imageZoomModal.classList.add('flex');
        }

        // Coordinate overlay functionality
        function updateCoordinateOverlays() {
            // Remove existing overlays
            document.querySelectorAll('.coordinate-overlay').forEach(overlay => overlay.remove());
            
            // Check if coordinate overlays are enabled
            const showOverlays = localStorage.getItem('coordinateOverlays') !== 'false';
            if (!showOverlays) return;
            
            const carouselContainer = document.getElementById('carouselContainer');
            const carouselImage = document.getElementById('carouselImage');
            
            if (!carouselContainer || !carouselImage || !window.coordinateData) {
                return;
            }
            
            // Wait for image to load completely
            if (!carouselImage.complete || carouselImage.naturalWidth === 0) {
                setTimeout(() => updateCoordinateOverlays(), 200);
                return;
            }
            
            // Get the image's actual position and dimensions relative to the viewport
            const imageRect = carouselImage.getBoundingClientRect();
            const containerRect = carouselContainer.getBoundingClientRect();
            
            // Calculate the image's position within its container
            const imageOffsetX = imageRect.left - containerRect.left;
            const imageOffsetY = imageRect.top - containerRect.top;
            
            // Get actual displayed image dimensions
            const displayWidth = carouselImage.clientWidth;
            const displayHeight = carouselImage.clientHeight;
            
            // Get natural image dimensions (original source image size)
            const naturalWidth = carouselImage.naturalWidth;
            const naturalHeight = carouselImage.naturalHeight;
            
            if (naturalWidth === 0 || naturalHeight === 0) {
                return;
            }
            
            // Calculate scale factors from source image pixels to displayed pixels
            const scaleX = displayWidth / naturalWidth;
            const scaleY = displayHeight / naturalHeight;
            
            // Create overlays for all fields that have coordinates for the current page
            document.querySelectorAll('[data-coordinates]').forEach(element => {
                const coordsData = element.getAttribute('data-coordinates');
                if (!coordsData) return;
                
                try {
                    const coordinates = JSON.parse(coordsData);
                    if (coordinates.page === currentBolPageIndex + 1 && coordinates.x > 0 && coordinates.y > 0) {
                        const overlay = document.createElement('div');
                        overlay.className = 'coordinate-overlay';
                        overlay.style.opacity = '0';
                        
                        // AI provides coordinates in pixels of the natural-sized source image.
                        // We scale them to the on-screen display size of the image.
                        const pixelX = coordinates.x;
                        const pixelY = coordinates.y;
                        const pixelWidth = coordinates.width;
                        const pixelHeight = coordinates.height;
                        
                        // Scale coordinates from natural image space to display space
                        // Add padding to ensure full text coverage
                        const padding = 8; // pixels of padding around the text
                        const scaledX = pixelX * scaleX;
                        const scaledY = pixelY * scaleY;
                        const scaledWidth = pixelWidth * scaleX;
                        const scaledHeight = pixelHeight * scaleY;
                        
                        // Position relative to the image's actual position within the container
                        const left = Math.max(0, imageOffsetX + scaledX - padding);
                        const top = Math.max(0, imageOffsetY + scaledY - padding);
                        const width = Math.max(scaledWidth + (padding * 2), 40);
                        const height = Math.max(scaledHeight + (padding * 2), 25);
                        
                        // Position relative to the container
                        overlay.style.left = `${left}px`;
                        overlay.style.top = `${top}px`;
                        overlay.style.width = `${width}px`;
                        overlay.style.height = `${height}px`;
                        
                        // Add debug info as data attributes
                        overlay.setAttribute('data-debug', `PIXEL: ${pixelX},${pixelY},${pixelWidth}x${pixelHeight} | Scaled: ${scaledX.toFixed(1)},${scaledY.toFixed(1)},${scaledWidth.toFixed(1)}x${scaledHeight.toFixed(1)} | Final: ${left.toFixed(1)},${top.toFixed(1)},${width.toFixed(1)}x${height.toFixed(1)} | ImageOffset: ${imageOffsetX.toFixed(1)},${imageOffsetY.toFixed(1)}`);
                        
                        carouselContainer.appendChild(overlay);
                        
                        // Store reference to overlay on element for easy access
                        element._coordinateOverlay = overlay;
                        
                        // Add hover event listeners (remove old ones first)
                        element.removeEventListener('mouseenter', element._mouseEnterHandler);
                        element.removeEventListener('mouseleave', element._mouseLeaveHandler);
                        
                        element._mouseEnterHandler = () => {
                            overlay.style.opacity = '1';
                        };
                        element._mouseLeaveHandler = () => {
                            overlay.style.opacity = '0';
                        };
                        
                        element.addEventListener('mouseenter', element._mouseEnterHandler);
                        element.addEventListener('mouseleave', element._mouseLeaveHandler);
                    }
                } catch (e) {
                    console.error('Error parsing coordinates:', e, coordsData);
                }
            });
        }

        // Add resize observer to update overlays when image size changes
        if (window.ResizeObserver) {
            const resizeObserver = new ResizeObserver(() => {
                setTimeout(() => updateCoordinateOverlays(), 100);
            });
            
            // Observe the carousel container
            setTimeout(() => {
                const carouselContainer = document.getElementById('carouselContainer');
                if (carouselContainer) {
                    resizeObserver.observe(carouselContainer);
                }
            }, 1000);
        }

        zoomPrevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            currentBolPageIndex = (currentBolPageIndex - 1 + bolPageImages.length) % bolPageImages.length;
            zoomedImage.src = bolPageImages[currentBolPageIndex];
            bolResultCard.querySelector('#carouselImage').src = bolPageImages[currentBolPageIndex];
            bolResultCard.querySelector('#pageCounter').textContent = `${currentBolPageIndex + 1} / ${bolPageImages.length}`;
        });
        zoomNextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            currentBolPageIndex = (currentBolPageIndex + 1) % bolPageImages.length;
            zoomedImage.src = bolPageImages[currentBolPageIndex];
            bolResultCard.querySelector('#carouselImage').src = bolPageImages[currentBolPageIndex];
            bolResultCard.querySelector('#pageCounter').textContent = `${currentBolPageIndex + 1} / ${bolPageImages.length}`;
        });

        function handleExportBolData() {
            const card = document.getElementById('bolResultCard');
            if (!card) return;

            const headers = ["BoL Number", "Order Number", "Seal Number", "Shipment Number", "Delivery Number", "SCAC", "Date", "Carrier", "Temperature", "Signed", "Origin", "Destination", "Vendor", "Customer", "Item #", "Content Description", "Content Amount", "Content Weight", "Use By Date"];
            const rows = [];
            
            const getValue = (id) => card.querySelector(`[data-field-id="${id}"]`) ? card.querySelector(`[data-field-id="${id}"]`).textContent : 'N/A';
            
            const baseData = {
                bol_number: getValue('bol_number'),
                order_number: getValue('order_number'),
                seal_number: getValue('seal_number'),
                shipment_number: getValue('shipment_number'),
                delivery_number: getValue('delivery_number'),
                scac: getValue('scac'),
                date: getValue('date'),
                carrier: getValue('carrier'),
                temperature: getValue('temperature'),
                signed: getValue('signed'),
                origin: getValue('origin'),
                destination: getValue('destination'),
                vendor: getValue('vendor'),
                customer: getValue('customer'),
            };

            const contentRows = card.querySelectorAll('tbody > tr');
            if (contentRows.length > 0 && contentRows[0].cells.length > 1) {
                 contentRows.forEach(row => {
                    rows.push([
                        baseData.bol_number, baseData.order_number, baseData.seal_number, baseData.shipment_number, baseData.delivery_number, baseData.scac, baseData.date, baseData.carrier, baseData.temperature, baseData.signed, baseData.origin, baseData.destination, baseData.vendor, baseData.customer,
                        row.cells[0] ? row.cells[0].innerText : 'N/A', // Item #
                        row.cells[1] ? row.cells[1].innerText : 'N/A', // Description
                        row.cells[2] ? row.cells[2].innerText : 'N/A', // Amount
                        row.cells[3] ? row.cells[3].innerText : 'N/A', // Weight
                        row.cells[4] ? row.cells[4].innerText : 'N/A'  // Use By Date
                    ].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
                });
            } else {
                 rows.push([baseData.bol_number, baseData.order_number, baseData.seal_number, baseData.shipment_number, baseData.delivery_number, baseData.scac, baseData.date, baseData.carrier, baseData.temperature, baseData.signed, baseData.origin, baseData.destination, baseData.vendor, baseData.customer, 'N/A', 'N/A', 'N/A', 'N/A', 'N/A'].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
            }

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "bol_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function getApiKey() {
            const isGpt = modelSelector.value.startsWith('gpt');
            const isClaude = modelSelector.value.startsWith('claude');
            const key = (isGpt || isClaude) ? openaiApiKeyInput.value.trim() : googleApiKeyInput.value.trim();
            if (!key) throw new Error(`Please provide an ${(isGpt || isClaude) ? 'OpenAI' : 'Google AI'} API Key.`);
            return key;
        }
        
        function resetUI() {
            loading.classList.add('hidden');
            parseBolBtn.disabled = true;
            resultsWrapper.classList.add('hidden');
            messageContainer.classList.add('hidden');
            bolResultContainer.classList.add('hidden');
            
            // Reset progress state
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            stopMessageRotation();
            currentProgress = 0;
            setProgress(0, '');
        }
        
        function displayMessage(msg) {
            messageContainer.classList.remove('hidden');
            message.innerText = msg;
        }

        const howToBtnOpenAI = document.getElementById('howToBtnOpenAI');
        if (howToBtnOpenAI) {
            howToBtnOpenAI.addEventListener('click', () => {
                updateKeyHelpPanel();
                sidePanel.classList.remove('translate-x-full');
                sidePanelOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('editable-field')) {
                const span = e.target;
                const currentValue = span.textContent === 'N/A' ? '' : span.textContent;
                const input = document.createElement(span.dataset.fieldId === 'origin' || span.dataset.fieldId === 'destination' ? 'textarea' : 'input');
                input.value = currentValue;
                input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                input.style.minHeight = span.dataset.fieldId === 'origin' || span.dataset.fieldId === 'destination' ? '2.5em' : '';
                input.addEventListener('blur', function() {
                    span.textContent = input.value || 'N/A';
                    span.style.display = '';
                    input.replaceWith(span);
                });
                input.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter' && input.tagName !== 'TEXTAREA') {
                        input.blur();
                    }
                });
                span.parentNode.replaceChild(input, span);
                input.focus();
                input.select();
            }
            // Table cell editing
            if (e.target.classList.contains('editable-table-cell')) {
                const td = e.target;
                const currentValue = td.textContent === 'N/A' ? '' : td.textContent;
                const input = document.createElement('input');
                input.value = currentValue;
                input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                input.addEventListener('blur', function() {
                    td.textContent = input.value || 'N/A';
                    td.style.display = '';
                    input.replaceWith(td);
                });
                input.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter') {
                        input.blur();
                    }
                });
                td.parentNode.replaceChild(input, td);
                input.focus();
                input.select();
            }
            // Add row
            if (e.target.id === 'addRowBtn') {
                const table = document.getElementById('contentsTable').getElementsByTagName('tbody')[0];
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="p-3 editable-table-cell border-r border-gray-200" data-col="item_number">N/A</td>
                    <td class="p-3 editable-table-cell border-r border-gray-200" data-col="description">N/A</td>
                    <td class="p-3 editable-table-cell border-r border-gray-200" data-col="amount">N/A</td>
                    <td class="p-3 editable-table-cell border-r border-gray-200" data-col="weight">N/A</td>
                    <td class="p-3 editable-table-cell border-r border-gray-200" data-col="use_by_date">N/A</td>
                    <td class="p-3 text-center"><button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg transition-colors" title="Remove row">&minus;</button></td>
                `;
                table.appendChild(row);
            }
            // Remove row
            if (e.target.classList.contains('remove-row-btn')) {
                const row = e.target.closest('tr');
                row.parentNode.removeChild(row);
            }
        });

        function attachContentsTableListeners() {
            const table = document.getElementById('contentsTable');
            if (!table) return;
            // Remove any previous event listeners by cloning
            const newTable = table.cloneNode(true);
            table.parentNode.replaceChild(newTable, table);
            // Use only event delegation on the table
            newTable.addEventListener('click', function(e) {
                if (e.target.classList.contains('editable-table-cell')) {
                    const td = e.target;
                    const currentValue = td.textContent === 'N/A' ? '' : td.textContent;
                    const input = document.createElement('input');
                    input.value = currentValue;
                    input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                    input.addEventListener('blur', function() {
                        td.textContent = input.value || 'N/A';
                        td.style.display = '';
                        input.replaceWith(td);
                    });
                    input.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter') {
                            input.blur();
                        }
                    });
                    td.parentNode.replaceChild(input, td);
                    input.focus();
                    input.select();
                }
                if (e.target.classList.contains('remove-row-btn')) {
                    const row = e.target.closest('tr');
                    row.parentNode.removeChild(row);
                }
                if (e.target.id === 'addRowBtn') {
                    const tbody = newTable.getElementsByTagName('tbody')[0];
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';
                    row.innerHTML = `
                        <td class="p-3 editable-table-cell border-r border-gray-200" data-col="item_number">N/A</td>
                        <td class="p-3 editable-table-cell border-r border-gray-200" data-col="description">N/A</td>
                        <td class="p-3 editable-table-cell border-r border-gray-200" data-col="amount">N/A</td>
                        <td class="p-3 editable-table-cell border-r border-gray-200" data-col="weight">N/A</td>
                        <td class="p-3 editable-table-cell border-r border-gray-200" data-col="use_by_date">N/A</td>
                        <td class="p-3 text-center"><button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg transition-colors" title="Remove row">&minus;</button></td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // Hide AI config section initially and toggle on triple-click of logo
        const aiConfigSection = document.getElementById('aiConfigSection');
        const vectorLogo = document.getElementById('vectorLogo');
        let logoClickCount = 0;
        let logoClickTimer = null;
        function toggleAIConfigSection() {
            aiConfigSection.classList.toggle('hidden');
        }
        vectorLogo.addEventListener('click', function() {
            logoClickCount++;
            if (logoClickTimer) clearTimeout(logoClickTimer);
            logoClickTimer = setTimeout(() => { logoClickCount = 0; }, 1000);
            if (logoClickCount === 3) {
                toggleAIConfigSection();
                logoClickCount = 0;
            }
        });

        // Raw JSON modal logic
        const rawResultsBtn = document.getElementById('rawResultsBtn');
        const rawJsonModal = document.getElementById('rawJsonModal');
        const rawJsonContent = document.getElementById('rawJsonContent');
        const closeRawJsonBtn = document.getElementById('closeRawJsonBtn');

        if (rawResultsBtn) {
            rawResultsBtn.addEventListener('click', () => {
                if (rawJsonResult) {
                    try {
                        const formattedJson = JSON.stringify(JSON.parse(rawJsonResult), null, 2);
                        rawJsonContent.textContent = formattedJson;
                    } catch (e) {
                        rawJsonContent.textContent = rawJsonResult; // Show raw text if not valid JSON
                    }
                } else {
                    rawJsonContent.textContent = 'No raw data available.';
                }
                rawJsonModal.classList.remove('hidden');
                rawJsonModal.classList.add('flex');
            });
        }
        if(closeRawJsonBtn) {
            closeRawJsonBtn.addEventListener('click', () => {
                rawJsonModal.classList.add('hidden');
                rawJsonModal.classList.remove('flex');
            });
        }
        if(rawJsonModal) {
            rawJsonModal.addEventListener('click', (e) => {
                if (e.target === rawJsonModal) {
                    rawJsonModal.classList.add('hidden');
                    rawJsonModal.classList.remove('flex');
                }
            });
        }

        // Settings functionality - replaces old logo triple-click functionality
        if (settingsBtn && aiConfigSection) {
            settingsBtn.addEventListener('click', function() {
                aiConfigSection.classList.toggle('hidden');
            });
        }
        
        // Settings Tab Navigation
        function switchSettingsTab(activeTab) {
            // Remove active class from all tabs and hide all content
            [settingsTabGeneral, settingsTabAI, settingsTabConfidence, settingsTabAppearance].forEach(tab => {
                if (tab) tab.classList.remove('active');
            });
            [settingsContentGeneral, settingsContentAI, settingsContentConfidence, settingsContentAppearance].forEach(content => {
                if (content) content.classList.add('hidden');
            });
            
            // Show active tab and content
            if (activeTab && document.getElementById(activeTab)) {
                document.getElementById(activeTab).classList.add('active');
                const contentId = activeTab.replace('Tab', 'Content');
                const content = document.getElementById(contentId);
                if (content) content.classList.remove('hidden');
            }
        }
        
        // Settings Tab Event Listeners
        if (settingsTabGeneral) settingsTabGeneral.addEventListener('click', () => switchSettingsTab('settingsTabGeneral'));
        if (settingsTabAI) settingsTabAI.addEventListener('click', () => switchSettingsTab('settingsTabAI'));
        if (settingsTabConfidence) settingsTabConfidence.addEventListener('click', () => switchSettingsTab('settingsTabConfidence'));
        if (settingsTabAppearance) settingsTabAppearance.addEventListener('click', () => switchSettingsTab('settingsTabAppearance'));
        
        // Dark Mode Toggle
        if (darkModeToggle) {
            darkModeToggle.addEventListener('change', function() {
                const isDark = this.checked;
                if (isDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                }
            });
        }
        
        // Compact Mode Toggle
        if (compactModeToggle) {
            compactModeToggle.addEventListener('change', function() {
                const isCompact = this.checked;
                localStorage.setItem('compactMode', isCompact.toString());
                // Apply compact mode styles
                if (isCompact) {
                    document.body.classList.add('compact-mode');
                } else {
                    document.body.classList.remove('compact-mode');
                }
            });
        }
        
        // Auto Save Toggle
        if (autoSaveToggle) {
            autoSaveToggle.addEventListener('change', function() {
                const isAutoSave = this.checked;
                localStorage.setItem('autoSave', isAutoSave.toString());
            });
        }
        
        // Coordinate Overlays Toggle
        if (coordinateOverlaysToggle) {
            coordinateOverlaysToggle.addEventListener('change', function() {
                const showOverlays = this.checked;
                localStorage.setItem('coordinateOverlays', showOverlays.toString());
                // Update overlay visibility
                const overlays = document.querySelectorAll('.coordinate-overlay');
                overlays.forEach(overlay => {
                    overlay.style.display = showOverlays ? 'block' : 'none';
                });
            });
        }
        
        // Show Confidence Indicators Toggle
        if (showConfidenceIndicators) {
            showConfidenceIndicators.addEventListener('change', function() {
                const showIndicators = this.checked;
                localStorage.setItem('showConfidenceIndicators', showIndicators.toString());
                // Update confidence indicator visibility
                const indicators = document.querySelectorAll('.w-2.h-2.rounded-full');
                indicators.forEach(indicator => {
                    indicator.style.display = showIndicators ? 'inline-block' : 'none';
                });
            });
        }
        
        // Confidence slider functionality
        function updateConfidenceDisplay() {
            const highValue = parseInt(highConfidenceThreshold.value);
            const mediumValue = parseInt(mediumConfidenceThreshold.value);
            
            // Update value displays
            document.getElementById('highValueDisplay').textContent = `${highValue}%`;
            document.getElementById('mediumValueDisplay').textContent = `${mediumValue}%`;
            document.getElementById('lowRangeDisplay').textContent = `< ${mediumValue}%`;
            
            // Update preview
            document.getElementById('previewHigh').textContent = `${highValue}%+`;
            document.getElementById('previewMedium').textContent = `${mediumValue}%-${highValue - 1}%`;
            document.getElementById('previewLow').textContent = `<${mediumValue}%`;
            
            // Ensure medium is always less than high
            if (mediumValue >= highValue) {
                mediumConfidenceThreshold.value = highValue - 1;
                updateConfidenceDisplay();
            }
        }
        
        // Add event listeners for sliders
        if (highConfidenceThreshold) {
            highConfidenceThreshold.addEventListener('input', updateConfidenceDisplay);
        }
        if (mediumConfidenceThreshold) {
            mediumConfidenceThreshold.addEventListener('input', updateConfidenceDisplay);
        }
        
        // Reset to defaults functionality
        if (resetConfidenceDefaults) {
            resetConfidenceDefaults.addEventListener('click', function() {
                highConfidenceThreshold.value = 95;
                mediumConfidenceThreshold.value = 80;
                updateConfidenceDisplay();
            });
        }
        
        // Save confidence settings
        if (saveConfidenceSettings) {
            saveConfidenceSettings.addEventListener('click', function() {
                confidenceSettings.high = parseInt(highConfidenceThreshold.value);
                confidenceSettings.medium = parseInt(mediumConfidenceThreshold.value);
                localStorage.setItem('confidenceSettings', JSON.stringify(confidenceSettings));
                
                // Show success message
                const originalText = saveConfidenceSettings.textContent;
                saveConfidenceSettings.textContent = 'Saved!';
                saveConfidenceSettings.classList.add('bg-green-600');
                saveConfidenceSettings.classList.remove('bg-blue-600');
                
                setTimeout(() => {
                    saveConfidenceSettings.textContent = originalText;
                    saveConfidenceSettings.classList.remove('bg-green-600');
                    saveConfidenceSettings.classList.add('bg-blue-600');
                }, 2000);
            });
        }
        
        // Initialize confidence display on page load
        updateConfidenceDisplay();

    </script>
</body>
</html>
