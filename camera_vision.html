<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Vision: Yard Auditor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-google-sans {
            font-family: 'Roboto', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #message {
            white-space: pre-wrap;
            text-align: left;
            background-color: #fef2f2;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
            color: #b91c1c;
        }
        .translate-x-full {
             transform: translateX(100%);
        }
        .side-panel-tab.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .editable-field {
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
            border-radius: 0.375rem;
            padding: 0.15em 0.35em;
        }
        .editable-field:hover, .editable-field:focus {
            background: #e0e7ff;
            border: 1px solid #6366f1;
            outline: none;
        }
        .editable-input:focus {
            background: #eef2ff;
            border: 1.5px solid #6366f1;
            outline: none;
        }
        .editable-table-cell {
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
            border-radius: 0.375rem;
        }
        .editable-table-cell:hover, .editable-table-cell:focus {
            background: #e0e7ff;
            border: 1px solid #6366f1;
            outline: none;
        }
        .field-block, .mt-1.flex.items-center.p-2.border.bg-gray-50.rounded-md { margin-bottom: 1.1rem !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
            <header class="mb-8">
                <div class="flex items-center justify-between relative mb-6">
                    <div class="flex-1"></div>
                    <img id="vectorLogo" src="https://cdn-eblmdf.nitrocdn.com/vVuBUVEtyJTDzFmiTWcmAlTgwfLlYdtZ/assets/images/optimized/rev-d91b495/www.withvector.com/wp-content/uploads/2024/09/vector-logo.png" alt="Vector Logo" style="height:38px; width:auto; margin-right:8px;" class="rounded-lg shadow-sm hover:scale-105 transition-transform duration-200 cursor-pointer" />
                </div>
                <div class="text-center mt-2">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 font-google-sans">Camera Vision: Yard Auditor</h1>
                    <p class="mt-2 text-gray-600">Upload a yard video, and the AI will analyze the footage to catalog every unique trailer present.</p>
                </div>
            </header>

            <div id="aiConfigSection" class="space-y-6 hidden">
                 <div>
                    <div class="flex items-center justify-between mb-2">
                        <label for="modelSelector" class="block text-lg font-medium text-gray-700 font-google-sans">Choose AI Model</label>
                        <button id="editBolPromptBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors ml-4">Edit Prompt</button>
                    </div>
                    <select id="modelSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gpt-4o">OpenAI GPT-4o</option>
                        <option value="claude-4">Claude 4</option>
                    </select>
                </div>
                <div id="googleKeyContainer">
                    <div class="flex items-center justify-between mb-2">
                         <label for="googleApiKeyInput" class="block text-lg font-medium text-gray-700 font-google-sans">Google AI API Key</label>
                         <button id="howToBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">How to get a key?</button>
                    </div>
                    <input type="password" id="googleApiKeyInput" placeholder="Enter your Google AI API Key" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div id="openaiKeyContainer" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <label for="openaiApiKeyInput" class="block text-lg font-medium text-gray-700 font-google-sans">OpenAI API Key</label>
                        <button id="howToBtnOpenAI" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">How to get a key?</button>
                    </div>
                    <input type="password" id="openaiApiKeyInput" placeholder="Enter your OpenAI API Key" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>

            <div id="bolContent">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-lg font-medium text-gray-700 font-google-sans">Upload Yard Video</label>
                </div>
                 <label for="bolUpload" class="flex flex-col items-center justify-center w-full min-h-[16rem] border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition p-4">
                     <div id="bol-prompt-text" class="flex flex-col items-center justify-center text-center">
                         <svg class="w-10 h-10 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                         <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload a video</span></p>
                         <p id="videoFileName" class="text-sm text-green-600 font-semibold mt-2"></p>
                     </div>
                     <div id="bol-preview-container" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                     <input id="bolUpload" type="file" class="hidden" accept="video/*" />
                 </label>
                <div class="text-center mt-8 mb-8">
                    <button id="parseBolBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">Initiate Yard Auditor</button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="loading" class="text-center my-4 hidden">
        <div class="w-full max-w-2xl mx-auto">
            <div class="flex items-center justify-between mb-2">
                <span id="progressLabel" class="text-xl font-semibold text-blue-600">Loading...</span>
                <span id="progressPercent" class="text-xl font-bold text-blue-600">0%</span>
            </div>
            <div class="w-full bg-blue-100 rounded-full h-6 relative overflow-hidden">
                <div id="progressBar" class="h-6 bg-blue-500 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
            </div>
        </div>
    </div>
    <div id="messageContainer" class="hidden">
         <div id="message" class="text-red-600 font-medium"></div>
    </div>
    
    <div id="resultsWrapper" class="hidden">
         <div id="bolResultContainer" class="hidden mt-6">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold text-gray-800 font-google-sans">Yard Audit Results</h2>
                 <div class="flex gap-2">
                     <button id="printBolBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out shadow-sm flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><rect x="6" y="13" width="12" height="8" rx="2"/><path d="M6 17h0"/></svg>
                         Print Results
                     </button>
                     <button id="exportBolBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-sm flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                         Export Data
                     </button>
                 </div>
             </div>
            <div id="bolResultCard" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                </div>
        </div>
    </div>

    <div id="sidePanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="sidePanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-google-sans font-bold">API Key Help</h2>
                <button id="closePanelBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
             <div class="border-b border-gray-200">
                <nav class="flex" aria-label="Side Panel Tabs">
                    <button id="panelTabKey" class="side-panel-tab active flex-1 border-b-2 py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Get API Key</button>
                    <button id="panelTabBilling" class="side-panel-tab flex-1 border-b-2 border-transparent py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Enable Billing</button>
                </nav>
            </div>
            <div id="panelContentKey" class="p-6 overflow-y-auto flex-grow">
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google AI Studio</h3>
                        <p class="mb-3 text-sm">Navigate to <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com</a> and sign in with your Google account.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-1.png" alt="Google AI Studio Homepage" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Get API Key</h3>
                        <p class="mb-3 text-sm">Once in AI Studio, click <b>"Get API key"</b> from the left-hand menu.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-2.png" alt="Get API Key button" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Create API key in a new project</h3>
                        <p class="mb-3 text-sm">A dialog will appear. Click on <b>"Create API key in new project"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-3.png" alt="Create API Key in new project" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Copy Your Key</h3>
                        <p class="mb-3 text-sm">Your new API key will be displayed. Click the copy icon to copy the key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-4.png" alt="Copy new API key" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 5: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "Google AI API Key" input field.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-5.png" alt="Paste key into the application" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            </div>
            <div id="panelContentBilling" class="p-6 overflow-y-auto flex-grow hidden">
                 <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google Cloud Console</h3>
                        <p class="mb-3 text-sm">Navigate to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a> and select the project associated with your API key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-1.png" alt="Google Cloud Console" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Open Billing Menu</h3>
                        <p class="mb-3 text-sm">Click the main navigation menu (hamburger icon) and select <b>"Billing"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-2.png" alt="Billing Menu" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Link a Billing Account</h3>
                        <p class="mb-3 text-sm">If your project doesn't have a billing account, you'll see a prompt to <b>"Link a billing account"</b>. Click it. If you need to create one, select <b>"Manage billing accounts"</b> and then <b>"Create account"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-3.png" alt="Link billing account" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Set Up Payment</h3>
                        <p class="mb-3 text-sm">Follow the on-screen instructions to provide your payment information and complete the setup.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-4.png" alt="Payment information" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="promptSidePanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="promptSidePanel" class="fixed top-0 right-0 h-full w-full max-w-lg bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-google-sans font-bold">Edit Prompt</h2>
                <button id="closePromptPanelBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
            <div id="promptPanelContentBol" class="p-6 overflow-y-auto flex-grow flex flex-col">
                <label for="bolPromptTextarea" class="font-semibold mb-2">Bill of Lading Prompt</label>
                <textarea id="bolPromptTextarea" class="w-full flex-grow p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"></textarea>
                 <div class="mt-4 flex gap-4">
                     <button id="saveBolPromptBtn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Save</button>
                     <button id="resetBolPromptBtn" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Reset to Default</button>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="imageZoomModal" class="hidden fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-[100] p-4">
        <button id="closeZoomModal" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
        <button id="zoomPrevBtn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
        <img id="zoomedImage" src="" class="max-w-full max-h-full">
         <button id="zoomNextBtn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
    </div>

    <div id="fieldEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[100]">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="editModalTitle" class="text-lg font-bold mb-4">Edit Field</h3>
            <div id="editModalContent">
                </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancelEditBtn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button id="saveEditBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        // DOM Elements
        const modelSelector = document.getElementById('modelSelector');
        const googleKeyContainer = document.getElementById('googleKeyContainer');
        const openaiKeyContainer = document.getElementById('openaiKeyContainer');
        const googleApiKeyInput = document.getElementById('googleApiKeyInput');
        const openaiApiKeyInput = document.getElementById('openaiApiKeyInput');
        const loading = document.getElementById('loading');
        const messageContainer = document.getElementById('messageContainer');
        const message = document.getElementById('message');
        const resultsWrapper = document.getElementById('resultsWrapper');
        
        // BoL Elements
        const bolUpload = document.getElementById('bolUpload');
        const bolPromptText = document.getElementById('bol-prompt-text');
        const videoFileNameDisplay = document.getElementById('videoFileName');
        const bolPreviewContainer = document.getElementById('bol-preview-container');
        const parseBolBtn = document.getElementById('parseBolBtn');
        const bolResultContainer = document.getElementById('bolResultContainer');
        const exportBolBtn = document.getElementById('exportBolBtn');
        const bolResultCard = document.getElementById('bolResultCard');

        // Modal Elements
        const imageZoomModal = document.getElementById('imageZoomModal');
        const zoomedImage = document.getElementById('zoomedImage');
        const closeZoomModal = document.getElementById('closeZoomModal');
        const zoomPrevBtn = document.getElementById('zoomPrevBtn');
        const zoomNextBtn = document.getElementById('zoomNextBtn');
        const fieldEditModal = document.getElementById('fieldEditModal');
        const editModalTitle = document.getElementById('editModalTitle');
        const editModalContent = document.getElementById('editModalContent');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');

        // Side Panel Elements
        const howToBtn = document.getElementById('howToBtn');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const panelTabKey = document.getElementById('panelTabKey');
        const panelTabBilling = document.getElementById('panelTabBilling');
        const panelContentKey = document.getElementById('panelContentKey');
        const panelContentBilling = document.getElementById('panelContentBilling');
        
        // Prompt Panel Elements
        const editBolPromptBtn = document.getElementById('editBolPromptBtn');
        const promptSidePanelOverlay = document.getElementById('promptSidePanelOverlay');
        const promptSidePanel = document.getElementById('promptSidePanel');
        const closePromptPanelBtn = document.getElementById('closePromptPanelBtn');
        const promptPanelContentBol = document.getElementById('promptPanelContentBol');
        const bolPromptTextarea = document.getElementById('bolPromptTextarea');
        const saveBolPromptBtn = document.getElementById('saveBolPromptBtn');
        const resetBolPromptBtn = document.getElementById('resetBolPromptBtn');
        
        let videoFile = null;
        let videoFrames = [];
        let currentFrameIndex = 0;
        let trailerImages = []; // Global variable for trailer images

        const defaultBolPrompt = `You are a highly attentive logistics analyst specializing in visual recognition. Your task is to meticulously scan a truck yard and identify every unique semi-trailer that appears.
For each unique trailer, provide the following information as a data frame. Be extremely precise.

1. trailer_id: The primary alphanumeric identification number on the side of the trailer.
- CRITICAL: This ID is for tracking. Do NOT include physical dimensions like "53'" or "48'". These belong in the \`trailer_size\` field.
- Example: If you see "XTRZ 123456" and "53'" nearby, the trailer_id is "XTRZ 123456".
2. carrier: The name of the trucking company, identified from any logos or text on the trailer.
3. is_loaded: A boolean value. This must be \`true\` if you see a plastic or metal seal on the trailer door handle, and \`false\` otherwise.
4. location: A string, representing the loading door number or physical location where the trailer is parked.
5. trailer_type: A string. Determine if the trailer is a "dry van" (a standard box trailer) or a "reefer" (a refrigerated trailer, which will have a large cooling unit on the front).
6. trailer_size: A number. Estimate the length of the trailer in feet. Look for numbers like 53 or 48.
7. image: the best frame for identification of the trailer.

Core Rules:

- Be Thorough: Analyze the entire input. Your main goal is to catalog EVERY unique trailer possible. You should AT LEAST analyze 10 frames per second in the video. 
- Accuracy is Key: Pay very close attention to the difference between trailer_id and trailer_size.
- Uniqueness: Only list each unique trailer_id once.
- Use Null If you cannot determine information, use a null value for that field.
- Strict DataFrame Output: Your final output MUST be a valid data frame. Do not include any other text.`;

        const defaultGoogleApiKey = "AIzaSyDe0pVIFyKI_SiTpVMlpbt1Gtdg3uF9WbU";
        googleApiKeyInput.value = defaultGoogleApiKey;

        bolPromptTextarea.value = defaultBolPrompt;

        // --- Dynamic API Key Help Content ---
        const keyHelpContent = {
            gemini: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google AI Studio</h3>
                        <p class="mb-3 text-sm">Navigate to <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com</a> and sign in with your Google account.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-1.png" alt="Google AI Studio Homepage" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Get API Key</h3>
                        <p class="mb-3 text-sm">Once in AI Studio, click <b>"Get API key"</b> from the left-hand menu.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-2.png" alt="Get API Key button" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Create API key in a new project</h3>
                        <p class="mb-3 text-sm">A dialog will appear. Click on <b>"Create API key in new project"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-3.png" alt="Create API Key in new project" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Copy Your Key</h3>
                        <p class="mb-3 text-sm">Your new API key will be displayed. Click the copy icon to copy the key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-4.png" alt="Copy new API key" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 5: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "Google AI API Key" input field.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-5.png" alt="Paste key into the application" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            `,
            gpt: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to OpenAI Platform</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">platform.openai.com/api-keys</a> and sign in with your OpenAI account.</p>
                        <img src="https://platform.openai.com/static/images/api-keys.png" alt="OpenAI API Keys" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Create a New API Key</h3>
                        <p class="mb-3 text-sm">Click <b>"Create new secret key"</b>. Name your key and copy it. <b>Store it securely</b> as you won't be able to see it again.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "OpenAI API Key" input field.</p>
                    </div>
                </div>
            `,
            claude: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Anthropic Console</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://console.anthropic.com/account/keys" target="_blank" class="text-blue-600 hover:underline">console.anthropic.com/account/keys</a> and sign in or create an Anthropic account.</p>
                        <img src="https://placehold.co/600x300/e2e8f0/334155?text=Anthropic+Console" alt="Anthropic Console" class="rounded-lg border shadow-sm">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Create an API Key</h3>
                        <p class="mb-3 text-sm">Click <b>"Create Key"</b>, give it a name, and copy the key. <b>Store it securely</b> as you won't be able to see it again.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "OpenAI API Key" input field (used for Claude as well).</p>
                    </div>
                </div>
            `
        };

        const billingHelpContent = {
            gemini: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google Cloud Console</h3>
                        <p class="mb-3 text-sm">Navigate to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a> and select the project associated with your API key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-1.png" alt="Google Cloud Console" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Open Billing Menu</h3>
                        <p class="mb-3 text-sm">Click the main navigation menu (hamburger icon) and select <b>"Billing"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-2.png" alt="Billing Menu" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Link a Billing Account</h3>
                        <p class="mb-3 text-sm">If your project doesn't have a billing account, you'll see a prompt to <b>"Link a billing account"</b>. Click it. If you need to create one, select <b>"Manage billing accounts"</b> and then <b>"Create account"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-3.png" alt="Link billing account" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Set Up Payment</h3>
                        <p class="mb-3 text-sm">Follow the on-screen instructions to provide your payment information and complete the setup.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-4.png" alt="Payment information" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            `,
            gpt: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to OpenAI Billing</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://platform.openai.com/account/billing/overview" target="_blank" class="text-blue-600 hover:underline">platform.openai.com/account/billing/overview</a> and sign in.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Add a Payment Method</h3>
                        <p class="mb-3 text-sm">Click <b>"Add payment method"</b> and follow the instructions to add your credit card or other payment method.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Set Usage Limits (Optional)</h3>
                        <p class="mb-3 text-sm">You can set usage limits to control your spending in the <b>"Usage limits"</b> tab.</p>
                    </div>
                </div>
            `,
            claude: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Anthropic Console Billing</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://console.anthropic.com/account/billing" target="_blank" class="text-blue-600 hover:underline">console.anthropic.com/account/billing</a> and sign in.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Add a Payment Method</h3>
                        <p class="mb-3 text-sm">Click <b>"Add payment method"</b> and follow the instructions to add your credit card or other payment method.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Review Usage and Limits</h3>
                        <p class="mb-3 text-sm">Monitor your usage and set limits as needed to control your spending.</p>
                    </div>
                </div>
            `
        };

        function getCurrentProvider() {
            const val = modelSelector.value;
            if (val.startsWith('gemini')) return 'gemini';
            if (val.startsWith('gpt')) return 'gpt';
            if (val.startsWith('claude')) return 'claude';
            return 'gemini'; // fallback
        }

        function updateKeyHelpPanel() {
            const provider = getCurrentProvider();
            panelContentKey.innerHTML = keyHelpContent[provider];
            panelContentBilling.innerHTML = billingHelpContent[provider];
        }

        modelSelector.addEventListener('input', () => {
            const isGpt = modelSelector.value.startsWith('gpt');
            const isClaude = modelSelector.value.startsWith('claude');
            googleKeyContainer.classList.toggle('hidden', isGpt || isClaude);
            openaiKeyContainer.classList.toggle('hidden', !(isGpt || isClaude));
            checkAllInputs();
            updateKeyHelpPanel();
        });

        googleApiKeyInput.addEventListener('input', checkAllInputs);
        openaiApiKeyInput.addEventListener('input', checkAllInputs);

        bolUpload.addEventListener('change', async (event) => {
            if (event.target.files.length === 0) return;
            videoFile = event.target.files[0];
            videoFileNameDisplay.textContent = videoFile.name;
            bolPromptText.classList.add('hidden');
            
            // Immediately enable the button if key is present
            checkAllInputs(); 

            bolPreviewContainer.innerHTML = '<div class="text-center col-span-full">Processing Video...</div>';

            try {
                videoFrames = await renderVideoToFrames(videoFile);
                bolPreviewContainer.innerHTML = `
                    <div class="text-center col-span-full p-4">
                        <div class="text-green-600 font-semibold mb-2">âœ“ Video Ready for Analysis</div>
                        <div class="text-sm text-gray-600">${videoFrames.length} frames extracted</div>
                        <div class="text-xs text-gray-500 mt-1">Click "Initiate Yard Auditor" to begin analysis</div>
                    </div>
                `;
            } catch (error) {
                displayMessage(`Error processing video: ${error.message}`);
                bolPreviewContainer.innerHTML = '';
                bolPromptText.classList.remove('hidden');
                videoFileNameDisplay.textContent = '';
                videoFile = null; // Reset the file on failure
                videoFrames = []; // Reset frames
                checkAllInputs(); // Disable button on failure
            }
        });
        
        parseBolBtn.addEventListener('click', handleBolParsing);
        exportBolBtn.addEventListener('click', handleExportBolData);

        howToBtn.addEventListener('click', () => {
            updateKeyHelpPanel();
            sidePanel.classList.remove('translate-x-full');
            sidePanelOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });

        const closePanel = () => {
            sidePanel.classList.add('translate-x-full');
            sidePanelOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        };
        closePanelBtn.addEventListener('click', closePanel);
        sidePanelOverlay.addEventListener('click', closePanel);
        
        // Prompt Panel Listeners
        editBolPromptBtn.addEventListener('click', () => openPromptPanel());

        const openPromptPanel = () => {
            promptSidePanel.classList.remove('translate-x-full');
            promptSidePanelOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        
        const closePromptPanel = () => {
            promptSidePanel.classList.add('translate-x-full');
            promptSidePanelOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        };

        closePromptPanelBtn.addEventListener('click', closePromptPanel);
        promptSidePanelOverlay.addEventListener('click', closePromptPanel);
        saveBolPromptBtn.addEventListener('click', closePromptPanel);
        resetBolPromptBtn.addEventListener('click', () => { bolPromptTextarea.value = defaultBolPrompt; });

        // Side Panel Tab switching
        panelTabKey.addEventListener('click', () => switchSidePanelTab('key'));
        panelTabBilling.addEventListener('click', () => switchSidePanelTab('billing'));
        
        // Modal Listeners
        closeZoomModal.addEventListener('click', () => {
            imageZoomModal.classList.add('hidden');
            imageZoomModal.classList.remove('flex');
        });
        imageZoomModal.addEventListener('click', (e) => {
             if (e.target === imageZoomModal) {
                imageZoomModal.classList.add('hidden');
                imageZoomModal.classList.remove('flex');
            }
        });

        cancelEditBtn.addEventListener('click', () => {
             fieldEditModal.classList.add('hidden');
             fieldEditModal.classList.remove('flex');
        });
        saveEditBtn.addEventListener('click', () => {
            try {
                const fieldId = saveEditBtn.dataset.fieldId;
                const input = document.getElementById('edit-input');
                const targetSpan = document.querySelector(`[data-field-id="${fieldId}"]`);
                if (targetSpan && input) {
                    targetSpan.textContent = input.value || 'N/A';
                }
            } catch(error) {
                console.error("Error saving field:", error);
            } finally {
                fieldEditModal.classList.add('hidden');
                fieldEditModal.classList.remove('flex');
            }
        });
        fieldEditModal.addEventListener('click', (e) => {
             if (e.target === fieldEditModal) {
                fieldEditModal.classList.add('hidden');
                fieldEditModal.classList.remove('flex');
            }
        });

        const printBolBtn = document.getElementById('printBolBtn');
        if (printBolBtn) {
            printBolBtn.addEventListener('click', () => {
                const printContents = bolResultCard.cloneNode(true);
                // Remove carousel/image section if present
                const carousel = printContents.querySelector('#mainCarouselContainer');
                if (carousel) carousel.remove();
                // Remove edit buttons
                printContents.querySelectorAll('[data-action="edit"]').forEach(btn => btn.remove());
                // Remove remove-row and add-row buttons
                printContents.querySelectorAll('.remove-row-btn').forEach(btn => btn.remove());
                const addRowBtn = printContents.querySelector('#addRowBtn');
                if (addRowBtn) addRowBtn.remove();
                // Create a print window
                const printWindow = window.open('', '', 'width=900,height=700');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Print Yard Audit Results</title>
                        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Inter', sans-serif; background: #fff; color: #222; margin: 0; padding: 2rem; }
                            h2 { font-size: 2rem; font-weight: 700; margin-bottom: 2.5rem; }
                            label { font-weight: 600; color: #374151; }
                            .field-block, .mt-1.flex.items-center.p-2.border.bg-gray-50.rounded-md { margin-bottom: 1.1rem !important; }
                            .field-label { display: block; font-size: 1rem; margin-bottom: 0.2rem; color: #555; }
                            .field-value { font-size: 1.1rem; background: #f3f4f6; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
                            .print-section { margin-bottom: 2.5rem; }
                            .section-title { font-size: 1.2rem; font-weight: 600; margin-top: 2.5rem; margin-bottom: 1.2rem; color: #2563eb; }
                            .data-point { margin-bottom: 2.2rem; }
                            table { width: 100%; border-collapse: collapse; margin-top: 2.5rem; margin-bottom: 2.5rem; font-size: 80%; }
                            th, td { border: 1px solid #e5e7eb; padding: 0.6rem 0.8rem; text-align: left; }
                            th { background: #f1f5f9; font-weight: 700; }
                            tr:nth-child(even) { background: #f9fafb; }
                        </style>
                    </head>
                    <body>
                        <h2>Yard Audit Results</h2>
                        ${printContents.innerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
            });
        }

        // --- Core Functions ---
        
        function switchSidePanelTab(tabName) {
            if (tabName === 'key') {
                panelTabKey.classList.add('active');
                panelTabBilling.classList.remove('active');
                panelContentKey.classList.remove('hidden');
                panelContentBilling.classList.add('hidden');
            } else {
                panelTabKey.classList.remove('active');
                panelTabBilling.classList.add('active');
                panelContentKey.classList.add('hidden');
                panelContentBilling.classList.remove('hidden');
            }
        }
        
        function hasApiKey() {
            const model = modelSelector.value;
            const googleKey = googleApiKeyInput.value.trim();
            const openaiKey = openaiApiKeyInput.value.trim();
            return (model.startsWith('gpt') || model.startsWith('claude')) ? !!openaiKey : !!googleKey;
        }

        function checkAllInputs() {
            const hasKey = hasApiKey();
            parseBolBtn.disabled = !(hasKey && videoFile);
        }

        // Remove spinner loader references and add progress bar logic
        // --- Progress Bar Logic ---
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const progressPercent = document.getElementById('progressPercent');

        function setProgress(percent, label) {
            progressBar.style.width = percent + '%';
            progressPercent.textContent = Math.round(percent) + '%';
            progressLabel.textContent = label;
        }

        // --- Update handleBolParsing and PDF rendering to use progress bar ---
        async function handleBolParsing() {
            resetUI();
            loading.classList.remove('hidden');
            setProgress(10, 'Preparing...');

            if (videoFrames.length === 0) {
                displayMessage("Please upload a video and wait for frames to render.");
                loading.classList.add('hidden');
                return;
            }

            const selectedModel = modelSelector.value;

            try {
                setProgress(20, 'Analyzing...');
                const apiKey = getApiKey();
                const prompt = bolPromptTextarea.value;
                let resultText = '';
                const imageParts = videoFrames.map(frameDataUrl => ({
                    inlineData: { mimeType: 'image/jpeg', data: frameDataUrl.split(',')[1] }
                }));

                if (selectedModel.startsWith('gemini')) {
                    setProgress(40, 'Sending to Gemini...');
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }, ...imageParts] }],
                        generationConfig: { "response_mime_type": "application/json" }
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    setProgress(70, 'Processing Gemini Response...');
                    const result = await response.json();
                    resultText = result.candidates[0].content.parts[0].text;
                } else if (selectedModel === 'claude-4') {
                    setProgress(40, 'Sending to Claude 4...');
                    const apiUrl = 'https://api.anthropic.com/v1/messages';
                    const imageContent = videoFrames.map(frameDataUrl => ({
                        type: 'image',
                        source: { type: 'base64', media_type: 'image/jpeg', data: frameDataUrl.split(',')[1] }
                    }));
                    const payload = {
                        model: 'claude-4-opus-20250514',
                        max_tokens: 4096,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'text', text: prompt },
                                    ...imageContent
                                ]
                            }
                        ]
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`Claude 4 API Error: ${response.status} ${await response.text()}`);
                    setProgress(70, 'Processing Claude 4 Response...');
                    const result = await response.json();
                    const textBlock = result.content.find(c => c.type === 'text');
                    if (!textBlock) throw new Error('Claude 4 did not return a text response.');
                    resultText = textBlock.text;
                } else {
                    setProgress(40, 'Sending to OpenAI...');
                    const apiUrl = "https://api.openai.com/v1/chat/completions";
                    const imageContent = videoFrames.map(frameDataUrl => ({
                         type: 'image_url', image_url: { url: frameDataUrl } 
                    }));
                    const payload = {
                        model: selectedModel,
                        response_format: { "type": "json_object" },
                        messages: [{ role: 'user', content: [ { type: 'text', text: prompt }, ...imageContent]}]
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    setProgress(70, 'Processing OpenAI Response...');
                    const result = await response.json();
                    resultText = result.choices[0].message.content;
                }
                setProgress(90, 'Parsing Results...');
                const consolidatedData = JSON.parse(resultText);
                setProgress(100, 'Done');
                displayBolResults(consolidatedData);
                setTimeout(() => { loading.classList.add('hidden'); }, 800);
            } catch (error) {
                displayMessage(error.message);
                setProgress(0, 'Error');
            } finally {
                // loading.classList.add('hidden');
            }
        }

        // Update video rendering to show progress
        async function renderVideoToFrames(file) {
            return new Promise((resolve, reject) => {
                try {
                    setProgress(10, 'Processing Video...');
                    
                    const video = document.createElement('video');
                    video.muted = true;
                    video.crossOrigin = 'anonymous';
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const frames = [];
                    let frameCount = 0;
                    const maxFrames = 100; // Increased to maximum for better quality
                    
                    video.addEventListener('loadedmetadata', () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        const duration = video.duration;
                        const interval = duration / maxFrames;
                        
                        setProgress(20, 'Extracting Frames...');
                        
                        const extractFrame = (currentTime) => {
                            if (frameCount >= maxFrames) {
                                setProgress(40, 'Video Processing Complete');
                                resolve(frames);
                                return;
                            }
                            
                            video.currentTime = currentTime;
                        };
                        
                        video.addEventListener('seeked', () => {
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const frameDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                            frames.push(frameDataUrl);
                            frameCount++;
                            
                            setProgress(20 + Math.round((frameCount/maxFrames)*20), `Extracting Frame ${frameCount} of ${maxFrames}`);
                            
                            if (frameCount < maxFrames) {
                                setTimeout(() => extractFrame(frameCount * interval), 100);
                            } else {
                                setProgress(40, 'Video Processing Complete');
                                resolve(frames);
                            }
                        });
                        
                        // Start extracting frames
                        extractFrame(0);
                    });
                    
                    video.addEventListener('error', (error) => {
                        setProgress(0, 'Error');
                        reject(new Error('Failed to load video file'));
                    });
                    
                    const url = URL.createObjectURL(file);
                    video.src = url;
                    video.load();
                    
                } catch (error) {
                    setProgress(0, 'Error');
                    reject(error);
                }
            });
        }

        function displayBolResults(data) {
            bolResultCard.innerHTML = '';
            currentFrameIndex = 0; // Reset frame index

            // Handle both array and object data structures
            let trailers = [];
            if (Array.isArray(data)) {
                trailers = data;
            } else if (data.trailers) {
                trailers = data.trailers;
            } else if (data.data) {
                trailers = data.data;
            } else {
                // Try to find any array in the data
                for (const key in data) {
                    if (Array.isArray(data[key])) {
                        trailers = data[key];
                        break;
                    }
                }
            }

            // Extract best images for each trailer
            trailerImages = trailers
                .filter(trailer => trailer.image)
                .map(trailer => trailer.image);

            const updateTrailerCarousel = () => {
                const frame = bolResultCard.querySelector('#carouselFrame');
                const frameCounter = bolResultCard.querySelector('#frameCounter');
                if (frame && frameCounter && trailerImages.length > 0) {
                    frame.src = trailerImages[currentFrameIndex];
                    frame.alt = `Trailer ${currentFrameIndex + 1}`;
                    frameCounter.textContent = `${currentFrameIndex + 1} / ${trailerImages.length}`;
                }
                const zoomFrame = document.getElementById('zoomedFrame');
                if(zoomFrame && trailerImages.length > 0) {
                    zoomFrame.src = trailerImages[currentFrameIndex];
                }
            };
            
            const createCarousel = () => {
                const carouselContainer = document.createElement('div');
                carouselContainer.className = 'md:col-span-1 relative';

                const frame = document.createElement('img');
                frame.id = 'carouselFrame';
                frame.src = trailerImages.length > 0 ? trailerImages[0] : '';
                frame.className = 'rounded-lg border shadow-md w-full h-auto cursor-pointer';
                frame.alt = 'Trailer 1';
                frame.addEventListener('click', () => openImageZoomModal());

                const prevBtn = document.createElement('button');
                prevBtn.className = 'absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75';
                prevBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>';
                prevBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentFrameIndex = (currentFrameIndex - 1 + trailerImages.length) % trailerImages.length;
                    updateTrailerCarousel();
                });
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75';
                nextBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>';
                 nextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentFrameIndex = (currentFrameIndex + 1) % trailerImages.length;
                    updateTrailerCarousel();
                });

                const frameCounter = document.createElement('div');
                frameCounter.id = 'frameCounter';
                frameCounter.className = 'absolute bottom-2 left-1/2 -translate-x-1/2 bg-black bg-opacity-70 text-white text-xs font-semibold px-2 py-1 rounded-full';
                
                carouselContainer.append(frame, prevBtn, nextBtn, frameCounter);

                if (trailerImages.length <= 1) {
                    prevBtn.classList.add('hidden');
                    nextBtn.classList.add('hidden');
                }
                
                updateTrailerCarousel();
                return carouselContainer;
            };

            let trailersHtml = `
                    <table class="w-full text-sm mt-1 border-collapse" id="trailersTable">
                        <thead>
                           <tr class="border-b bg-gray-50">
                                <th class="p-2 text-left font-semibold text-gray-700">Trailer ID</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Carrier</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Loaded</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Location</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Type</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Size (ft)</th>
                                <th class="p-2"></th>
                            </tr>
                        </thead>
                        <tbody>
                        ${trailers.map((trailer, idx) => `
                            <tr class="border-b" data-row="${idx}">
                                <td class="p-2 editable-table-cell" data-col="trailer_id">${trailer.trailer_id || 'N/A'}</td>
                                <td class="p-2 editable-table-cell" data-col="carrier">${trailer.carrier || 'N/A'}</td>
                                <td class="p-2 editable-table-cell" data-col="is_loaded">${trailer.is_loaded ? 'Yes' : 'No'}</td>
                                <td class="p-2 editable-table-cell" data-col="location">${trailer.location || 'N/A'}</td>
                                <td class="p-2 editable-table-cell" data-col="trailer_type">${trailer.trailer_type || 'N/A'}</td>
                                <td class="p-2 editable-table-cell" data-col="trailer_size">${trailer.trailer_size || 'N/A'}</td>
                                <td class="p-2 text-center"><button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg" title="Remove row">&minus;</button></td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                    <div class="mt-2 text-right">
                        <button id="addRowBtn" class="bg-blue-100 text-blue-700 font-semibold px-3 py-1 rounded hover:bg-blue-200 transition">+ Add Trailer</button>
                    </div>
            `;

            const mainDiv = document.createElement('div');
            mainDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-6';
            mainDiv.innerHTML = `
                <div class="md:col-span-1">
                    <div id="mainCarouselContainer" class="relative">
                        </div>
                </div>
                <div class="md:col-span-2">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Yard Audit Results</h3>
                        <p class="text-sm text-gray-600">Found ${trailers.length} unique trailers in the yard</p>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Trailers Identified</label>
                        <div class="p-3 bg-gray-50 rounded-lg border mt-1 overflow-x-auto">${trailersHtml}</div>
                    </div>
                </div>
            `;
            bolResultCard.appendChild(mainDiv);
            if (trailerImages.length > 0) {
                bolResultCard.querySelector('#mainCarouselContainer').appendChild(createCarousel());
            }
            
            // Re-attach listeners for dynamically created elements
            bolResultCard.querySelectorAll('#carouselFrame').forEach(frame => {
                 frame.addEventListener('click', () => openImageZoomModal());
            });
            
            resultsWrapper.classList.remove('hidden');
            bolResultContainer.classList.remove('hidden');
            attachTrailersTableListeners();
        }

        function createDisplayField(id, label, value) {
            return `
                <div>
                    <label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label>
                    <div class="mt-1 flex items-center p-2 border bg-gray-50 rounded-md">
                        <span class="text-sm text-gray-900 editable-field" data-field-id="${id}" tabindex="0">${value || 'N/A'}</span>
                    </div>
                </div>`;
        }
        
        function openEditModal(fieldId, fieldLabel, currentValue) {
            editModalTitle.textContent = `Edit ${fieldLabel}`;
            editModalContent.innerHTML = `<textarea id="edit-input" class="w-full rounded-md border-gray-300 shadow-sm" rows="3">${currentValue === 'N/A' ? '' : currentValue}</textarea>`;
            saveEditBtn.dataset.fieldId = fieldId;
            fieldEditModal.classList.remove('hidden');
            fieldEditModal.classList.add('flex');
        }
        
        function openImageZoomModal() {
            // Use trailer images if available, otherwise fall back to video frames
            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
            if (imagesToShow.length > 0) {
                zoomedImage.src = imagesToShow[currentFrameIndex];
            }
            imageZoomModal.classList.remove('hidden');
            imageZoomModal.classList.add('flex');
        }

        zoomPrevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
            if (imagesToShow.length > 0) {
                currentFrameIndex = (currentFrameIndex - 1 + imagesToShow.length) % imagesToShow.length;
                zoomedImage.src = imagesToShow[currentFrameIndex];
                const carouselFrame = bolResultCard.querySelector('#carouselFrame');
                if (carouselFrame) carouselFrame.src = imagesToShow[currentFrameIndex];
                const frameCounter = bolResultCard.querySelector('#frameCounter');
                if (frameCounter) frameCounter.textContent = `${currentFrameIndex + 1} / ${imagesToShow.length}`;
            }
        });
        zoomNextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
            if (imagesToShow.length > 0) {
                currentFrameIndex = (currentFrameIndex + 1) % imagesToShow.length;
                zoomedImage.src = imagesToShow[currentFrameIndex];
                const carouselFrame = bolResultCard.querySelector('#carouselFrame');
                if (carouselFrame) carouselFrame.src = imagesToShow[currentFrameIndex];
                const frameCounter = bolResultCard.querySelector('#frameCounter');
                if (frameCounter) frameCounter.textContent = `${currentFrameIndex + 1} / ${imagesToShow.length}`;
            }
        });

        function handleExportBolData() {
            const card = document.getElementById('bolResultCard');
            if (!card) return;

            const headers = ["Trailer ID", "Carrier", "Loaded", "Location", "Type", "Size (ft)"];
            const rows = [];
            
            const trailerRows = card.querySelectorAll('tbody > tr');
            if (trailerRows.length > 0 && trailerRows[0].cells.length > 1) {
                 trailerRows.forEach(row => {
                    rows.push([
                        row.cells[0] ? row.cells[0].innerText : 'N/A', // Trailer ID
                        row.cells[1] ? row.cells[1].innerText : 'N/A', // Carrier
                        row.cells[2] ? row.cells[2].innerText : 'N/A', // Loaded
                        row.cells[3] ? row.cells[3].innerText : 'N/A', // Location
                        row.cells[4] ? row.cells[4].innerText : 'N/A', // Type
                        row.cells[5] ? row.cells[5].innerText : 'N/A'  // Size
                    ].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
                });
            } else {
                 rows.push(['N/A', 'N/A', 'N/A', 'N/A', 'N/A', 'N/A'].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
            }

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "yard_audit_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function getApiKey() {
            const isGpt = modelSelector.value.startsWith('gpt');
            const isClaude = modelSelector.value.startsWith('claude');
            const key = (isGpt || isClaude) ? openaiApiKeyInput.value.trim() : googleApiKeyInput.value.trim();
            if (!key) throw new Error(`Please provide an ${(isGpt || isClaude) ? 'OpenAI' : 'Google AI'} API Key.`);
            return key;
        }
        
        function resetUI() {
            loading.classList.add('hidden');
            parseBolBtn.disabled = true;
            resultsWrapper.classList.add('hidden');
            messageContainer.classList.add('hidden');
            bolResultContainer.classList.add('hidden');
            setProgress(0, '');
        }
        
        function displayMessage(msg) {
            messageContainer.classList.remove('hidden');
            message.innerText = msg;
        }

        const howToBtnOpenAI = document.getElementById('howToBtnOpenAI');
        if (howToBtnOpenAI) {
            howToBtnOpenAI.addEventListener('click', () => {
                updateKeyHelpPanel();
                sidePanel.classList.remove('translate-x-full');
                sidePanelOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('editable-field')) {
                const span = e.target;
                const currentValue = span.textContent === 'N/A' ? '' : span.textContent;
                const input = document.createElement(span.dataset.fieldId === 'origin' || span.dataset.fieldId === 'destination' ? 'textarea' : 'input');
                input.value = currentValue;
                input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                input.style.minHeight = span.dataset.fieldId === 'origin' || span.dataset.fieldId === 'destination' ? '2.5em' : '';
                input.addEventListener('blur', function() {
                    span.textContent = input.value || 'N/A';
                    span.style.display = '';
                    input.replaceWith(span);
                });
                input.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter' && input.tagName !== 'TEXTAREA') {
                        input.blur();
                    }
                });
                span.parentNode.replaceChild(input, span);
                input.focus();
                input.select();
            }
            // Table cell editing
            if (e.target.classList.contains('editable-table-cell')) {
                const td = e.target;
                const currentValue = td.textContent === 'N/A' ? '' : td.textContent;
                const input = document.createElement('input');
                input.value = currentValue;
                input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                input.addEventListener('blur', function() {
                    td.textContent = input.value || 'N/A';
                    td.style.display = '';
                    input.replaceWith(td);
                });
                input.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter') {
                        input.blur();
                    }
                });
                td.parentNode.replaceChild(input, td);
                input.focus();
                input.select();
            }
            // Add row
            if (e.target.id === 'addRowBtn') {
                const table = document.getElementById('trailersTable').getElementsByTagName('tbody')[0];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2 editable-table-cell" data-col="trailer_id">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="carrier">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="is_loaded">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="location">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="trailer_type">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="trailer_size">N/A</td>
                    <td class="p-2 text-center"><button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg" title="Remove row">&minus;</button></td>
                `;
                table.appendChild(row);
            }
            // Remove row
            if (e.target.classList.contains('remove-row-btn')) {
                const row = e.target.closest('tr');
                row.parentNode.removeChild(row);
            }
        });

        function attachTrailersTableListeners() {
            const table = document.getElementById('trailersTable');
            if (!table) return;
            // Remove any previous event listeners by cloning
            const newTable = table.cloneNode(true);
            table.parentNode.replaceChild(newTable, table);
            // Use only event delegation on the table
            newTable.addEventListener('click', function(e) {
                if (e.target.classList.contains('editable-table-cell')) {
                    const td = e.target;
                    const currentValue = td.textContent === 'N/A' ? '' : td.textContent;
                    const input = document.createElement('input');
                    input.value = currentValue;
                    input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                    input.addEventListener('blur', function() {
                        td.textContent = input.value || 'N/A';
                        td.style.display = '';
                        input.replaceWith(td);
                    });
                    input.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter') {
                            input.blur();
                        }
                    });
                    td.parentNode.replaceChild(input, td);
                    input.focus();
                    input.select();
                }
                if (e.target.classList.contains('remove-row-btn')) {
                    const row = e.target.closest('tr');
                    row.parentNode.removeChild(row);
                }
                if (e.target.id === 'addRowBtn') {
                    const tbody = newTable.getElementsByTagName('tbody')[0];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2 editable-table-cell" data-col="trailer_id">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="carrier">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="is_loaded">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="location">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="trailer_type">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="trailer_size">N/A</td>
                        <td class="p-2 text-center"><button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg" title="Remove row">&minus;</button></td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // Hide AI config section initially and toggle on triple-click of logo
        const aiConfigSection = document.getElementById('aiConfigSection');
        const vectorLogo = document.getElementById('vectorLogo');
        let logoClickCount = 0;
        let logoClickTimer = null;
        function toggleAIConfigSection() {
            aiConfigSection.classList.toggle('hidden');
        }
        vectorLogo.addEventListener('click', function() {
            logoClickCount++;
            if (logoClickTimer) clearTimeout(logoClickTimer);
            logoClickTimer = setTimeout(() => { logoClickCount = 0; }, 1000);
            if (logoClickCount === 3) {
                toggleAIConfigSection();
                logoClickCount = 0;
            }
        });

    </script>
</body>
</html>
