<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Camera Vision: Yard Auditor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-google-sans {
            font-family: 'Roboto', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #message {
            white-space: pre-wrap;
            text-align: left;
            background-color: #fef2f2;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
            color: #b91c1c;
        }
        .translate-x-full {
             transform: translateX(100%);
        }
        .side-panel-tab.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .editable-field {
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
            border-radius: 0.375rem;
            padding: 0.15em 0.35em;
        }
        .editable-field:hover, .editable-field:focus {
            background: #e0e7ff;
            border: 1px solid #6366f1;
            outline: none;
        }
        .editable-input:focus {
            background: #eef2ff;
            border: 1.5px solid #6366f1;
            outline: none;
        }
        .editable-table-cell {
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
            border-radius: 0.375rem;
        }
        .editable-table-cell:hover, .editable-table-cell:focus {
            background: #e0e7ff;
            border: 1px solid #6366f1;
            outline: none;
        }
        .field-block, .mt-1.flex.items-center.p-2.border.bg-gray-50.rounded-md { margin-bottom: 1.1rem !important; }
         html, body { overflow-x: hidden; }
         /* allow native scroll anchoring for iOS Safari stability */
         /* #mobileCardsContainer { overflow-anchor: none; } */
         /* Improve mobile tap targets and spacing */
         @media (max-width: 420px) {
             .container { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
             .max-w-6xl { border-radius: 0; box-shadow: none; padding: 1rem !important; }
             header .text-3xl { font-size: 1.5rem; }
             #trailersTable th, #trailersTable td { padding: 0.5rem 0.5rem; }
             #trailersTable { font-size: 0.875rem; }
         }
        @media (max-width: 420px) {
            label[for="bolUpload"] { min-height: 12rem !important; padding: 1rem !important; }
            #progressLabel, #progressDots { font-size: 1rem !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
            <header id="mainHeader" class="mb-8">
                <div class="flex items-center justify-between relative mb-6">
                    <div class="flex-1"></div>
                    <img id="vectorLogo" src="https://cdn-eblmdf.nitrocdn.com/vVuBUVEtyJTDzFmiTWcmAlTgwfLlYdtZ/assets/images/optimized/rev-4420213/www.withvector.com/wp-content/uploads/2024/09/vector-logo.png" alt="Vector Logo" style="height:38px; width:auto; margin-right:8px;" class="rounded-lg shadow-sm hover:scale-105 transition-transform duration-200 cursor-pointer" />
                </div>
                <div class="text-center mt-2">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 font-google-sans">Camera Vision: Yard Auditor</h1>
                    <p class="mt-2 text-gray-600">Upload a yard video, and the AI will analyze the footage to catalog every unique trailer present.</p>
                </div>
            </header>

            <div id="aiConfigSection" class="space-y-6 hidden">
                 <div>
                    <div class="flex items-center justify-between mb-2">
                        <label for="modelSelector" class="block text-lg font-medium text-gray-700 font-google-sans">Choose AI Model</label>
                        <button id="editBolPromptBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors ml-4">Edit Prompt</button>
                    </div>
                    <select id="modelSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                        <option value="gemini-2.5-pro" selected>Gemini 2.5 Pro</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gpt-5">OpenAI GPT-5</option>
                        <option value="claude-4">Claude 4</option>
                    </select>
                </div>
                <div id="googleKeyContainer">
                    <div class="flex items-center justify-between mb-2">
                         <label for="googleApiKeyInput" class="block text-lg font-medium text-gray-700 font-google-sans">Google AI API Key</label>
                         <button id="howToBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">How to get a key?</button>
                    </div>
                    <input type="password" id="googleApiKeyInput" placeholder="Enter your Google AI API Key" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div id="openaiKeyContainer" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <label for="openaiApiKeyInput" class="block text-lg font-medium text-gray-700 font-google-sans">OpenAI API Key</label>
                        <button id="howToBtnOpenAI" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">How to get a key?</button>
                    </div>
                    <input type="password" id="openaiApiKeyInput" placeholder="Enter your OpenAI API Key" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                
                <div id="apiDataSourceSection">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-lg font-medium text-gray-700 font-google-sans">API Data Source for Comparison</label>
                    </div>
                    <div class="space-y-4 p-4 border rounded-lg bg-gray-50">
                        <div>
                            <label for="apiEndpointInput" class="block text-sm font-medium text-gray-600">API Endpoint</label>
                            <input type="text" id="apiEndpointInput" value="https://api.withvector-demo.com/1.0/entities/query?DEBUG=view--Trailers" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label for="mainBearerTokenInput" class="block text-sm font-medium text-gray-600">Bearer Token</label>
                            <input type="password" id="mainBearerTokenInput" value="2f3fc620c121ca8478d147c870ef19d7" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    </div>
                </div>
            </div>

            <div id="bolContent">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-lg font-medium text-gray-700 font-google-sans">Upload Yard Video</label>
                </div>
                 <label for="bolUpload" class="flex flex-col items-center justify-center w-full min-h-[16rem] border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition p-4">
                     <div id="bol-prompt-text" class="flex flex-col items-center justify-center text-center">
                         <svg class="w-10 h-10 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                         <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload a video</span></p>
                         <p id="videoFileName" class="text-sm text-green-600 font-semibold mt-2"></p>
                     </div>
                     <div id="bol-preview-container" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-4"></div>
                     <input id="bolUpload" type="file" class="hidden" accept="video/*"/>
                     <input id="cameraCapture" type="file" class="hidden" accept="video/*" capture="environment"/>
                 </label>
                <div class="text-center mt-2 hidden"></div>
                <div class="text-center mt-4 md:mt-8 mb-2">
                    <button id="parseBolBtn" disabled class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed w-full sm:w-auto">Initiate Yard Auditor</button>
                </div>
                <div class="text-center mb-6 md:mb-8">
                    <p id="buildInfo" class="text-xs text-gray-500">Loading version infoâ€¦</p>
                </div>
            </div>

        </div>
    </div>
    
    <div id="loading" class="text-center my-4 hidden">
        <div class="w-full max-w-2xl mx-auto">
            <div class="flex items-center justify-center mb-2">
                <span id="progressLabel" class="text-lg md:text-xl font-semibold text-blue-600">Uploading Video</span>
                <span id="progressDots" class="text-lg md:text-xl font-semibold text-blue-600 ml-1">...</span>
            </div>
            <div class="w-full bg-blue-100 rounded-full h-6 relative overflow-hidden">
                <div id="progressBar" class="h-6 bg-blue-500 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
            </div>
            
        </div>
    </div>
    <div id="messageContainer" class="hidden">
         <div id="message" class="text-red-600 font-medium"></div>
    </div>
    
    <div id="resultsWrapper" class="hidden">
         <div id="bolResultContainer" class="hidden mt-6">
             <div class="flex flex-col items-center mb-4">
                 <h2 class="text-2xl font-bold text-gray-800 font-google-sans mb-4">Yard Audit Results</h2>
                 <div id="resultsActionBar" class="sticky top-0 z-40 w-full bg-white/95 backdrop-blur supports-[backdrop-filter]:backdrop-blur border-b border-gray-200 py-2">
                     <div class="max-w-6xl mx-auto px-2 sm:px-0">
                         <div class="grid grid-cols-2 sm:flex sm:flex-wrap justify-center gap-2">
                             <button id="newAuditBtn" class="w-full sm:w-auto justify-center bg-gray-100 text-gray-800 hover:text-gray-900 hover:bg-gray-200 font-medium py-2 px-3 sm:py-2 sm:px-4 rounded-md transition duration-200 shadow-sm flex items-center gap-1.5 text-xs sm:text-sm">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-ccw"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 4v8h8"/></svg>
                             New Audit
                             </button>
                             <button id="printBolBtn" class="w-full sm:w-auto justify-center bg-green-600 text-white font-medium py-2 px-3 sm:py-2 sm:px-4 rounded-md hover:bg-green-700 transition duration-200 shadow-sm flex items-center gap-1.5 text-xs sm:text-sm">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><rect x="6" y="13" width="12" height="8" rx="2"/><path d="M6 17h0"/></svg>
                         Print
                             </button>
                             <button id="exportBolBtn" class="w-full sm:w-auto justify-center bg-indigo-600 text-white font-medium py-2 px-3 sm:py-2 sm:px-4 rounded-md hover:bg-indigo-700 transition duration-200 shadow-sm flex items-center gap-1.5 text-xs sm:text-sm">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                         Export
                             </button>
                             <button id="showRawResultsBtn" class="w-full sm:w-auto justify-center bg-orange-600 text-white font-medium py-2 px-3 sm:py-2 sm:px-4 rounded-md hover:bg-orange-700 transition duration-200 shadow-sm flex items-center gap-1.5 text-xs sm:text-sm">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                         Raw
                             </button>
                             <button id="compareYardBtn" class="w-full sm:w-auto justify-center bg-purple-600 text-white font-medium py-2 px-3 sm:py-2 sm:px-4 rounded-md hover:bg-purple-700 transition duration-200 shadow-sm flex items-center gap-1.5 text-xs sm:text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-git-compare"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><path d="M6 9V6a2 2 0 0 1 2-2h7"/></svg>
                          Compare
                             </button>
                             <button id="shareBtn" class="w-full sm:w-auto justify-center bg-teal-600 text-white font-medium py-2 px-3 sm:py-2 sm:px-4 rounded-md hover:bg-teal-700 transition duration-200 shadow-sm flex items-center gap-1.5 text-xs sm:text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                          Share
                             </button>
                         </div>
                         
                     </div>
                 </div>
             </div>
            <div id="bolResultCard" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                </div>
        </div>
    </div>

    <div id="sidePanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="sidePanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-google-sans font-bold">API Key Help</h2>
                <button id="closePanelBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
             <div class="border-b border-gray-200">
                <nav class="flex" aria-label="Side Panel Tabs">
                    <button id="panelTabKey" class="side-panel-tab active flex-1 border-b-2 py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Get API Key</button>
                    <button id="panelTabBilling" class="side-panel-tab flex-1 border-b-2 border-transparent py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Enable Billing</button>
                </nav>
            </div>
            <div id="panelContentKey" class="p-6 overflow-y-auto flex-grow">
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google AI Studio</h3>
                        <p class="mb-3 text-sm">Navigate to <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com</a> and sign in with your Google account.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-1.png" alt="Google AI Studio Homepage" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Get API Key</h3>
                        <p class="mb-3 text-sm">Once in AI Studio, click <b>"Get API key"</b> from the left-hand menu.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-2.png" alt="Get API Key button" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Create API key in a new project</h3>
                        <p class="mb-3 text-sm">A dialog will appear. Click on <b>"Create API key in new project"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-3.png" alt="Create API Key in new project" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Copy Your Key</h3>
                        <p class="mb-3 text-sm">Your new API key will be displayed. Click the copy icon to copy the key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-4.png" alt="Copy new API key" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 5: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "Google AI API Key" input field.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-5.png" alt="Paste key into the application" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            </div>
            <div id="panelContentBilling" class="p-6 overflow-y-auto flex-grow hidden">
                 <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google Cloud Console</h3>
                        <p class="mb-3 text-sm">Navigate to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a> and select the project associated with your API key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-1.png" alt="Google Cloud Console" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Open Billing Menu</h3>
                        <p class="mb-3 text-sm">Click the main navigation menu (hamburger icon) and select <b>"Billing"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-2.png" alt="Billing Menu" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Link a Billing Account</h3>
                        <p class="mb-3 text-sm">If your project doesn't have a billing account, you'll see a prompt to <b>"Link a billing account"</b>. Click it. If you need to create one, select <b>"Manage billing accounts"</b> and then <b>"Create account"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-3.png" alt="Link billing account" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Set Up Payment</h3>
                        <p class="mb-3 text-sm">Follow the on-screen instructions to provide your payment information and complete the setup.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-4.png" alt="Payment information" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="promptSidePanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="promptSidePanel" class="fixed top-0 right-0 h-full w-full max-w-lg bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-google-sans font-bold">Edit Prompt</h2>
                <button id="closePromptPanelBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
            <div id="promptPanelContentBol" class="p-6 overflow-y-auto flex-grow flex flex-col">
                <label for="bolPromptTextarea" class="font-semibold mb-2">Bill of Lading Prompt</label>
                <textarea id="bolPromptTextarea" class="w-full flex-grow p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"></textarea>
                 <div class="mt-4 flex gap-4">
                     <button id="saveBolPromptBtn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Save</button>
                     <button id="resetBolPromptBtn" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Reset to Default</button>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="imageZoomModal" class="hidden fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-[100] p-4">
        <button id="closeZoomModal" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
        <button id="zoomPrevBtn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
        <img id="zoomedImage" src="" class="max-w-full max-h-full">
         <button id="zoomNextBtn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
        <div id="framePicker" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black bg-opacity-60 text-white rounded-md px-2 py-1 text-xs hidden"></div>
    </div>

    <div id="fieldEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[100]">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="editModalTitle" class="text-lg font-bold mb-4">Edit Field</h3>
            <div id="editModalContent">
                </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancelEditBtn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button id="saveEditBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <div id="rawResultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Raw Model Results</h3>
                <button id="closeRawResultsBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
            <div id="rawResultsContent" class="flex-1 overflow-auto bg-gray-50 p-4 rounded-lg font-mono text-sm">
                <pre id="rawResultsText" class="whitespace-pre-wrap"></pre>
            </div>
            <div class="mt-4 flex justify-end gap-4">
                <button id="copyRawResultsBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copy
                </button>
                <button id="closeRawResultsBtn2" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div id="compareYardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Compare Against Previous Yard State</h3>
                <button id="closeCompareYardBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-auto">
                <!-- Upload Section -->
                <div id="compareUploadSection" class="mb-6">
                    <h4 class="text-lg font-semibold mb-3">Choose Comparison Method</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 border rounded-lg bg-blue-50">
                            <h5 class="font-semibold text-blue-800 mb-3">Compare Against API</h5>
                            <p class="text-sm text-gray-600 mb-3">Fetch live data from the Vector API for comparison</p>
                            <button id="fetchCompareBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-sm">
                                Fetch & Compare
                            </button>
                        </div>
                        <div class="p-4 border rounded-lg bg-green-50">
                            <h5 class="font-semibold text-green-800 mb-3">Upload CSV File</h5>
                            <p class="text-sm text-gray-600 mb-3">Upload a CSV file with trailer data for comparison</p>
                            <label for="compareCsvUpload" class="w-full inline-block text-center py-2 px-4 bg-green-600 text-white rounded-lg cursor-pointer hover:bg-green-700 transition">
                                Upload CSV
                            </label>
                            <input type="file" id="compareCsvUpload" class="hidden" accept=".csv">
                            <p id="csvFileName" class="text-sm text-green-600 font-semibold mt-2"></p>
                        </div>
                    </div>
                    <div id="comparisonApiStatus" class="mt-4 text-center"></div>
                </div>

                <!-- Comparison Results -->
                <div id="comparisonResults" class="hidden">
                    <h4 class="text-lg font-semibold mb-3">Comparison Results</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M5 13l4 4L19 7"/></svg>
                                <span class="font-semibold text-green-800">Added</span>
                            </div>
                            <div id="addedCount" class="text-2xl font-bold text-green-600">0</div>
                            <div class="text-sm text-green-700">New trailers</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                <span class="font-semibold text-red-800">Removed</span>
                            </div>
                            <div id="removedCount" class="text-2xl font-bold text-red-600">0</div>
                            <div class="text-sm text-red-700">Missing trailers</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M9 12l2 2 4-4"/></svg>
                                <span class="font-semibold text-blue-800">Remaining</span>
                            </div>
                            <div id="remainingCount" class="text-2xl font-bold text-blue-600">0</div>
                            <div class="text-sm text-blue-700">Still in yard</div>
                        </div>
                    </div>

                    <!-- Detailed Results Tables -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div>
                            <h5 class="font-semibold text-green-800 mb-2">Added Trailers</h5>
                            <div id="addedTrailers" class="bg-green-50 border border-green-200 rounded-lg p-3 max-h-64 overflow-y-auto">
                                <p class="text-sm text-green-700 text-center">No new trailers found</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="font-semibold text-red-800 mb-2">Removed Trailers</h5>
                            <div id="removedTrailers" class="bg-red-50 border border-red-200 rounded-lg p-3 max-h-64 overflow-y-auto">
                                <p class="text-sm text-red-700 text-center">No trailers removed</p>
                            </div>
                        </div>
                        <div>
                            <h5 class="font-semibold text-blue-800 mb-2">Remaining Trailers</h5>
                            <div id="remainingTrailers" class="bg-blue-50 border border-blue-200 rounded-lg p-3 max-h-64 overflow-y-auto">
                                <p class="text-sm text-blue-700 text-center">No trailers remaining</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end gap-4">
                        <button id="exportComparisonBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out shadow-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Export Comparison
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        // DOM Elements
        const modelSelector = document.getElementById('modelSelector');
        const googleKeyContainer = document.getElementById('googleKeyContainer');
        const openaiKeyContainer = document.getElementById('openaiKeyContainer');
        const googleApiKeyInput = document.getElementById('googleApiKeyInput');
        const openaiApiKeyInput = document.getElementById('openaiApiKeyInput');
        const loading = document.getElementById('loading');
        const messageContainer = document.getElementById('messageContainer');
        const message = document.getElementById('message');
        const resultsWrapper = document.getElementById('resultsWrapper');
        
        // BoL Elements
        const bolUpload = document.getElementById('bolUpload');
        const bolPromptText = document.getElementById('bol-prompt-text');
        const videoFileNameDisplay = document.getElementById('videoFileName');
        const bolPreviewContainer = document.getElementById('bol-preview-container');
        const parseBolBtn = document.getElementById('parseBolBtn');
        const bolResultContainer = document.getElementById('bolResultContainer');
        const exportBolBtn = document.getElementById('exportBolBtn');
        const bolResultCard = document.getElementById('bolResultCard');

        // Modal Elements
        const imageZoomModal = document.getElementById('imageZoomModal');
        const zoomedImage = document.getElementById('zoomedImage');
        const closeZoomModal = document.getElementById('closeZoomModal');
        const zoomPrevBtn = document.getElementById('zoomPrevBtn');
        const zoomNextBtn = document.getElementById('zoomNextBtn');
        const fieldEditModal = document.getElementById('fieldEditModal');
        const editModalTitle = document.getElementById('editModalTitle');
        const editModalContent = document.getElementById('editModalContent');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');

        // Raw Results Modal Elements
        const rawResultsModal = document.getElementById('rawResultsModal');
        const rawResultsText = document.getElementById('rawResultsText');
        const showRawResultsBtn = document.getElementById('showRawResultsBtn');
        const closeRawResultsBtn = document.getElementById('closeRawResultsBtn');
        const closeRawResultsBtn2 = document.getElementById('closeRawResultsBtn2');
        const copyRawResultsBtn = document.getElementById('copyRawResultsBtn');
        
        // Comparison Modal Elements
        const compareYardBtn = document.getElementById('compareYardBtn');
        const compareYardModal = document.getElementById('compareYardModal');
        const closeCompareYardBtn = document.getElementById('closeCompareYardBtn');
        const compareImageUpload = document.getElementById('compareImageUpload');
        const compareCsvUpload = document.getElementById('compareCsvUpload');
        const runComparisonBtn = document.getElementById('runComparisonBtn');
        const comparisonResults = document.getElementById('comparisonResults');
        const exportComparisonBtn = document.getElementById('exportComparisonBtn');
        
        let rawModelResponse = ''; // Store the raw response from the model
        let currentTrailers = []; // Store current trailer data for comparison
        let previousTrailers = []; // Store previous trailer data for comparison

        // Side Panel Elements
        const howToBtn = document.getElementById('howToBtn');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const panelTabKey = document.getElementById('panelTabKey');
        const panelTabBilling = document.getElementById('panelTabBilling');
        const panelContentKey = document.getElementById('panelContentKey');
        const panelContentBilling = document.getElementById('panelContentBilling');
        
        // Prompt Panel Elements
        const editBolPromptBtn = document.getElementById('editBolPromptBtn');
        const promptSidePanelOverlay = document.getElementById('promptSidePanelOverlay');
        const promptSidePanel = document.getElementById('promptSidePanel');
        const closePromptPanelBtn = document.getElementById('closePromptPanelBtn');
        const promptPanelContentBol = document.getElementById('promptPanelContentBol');
        const bolPromptTextarea = document.getElementById('bolPromptTextarea');
        const saveBolPromptBtn = document.getElementById('saveBolPromptBtn');
        const resetBolPromptBtn = document.getElementById('resetBolPromptBtn');
        
        let videoFile = null;
        let videoFrames = [];
        let frameTimestamps = []; // Store timestamps for each frame
        let currentFrameIndex = 0;
        let trailerImages = []; // Global variable for trailer images
        let trailerImageFrameNumbers = []; // Parallel array of frame numbers for trailerImages
        let videoDuration = 0; // Store video duration
        let lastAuditDurationText = '';
        let wakeLock = null; // Screen Wake Lock while running

        async function acquireWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    document.addEventListener('visibilitychange', async () => {
                        try {
                            if (document.visibilityState === 'visible' && !wakeLock) {
                                wakeLock = await navigator.wakeLock.request('screen');
                            }
                        } catch (_) {}
                    }, { passive: true });
                }
            } catch (err) {
                console.warn('WakeLock not available', err);
            }
        }

        function releaseWakeLock() {
            try { if (wakeLock && wakeLock.release) wakeLock.release(); } catch (_) {}
            wakeLock = null;
        }

        const defaultBolPrompt = `You are LOGOS (Logistics Observation and Guidance System), an advanced AI agent specializing in real-time visual analysis of logistics environments. Your sole function is to process visual data (images or video frames) of a truck yard and act as a meticulous digital manifest creator.

## Primary Objective
Your primary objective is to identify every unique semi-trailer within the provided visual data and compile a comprehensive JSON manifest according to the strict schema and protocol defined below.

## JSON Schema & Field Definitions
You must provide the information for each unique trailer as an object within a single JSON array. Adhere precisely to these field definitions. In addition to the core fields, include confidence scores and supporting metadata as described below. Extra fields are allowed but the response must still be a JSON array of per-trailer objects:

trailer_id: (String|null) The primary alphanumeric tracking number on the trailer.
CRITICAL: This is the unique identifier. It must NOT include trailer dimensions (e.g., "53'").
PRIORITY: Locate the main registration or unit number (e.g., UMLZ 548231, XTRZ 123456, JBHT 789101).
ACCURACY: Be extremely conservative. If any character is ambiguous (e.g., O/0, I/1, S/5, B/8), do not guess. If certainty is < 0.8, set trailer_id to null.
ACTION: Use multiple frames to confirm the exact characters via majority voting across frames where the ID region is visible.

carrier: (String|null) The name of the operating trucking company.
ACTION: Identify this from logos or text on the trailer. Prioritize the operating carrier name (e.g., "Swift", "J.B. Hunt") over the trailer manufacturer name (e.g., "Wabash", "Great Dane").

location: (String|null) A precise string describing the trailer's position.
ACTION: Prioritize loading dock numbers first (e.g., "Door 42"). If not at a dock, use parking space numbers (e.g., "Spot B17") or a descriptive location (e.g., "North Fence Line"). Choose a location only if the same label is consistently closest to the trailer across multiple frames; if there is any ambiguity between adjacent spots (e.g., off-by-one), return null.

trailer_type: (String|null) A controlled vocabulary string.
ACTION: Must be one of: "Dry Van", "Reefer", "Flatbed", "Tanker", "Intermodal Chassis", or "Other". A "Reefer" is distinguished by a large refrigeration unit on its front face.

trailer_size: (Number|null) The length of the trailer in feet.
ACTION: Look for explicit numerical markings like 53 or 48 on the trailer body. Return the value as a number (e.g., 53), not a string.

image_identifier: (Number) The single best frame number that provides the clearest ID view.
ACTION: Return the extracted frame that shows the clearest, most readable view of the trailer_id. This is NOT a timestamp - it is the sequential frame number from the video processing (frame 1, frame 2, frame 3, etc.). Choose the frame where the trailer identification is most legible and complete. NOTE: It is perfectly acceptable for multiple trailers to use the same frame number if they appear in the same frame.

Additional Recommended Fields (optional but preferred)
- id_confidence: (Number 0..1) Confidence that trailer_id is exactly correct. If < 0.8, set trailer_id to null.
- location_confidence: (Number 0..1) Confidence that the chosen location is exactly correct. If < 0.8, set location to null.
- supporting_frame_identifiers: (Array<Number>) Up to 3 additional frame numbers that also show this trailer clearly.
- id_bbox: (Array<Number>) [x, y, w, h] for the ID region as normalized coordinates (0..1), if visible.
- location_candidates: (Array<String>) Nearby/adjacent location labels considered when choosing the final location.

## Core Operational Protocol

Stateful Tracking & De-duplication: The trailer_id is the unique key. Instead of analyzing frames in isolation, you must maintain a state. Track each candidate trailer across frames, perform majority voting on each character of the ID to avoid O/0, I/1, S/5, B/8 confusions, and select the best frame for readability. Only report each unique trailer_id once in the final output. If no ID can be confirmed with high confidence, skip the trailer.

Processing Rate (For Video): You must process the visual data at a rate of at least 10 frames per second to ensure no trailer is missed.

Confidence & Null Values: Accuracy is paramount. If a piece of information cannot be determined with high confidence from the visual data, you must use a null value for that specific field. Do not infer or guess information that is not visually present.

## CRITICAL OUTPUT CONSTRAINT
Your entire response MUST be a single, raw JSON array.

DO NOT include any introductory text (e.g., "Here is the JSON...").
DO NOT include any concluding remarks or explanations.
DO NOT wrap the JSON in markdown code fences (like \`\`\`json).
The very first character of your output must be [ and the very last character must be ].`;

        const defaultGoogleApiKey = "AIzaSyDe0pVIFyKI_SiTpVMlpbt1Gtdg3uF9WbU";
        googleApiKeyInput.value = defaultGoogleApiKey;
        // Note: For security, do not hardcode OpenAI keys in client code. Leave empty by default.
        // const defaultOpenAIKey = "";
        // openaiApiKeyInput.value = defaultOpenAIKey;

        bolPromptTextarea.value = defaultBolPrompt;

        // --- Dynamic API Key Help Content ---
        const keyHelpContent = {
            gemini: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google AI Studio</h3>
                        <p class="mb-3 text-sm">Navigate to <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com</a> and sign in with your Google account.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-1.png" alt="Google AI Studio Homepage" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Get API Key</h3>
                        <p class="mb-3 text-sm">Once in AI Studio, click <b>"Get API key"</b> from the left-hand menu.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-2.png" alt="Get API Key button" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Create API key in a new project</h3>
                        <p class="mb-3 text-sm">A dialog will appear. Click on <b>"Create API key in new project"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-3.png" alt="Create API Key in new project" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Copy Your Key</h3>
                        <p class="mb-3 text-sm">Your new API key will be displayed. Click the copy icon to copy the key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-4.png" alt="Copy new API key" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 5: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "Google AI API Key" input field.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-5.png" alt="Paste key into the application" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            `,
            gpt: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to OpenAI Platform</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">platform.openai.com/api-keys</a> and sign in with your OpenAI account.</p>
                        <img src="https://platform.openai.com/static/images/api-keys.png" alt="OpenAI API Keys" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Create a New API Key</h3>
                        <p class="mb-3 text-sm">Click <b>"Create new secret key"</b>. Name your key and copy it. <b>Store it securely</b> as you won't be able to see it again.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "OpenAI API Key" input field.</p>
                    </div>
                </div>
            `,
            claude: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Anthropic Console</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://console.anthropic.com/account/keys" target="_blank" class="text-blue-600 hover:underline">console.anthropic.com/account/keys</a> and sign in or create an Anthropic account.</p>
                        <img src="https://placehold.co/600x300/e2e8f0/334155?text=Anthropic+Console" alt="Anthropic Console" class="rounded-lg border shadow-sm">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Create an API Key</h3>
                        <p class="mb-3 text-sm">Click <b>"Create Key"</b>, give it a name, and copy the key. <b>Store it securely</b> as you won't be able to see it again.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "OpenAI API Key" input field (used for Claude as well).</p>
                    </div>
                </div>
            `
        };

        const billingHelpContent = {
            gemini: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google Cloud Console</h3>
                        <p class="mb-3 text-sm">Navigate to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a> and select the project associated with your API key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-1.png" alt="Google Cloud Console" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Open Billing Menu</h3>
                        <p class="mb-3 text-sm">Click the main navigation menu (hamburger icon) and select <b>"Billing"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-2.png" alt="Billing Menu" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Link a Billing Account</h3>
                        <p class="mb-3 text-sm">If your project doesn't have a billing account, you'll see a prompt to <b>"Link a billing account"</b>. Click it. If you need to create one, select <b>"Manage billing accounts"</b> and then <b>"Create account"</b>.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-3.png" alt="Link billing account" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Set Up Payment</h3>
                        <p class="mb-3 text-sm">Follow the on-screen instructions to provide your payment information and complete the setup.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-4.png" alt="Payment information" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            `,
            gpt: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to OpenAI Billing</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://platform.openai.com/account/billing/overview" target="_blank" class="text-blue-600 hover:underline">platform.openai.com/account/billing/overview</a> and sign in.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Add a Payment Method</h3>
                        <p class="mb-3 text-sm">Click <b>"Add payment method"</b> and follow the instructions to add your credit card or other payment method.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Set Usage Limits (Optional)</h3>
                        <p class="mb-3 text-sm">You can set usage limits to control your spending in the <b>"Usage limits"</b> tab.</p>
                    </div>
                </div>
            `,
            claude: `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Anthropic Console Billing</h3>
                        <p class="mb-3 text-sm">Visit <a href="https://console.anthropic.com/account/billing" target="_blank" class="text-blue-600 hover:underline">console.anthropic.com/account/billing</a> and sign in.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Add a Payment Method</h3>
                        <p class="mb-3 text-sm">Click <b>"Add payment method"</b> and follow the instructions to add your credit card or other payment method.</p>
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Review Usage and Limits</h3>
                        <p class="mb-3 text-sm">Monitor your usage and set limits as needed to control your spending.</p>
                    </div>
                </div>
            `
        };

        function getCurrentProvider() {
            const val = modelSelector.value;
            if (val.startsWith('gemini')) return 'gemini';
            if (val.startsWith('gpt')) return 'gpt';
            if (val.startsWith('claude')) return 'claude';
            return 'gemini'; // fallback
        }

        function updateKeyHelpPanel() {
            const provider = getCurrentProvider();
            panelContentKey.innerHTML = keyHelpContent[provider];
            panelContentBilling.innerHTML = billingHelpContent[provider];
        }

        modelSelector.addEventListener('input', () => {
            const isGpt = modelSelector.value.startsWith('gpt');
            const isClaude = modelSelector.value.startsWith('claude');
            googleKeyContainer.classList.toggle('hidden', isGpt || isClaude);
            openaiKeyContainer.classList.toggle('hidden', !(isGpt || isClaude));
            checkAllInputs();
            updateKeyHelpPanel();
        });

        googleApiKeyInput.addEventListener('input', checkAllInputs);
        openaiApiKeyInput.addEventListener('input', checkAllInputs);

        bolUpload.addEventListener('change', async (event) => {
            if (event.target.files.length === 0) return;
            videoFile = event.target.files[0];
            videoFileNameDisplay.textContent = videoFile.name;
            bolPromptText.classList.add('hidden');
            
            // Immediately enable the button if key is present
            checkAllInputs(); 

            bolPreviewContainer.innerHTML = `
                    <div class="text-center col-span-full p-4">
                        <div class="text-base md:text-lg font-semibold text-blue-600 mb-2">Processing Video...</div>
                        <div class="w-full bg-blue-100 rounded-full h-3 relative overflow-hidden mb-2">
                            <div id="videoProgressBar" class="h-3 bg-blue-500 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
                        </div>
                        <div id="videoProgressText" class="text-xs sm:text-sm text-gray-600">Initializing...</div>
                    </div>
            `;

            try {
                const result = await renderVideoToFrames(videoFile);
                videoFrames = result.frames;
                frameTimestamps = result.timestamps;
                bolPreviewContainer.innerHTML = `
                    <div class="text-center col-span-full p-4">
                        <div class="text-green-600 font-semibold mb-2">âœ“ Video Ready for Analysis</div>
                        <div class="text-xs text-gray-500 mt-1">Click "Initiate Yard Auditor" to begin analysis</div>
                    </div>
                `;
                checkAllInputs();
                if (hasApiKey()) parseBolBtn.disabled = false;
            } catch (error) {
                displayMessage(`Error processing video: ${error.message}`);
                bolPreviewContainer.innerHTML = '';
                bolPromptText.classList.remove('hidden');
                videoFileNameDisplay.textContent = '';
                videoFile = null; // Reset the file on failure
                videoFrames = []; // Reset frames
                checkAllInputs(); // Disable button on failure
            }
        });
        // Use native picker behavior everywhere (no interception)
        // Use OS camera app via capture input when clicking "Use Camera App"
        (function attachCameraApp(){
            const cameraInput = document.getElementById('cameraCapture');
            if (!cameraInput) return;
            cameraInput.addEventListener('change', async (event) => {
                if (event.target.files.length === 0) return;
                videoFile = event.target.files[0];
                videoFileNameDisplay.textContent = videoFile.name;
                bolPromptText.classList.add('hidden');
                checkAllInputs();
                bolPreviewContainer.innerHTML = `
                    <div class="text-center col-span-full p-4">
                        <div class="text-base md:text-lg font-semibold text-blue-600 mb-2">Processing Video...</div>
                        <div class="w-full bg-blue-100 rounded-full h-3 relative overflow-hidden mb-2">
                            <div id="videoProgressBar" class="h-3 bg-blue-500 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
                        </div>
                        <div id="videoProgressText" class="text-xs sm:text-sm text-gray-600">Initializing...</div>
                    </div>`;
                try {
                    const result = await renderVideoToFrames(videoFile);
                    videoFrames = result.frames;
                    frameTimestamps = result.timestamps;
                    bolPreviewContainer.innerHTML = `
                        <div class="text-center col-span-full p-4">
                            <div class="text-green-600 font-semibold mb-2">âœ“ Video Ready for Analysis</div>
                            <div class="text-xs text-gray-500 mt-1">Click "Initiate Yard Auditor" to begin analysis</div>
                        </div>`;
                    checkAllInputs();
                    if (hasApiKey()) parseBolBtn.disabled = false;
                } catch (err) {
                    displayMessage(`Error processing video: ${err.message || err}`);
                }
            });
        })();
        
        parseBolBtn.addEventListener('click', handleBolParsing);
        exportBolBtn.addEventListener('click', handleExportBolData);
        // New Audit button toggles upload section back
        document.addEventListener('click', (e) => {
            if (e.target && (e.target.id === 'newAuditBtn' || e.target.closest && e.target.closest('#newAuditBtn'))) {
                const uploadSection = document.getElementById('bolContent');
                if (uploadSection) {
                    uploadSection.classList.toggle('hidden');
                    if (!uploadSection.classList.contains('hidden')) {
                        window.scrollTo({ top: uploadSection.getBoundingClientRect().top + window.scrollY - 24, behavior: 'smooth' });
                    }
                }
                // Also un-hide header/logo section
                const mainHeader = document.getElementById('mainHeader');
                if (mainHeader) mainHeader.classList.remove('hidden');
            }
        });

        howToBtn.addEventListener('click', () => {
            updateKeyHelpPanel();
            sidePanel.classList.remove('translate-x-full');
            sidePanelOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });

        const closePanel = () => {
            sidePanel.classList.add('translate-x-full');
            sidePanelOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        };
        closePanelBtn.addEventListener('click', closePanel);
        sidePanelOverlay.addEventListener('click', closePanel);
        
        // Prompt Panel Listeners
        editBolPromptBtn.addEventListener('click', () => openPromptPanel());

        const openPromptPanel = () => {
            promptSidePanel.classList.remove('translate-x-full');
            promptSidePanelOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        
        const closePromptPanel = () => {
            promptSidePanel.classList.add('translate-x-full');
            promptSidePanelOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        };

        closePromptPanelBtn.addEventListener('click', closePromptPanel);
        promptSidePanelOverlay.addEventListener('click', closePromptPanel);
        saveBolPromptBtn.addEventListener('click', closePromptPanel);
        resetBolPromptBtn.addEventListener('click', () => { bolPromptTextarea.value = defaultBolPrompt; });

        // Side Panel Tab switching
        panelTabKey.addEventListener('click', () => switchSidePanelTab('key'));
        panelTabBilling.addEventListener('click', () => switchSidePanelTab('billing'));
        
        // Modal Listeners
        closeZoomModal.addEventListener('click', () => {
            imageZoomModal.classList.add('hidden');
            imageZoomModal.classList.remove('flex');
        });
        imageZoomModal.addEventListener('click', (e) => {
             if (e.target === imageZoomModal) {
                imageZoomModal.classList.add('hidden');
                imageZoomModal.classList.remove('flex');
            }
        });

        cancelEditBtn.addEventListener('click', () => {
             fieldEditModal.classList.add('hidden');
             fieldEditModal.classList.remove('flex');
        });
        saveEditBtn.addEventListener('click', () => {
            try {
                const fieldId = saveEditBtn.dataset.fieldId;
                const input = document.getElementById('edit-input');
                const targetSpan = document.querySelector(`[data-field-id="${fieldId}"]`);
                if (targetSpan && input) {
                    targetSpan.textContent = input.value || 'N/A';
                }
            } catch(error) {
                console.error("Error saving field:", error);
            } finally {
                fieldEditModal.classList.add('hidden');
                fieldEditModal.classList.remove('flex');
            }
        });
        fieldEditModal.addEventListener('click', (e) => {
             if (e.target === fieldEditModal) {
                fieldEditModal.classList.add('hidden');
                fieldEditModal.classList.remove('flex');
            }
        });

        const printBolBtn = document.getElementById('printBolBtn');
        if (printBolBtn) {
            printBolBtn.addEventListener('click', () => {
                const printContents = bolResultCard.cloneNode(true);
                // Remove carousel/image section if present
                const carousel = printContents.querySelector('#mainCarouselContainer');
                if (carousel) carousel.remove();
                // Remove edit buttons
                printContents.querySelectorAll('[data-action="edit"]').forEach(btn => btn.remove());
                // Remove remove-row and add-row buttons
                printContents.querySelectorAll('.remove-row-btn').forEach(btn => btn.remove());
                const addRowBtn = printContents.querySelector('#addRowBtn');
                if (addRowBtn) addRowBtn.remove();
                // Create a print window
                const printWindow = window.open('', '', 'width=900,height=700');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Print Yard Audit Results</title>
                        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Inter', sans-serif; background: #fff; color: #222; margin: 0; padding: 2rem; }
                            h2 { font-size: 2rem; font-weight: 700; margin-bottom: 2.5rem; }
                            label { font-weight: 600; color: #374151; }
                            .field-block, .mt-1.flex.items-center.p-2.border.bg-gray-50.rounded-md { margin-bottom: 1.1rem !important; }
                            .field-label { display: block; font-size: 1rem; margin-bottom: 0.2rem; color: #555; }
                            .field-value { font-size: 1.1rem; background: #f3f4f6; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
                            .print-section { margin-bottom: 2.5rem; }
                            .section-title { font-size: 1.2rem; font-weight: 600; margin-top: 2.5rem; margin-bottom: 1.2rem; color: #2563eb; }
                            .data-point { margin-bottom: 2.2rem; }
                            table { width: 100%; border-collapse: collapse; margin-top: 2.5rem; margin-bottom: 2.5rem; font-size: 80%; }
                            th, td { border: 1px solid #e5e7eb; padding: 0.6rem 0.8rem; text-align: left; }
                            th { background: #f1f5f9; font-weight: 700; }
                            tr:nth-child(even) { background: #f9fafb; }
                            .highlighted-row { background: #dbeafe !important; border-color: #3b82f6 !important; }
                            @media (max-width: 420px) { body { padding: 1rem; } h2 { font-size: 1.5rem; } }
                        </style>
                    </head>
                    <body>
                        <h2>Yard Audit Results</h2>
                        ${printContents.innerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
            });
        }

        // --- Core Functions ---
        
        function switchSidePanelTab(tabName) {
            if (tabName === 'key') {
                panelTabKey.classList.add('active');
                panelTabBilling.classList.remove('active');
                panelContentKey.classList.remove('hidden');
                panelContentBilling.classList.add('hidden');
            } else {
                panelTabKey.classList.remove('active');
                panelTabBilling.classList.add('active');
                panelContentKey.classList.add('hidden');
                panelContentBilling.classList.remove('hidden');
            }
        }
        
        function hasApiKey() {
            const model = modelSelector.value;
            const googleKey = googleApiKeyInput.value.trim();
            const openaiKey = openaiApiKeyInput.value.trim();
            return (model.startsWith('gpt') || model.startsWith('claude')) ? !!openaiKey : !!googleKey;
        }

        function checkAllInputs() {
            const hasKey = hasApiKey();
            const ready = hasKey && Array.isArray(videoFrames) && videoFrames.length > 0;
            parseBolBtn.disabled = !ready;
        }

        // --- Progress Bar Logic ---
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const progressDots = document.getElementById('progressDots');

        const progressMessages = [
            "Uploading Video",
            "Running AI Model", 
            "Fetching Core Properties",
            "Creating Final Output"
        ];
        let currentMessageIndex = 0;
        let dotsInterval;
        let messagesInterval;

        function setProgress(percent, label) {
            progressBar.style.width = percent + '%';
            if (label) {
                progressLabel.textContent = label;
            }
        }

        function startProgressAnimation() {
            currentMessageIndex = 0;
            progressLabel.textContent = progressMessages[0];
            
            
            // Animate dots
            let dotCount = 0;
            dotsInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                progressDots.textContent = '.'.repeat(dotCount);
            }, 500);

            // Rotate messages every 3 seconds and stamp build time into footer if present
            messagesInterval = setInterval(() => {
                currentMessageIndex = (currentMessageIndex + 1) % progressMessages.length;
                progressLabel.textContent = progressMessages[currentMessageIndex];
            }, 3000);
            // Also set build info on load
            updateBuildInfo();
        }

        async function updateBuildInfo() {
            const bi = document.getElementById('buildInfo');
            if (!bi) return;
            try {
                const resp = await fetch('build-info.json', { cache: 'no-store' });
                if (resp.ok) {
                    const info = await resp.json();
                    if (info && info.commit) {
                        bi.textContent = `Last update: ${info.commit}`;
                        return;
                    }
                }
            } catch (_) {}
            // Fallback to load timestamp
            const now = new Date();
            const pad = n => String(n).padStart(2,'0');
            bi.textContent = `Last update: ${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
        }
        // Set once on ready
        document.addEventListener('DOMContentLoaded', updateBuildInfo);

        function stopProgressAnimation() {
            if (dotsInterval) clearInterval(dotsInterval);
            if (messagesInterval) clearInterval(messagesInterval);
        }

        // --- Update handleBolParsing and PDF rendering to use progress bar ---
        async function handleBolParsing() {
            resetUI();
            loading.classList.remove('hidden');
            startProgressAnimation();
            setProgress(10, '');
            acquireWakeLock();

            if (videoFrames.length === 0) {
                displayMessage("Please upload a video and wait for frames to render.");
                loading.classList.add('hidden');
                stopProgressAnimation();
                return;
            }

            const selectedModel = modelSelector.value;

            try {
                const t0 = performance.now();
                setProgress(20, '');
                const apiKey = getApiKey();
                const prompt = bolPromptTextarea.value;
                let resultText = '';
                const imageParts = videoFrames.map(frameDataUrl => ({
                    inlineData: { mimeType: 'image/jpeg', data: frameDataUrl.split(',')[1] }
                }));

                if (selectedModel.startsWith('gemini')) {
                    setProgress(40, '');
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }, ...imageParts] }],
                        generationConfig: { response_mime_type: 'application/json' }
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    setProgress(70, '');
                    const result = await response.json();
                    const parts = result?.candidates?.[0]?.content?.parts || [];
                    resultText = parts.map(p => p.text || '').join('');
                } else if (selectedModel === 'claude-4') {
                    setProgress(40, '');
                    const apiUrl = 'https://api.anthropic.com/v1/messages';
                    const imageContent = videoFrames.map(frameDataUrl => ({
                        type: 'image',
                        source: { type: 'base64', media_type: 'image/jpeg', data: frameDataUrl.split(',')[1] }
                    }));
                    const payload = {
                        model: 'claude-4-opus-20250514',
                        max_tokens: 4096,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'text', text: prompt },
                                    ...imageContent
                                ]
                            }
                        ]
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`Claude 4 API Error: ${response.status} ${await response.text()}`);
                    setProgress(70, '');
                    const result = await response.json();
                    const textBlock = result.content.find(c => c.type === 'text');
                    if (!textBlock) throw new Error('Claude 4 did not return a text response.');
                    resultText = textBlock.text;
                } else {
                    setProgress(40, '');
                    const apiUrl = "https://api.openai.com/v1/chat/completions";
                    const imageContent = videoFrames.map(frameDataUrl => ({
                         type: 'image_url', image_url: { url: frameDataUrl } 
                    }));
                    const payload = {
                        model: selectedModel,
                        response_format: { type: 'json_object' },
                        messages: [{ role: 'user', content: [ { type: 'text', text: prompt }, ...imageContent]}],
                        stream: true
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
                    if (!response.ok || !response.body) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    
                    let received = 0;
                    let acc = '';
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        received += value.byteLength;
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            const m = line.match(/^data: (.*)$/);
                            if (!m) continue;
                            if (m[1] === '[DONE]') continue;
                            try {
                                const delta = JSON.parse(m[1]);
                                const content = delta?.choices?.[0]?.delta?.content;
                                if (content) {
                                    acc += content;
                                    
                                }
                            } catch {}
                        }
                        const pct = Math.min(90, 40 + Math.floor(Math.log2(1 + received) * 10));
                        setProgress(pct, 'Running AI Model');
                    }
                    resultText = acc;
                }
                setProgress(90, '');
                // Be resilient to code fences / extra text
                const stripFences = (s) => s.replace(/```json/gi, '```').replace(/```/g, '').trim();
                let consolidatedData;
                try {
                    consolidatedData = JSON.parse(resultText);
                } catch (_) {
                    try { consolidatedData = JSON.parse(stripFences(resultText)); } catch (e2) { throw e2; }
                }
                rawModelResponse = resultText; // Store the raw response
                setProgress(100, '');
                displayBolResults(consolidatedData);
                setTimeout(() => { 
                    loading.classList.add('hidden'); 
                    stopProgressAnimation();
                    
                    // Collapse upload section after successful audit
                    const uploadSection = document.getElementById('bolContent');
                    if (uploadSection) uploadSection.classList.add('hidden');
                    const mainHeader = document.getElementById('mainHeader');
                    if (mainHeader) mainHeader.classList.add('hidden');
                    const t1 = performance.now();
                    const elapsedMs = Math.max(0, Math.round(t1 - t0));
                    const minutes = Math.floor(elapsedMs / 60000);
                    const seconds = Math.round((elapsedMs % 60000) / 1000);
                    lastAuditDurationText = `${minutes}m ${seconds}s`;
                    const durEl = document.getElementById('auditDuration');
                    if (durEl) durEl.textContent = `Completed in ${lastAuditDurationText}`;
                }, 800);
            } catch (error) {
                displayMessage(error.message);
                setProgress(0, '');
                stopProgressAnimation();
                
            } finally {
                releaseWakeLock();
                // loading.classList.add('hidden');
            }
        }

        // Update video rendering to show progress
        async function renderVideoToFrames(file) {
            return new Promise((resolve, reject) => {
                try {
                    const videoProgressBar = document.getElementById('videoProgressBar');
                    const videoProgressText = document.getElementById('videoProgressText');
                    
                    const updateVideoProgress = (percent, text) => {
                        if (videoProgressBar) videoProgressBar.style.width = percent + '%';
                        if (videoProgressText) videoProgressText.textContent = text;
                    };
                    
                    updateVideoProgress(10, 'Loading video file...');
                    
                    const video = document.createElement('video');
                    video.muted = true;
                    video.crossOrigin = 'anonymous';
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const frames = [];
                    const timestamps = [];
                    let frameCount = 0;
                    // Reduce or increase frames depending on screen: 100 for mobile, 200 for larger screens
                    const isSmallScreen = window.matchMedia && window.matchMedia('(max-width: 420px)').matches;
                    const maxFrames = isSmallScreen ? 100 : 120;
                    
                    video.addEventListener('loadedmetadata', () => {
                        // Downscale on small screens to reduce memory
                        const scale = isSmallScreen ? Math.min(1, 720 / Math.max(video.videoWidth, video.videoHeight)) : 1;
                        canvas.width = Math.floor(video.videoWidth * scale);
                        canvas.height = Math.floor(video.videoHeight * scale);
                        videoDuration = video.duration;
                        
                        const interval = videoDuration / maxFrames;
                        
                        updateVideoProgress(20, 'Preparing frame extraction...');
                        
                        const extractFrame = (currentTime) => {
                            if (frameCount >= maxFrames) {
                                updateVideoProgress(100, 'Video processing complete!');
                                setTimeout(() => resolve({ frames, timestamps }), 500);
                                return;
                            }
                            
                            video.currentTime = currentTime;
                        };
                        
                        video.addEventListener('seeked', () => {
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            // Prefer higher JPEG quality to improve clarity
                            const jpegQuality = isSmallScreen ? 0.9 : 0.98;
                            const frameDataUrl = canvas.toDataURL('image/jpeg', jpegQuality);
                            frames.push(frameDataUrl);
                            timestamps.push(video.currentTime);
                            frameCount++;
                            
                            const progress = 20 + Math.round((frameCount/maxFrames)*70);
                            updateVideoProgress(progress, `Extracting frame ${frameCount} of ${maxFrames}`);
                            
                            if (frameCount < maxFrames) {
                                setTimeout(() => extractFrame(frameCount * interval), 100);
                            } else {
                                updateVideoProgress(100, 'Video processing complete!');
                                setTimeout(() => resolve({ frames, timestamps }), 500);
                            }
                        });
                        
                        // Start extracting frames
                        extractFrame(0);
                    });
                    
                    video.addEventListener('error', (error) => {
                        updateVideoProgress(0, 'Error loading video file');
                        reject(new Error('Failed to load video file'));
                    });
                    
                    // Stream from input for mobile to reduce initial delay; fallback to object URL
                    // Use object URL for broad compatibility
                    try { video.src = URL.createObjectURL(file); } catch (_) { video.src = ''; }
                    video.load();
                    
                } catch (error) {
                    const videoProgressText = document.getElementById('videoProgressText');
                    if (videoProgressText) videoProgressText.textContent = 'Error processing video';
                    reject(error);
                }
            });
        }

        // Function to find the closest frame to a given timestamp
        function findClosestFrame(timestamp) {
            if (!frameTimestamps || frameTimestamps.length === 0) return null;
            
            let closestIndex = 0;
            let minDifference = Math.abs(frameTimestamps[0] - timestamp);
            
            for (let i = 1; i < frameTimestamps.length; i++) {
                const difference = Math.abs(frameTimestamps[i] - timestamp);
                if (difference < minDifference) {
                    minDifference = difference;
                    closestIndex = i;
                }
            }
            
            return videoFrames[closestIndex];
        }

        function displayBolResults(data) {
            bolResultCard.innerHTML = '';
            currentFrameIndex = 0; // Reset frame index

            // Handle both array and object data structures
            let trailers = [];
            if (Array.isArray(data)) {
                trailers = data;
            } else if (data.trailers) {
                trailers = data.trailers;
            } else if (data.data) {
                trailers = data.data;
            } else {
                // Try to find any array in the data
                for (const key in data) {
                    if (Array.isArray(data[key])) {
                        trailers = data[key];
                        break;
                    }
                }
            }

            // Store current trailers for comparison
            currentTrailers = trailers;

            // Extract frames and keep frame numbers
            const imageTuples = trailers
                .map(trailer => {
                    const frameNumber = parseInt(trailer.image_identifier);
                    if (!isNaN(frameNumber) && frameNumber >= 1 && frameNumber <= videoFrames.length) {
                        const img = videoFrames[frameNumber - 1] || null;
                        return img ? { img, frameNumber } : null;
                    }
                    return null;
                })
                .filter(item => item !== null);
            trailerImages = imageTuples.map(t => t.img);
            trailerImageFrameNumbers = imageTuples.map(t => t.frameNumber);

            const updateTrailerCarousel = () => {
                const frame = bolResultCard.querySelector('#carouselFrame');
                const frameCounter = bolResultCard.querySelector('#frameCounter');
                if (frame && frameCounter && trailerImages.length > 0) {
                    frame.src = trailerImages[currentFrameIndex];
                    frame.alt = `Trailer ${currentFrameIndex + 1}`;
                    frameCounter.textContent = `${currentFrameIndex + 1} / ${trailerImages.length}`;
                }
                // Desktop supporting frame chips
                const chipBarId = 'desktopFrameChips';
                let chipBar = bolResultCard.querySelector(`#${chipBarId}`);
                if (!chipBar) {
                    chipBar = document.createElement('div');
                    chipBar.id = chipBarId;
                    chipBar.className = 'mt-2 flex flex-wrap gap-1 text-xs justify-center hidden md:flex';
                    const container = bolResultCard.querySelector('#mainCarouselContainer');
                    if (container) container.appendChild(chipBar);
                }
                chipBar.innerHTML = '';
                const current = trailers[currentFrameIndex];
                const ids = Array.isArray(current?.supporting_frame_identifiers) ? current.supporting_frame_identifiers.slice(0,3) : [];
                ids.forEach(n => {
                    const b = document.createElement('button');
                    b.className = 'px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 border';
                    b.textContent = `Frame ${n}`;
                    b.addEventListener('click', () => {
                        if (!isNaN(n) && n >= 1 && n <= videoFrames.length) {
                            currentFrameIndex = Math.max(0, n - 1);
                            updateTrailerCarousel();
                        }
                    });
                    chipBar.appendChild(b);
                });
                const zoomFrame = document.getElementById('zoomedFrame');
                if(zoomFrame && trailerImages.length > 0) {
                    zoomFrame.src = trailerImages[currentFrameIndex];
                }
                
                // Highlight the corresponding table row
                highlightTableRow(currentFrameIndex);
            };
            
            const highlightTableRow = (frameIndex) => {
                // Remove previous highlights
                bolResultCard.querySelectorAll('#trailersTable tbody tr').forEach(row => {
                    row.classList.remove('bg-blue-50', 'border-blue-300');
                    row.classList.add('border-gray-200');
                });
                
                // Highlight the current row
                const currentFrameNumber = trailers[frameIndex]?.image_identifier;
                if (currentFrameNumber) {
                    const matchingRows = bolResultCard.querySelectorAll(`#trailersTable tbody tr[data-frame="${currentFrameNumber}"]`);
                    matchingRows.forEach(row => {
                        row.classList.add('bg-blue-50', 'border-blue-300');
                        row.classList.remove('border-gray-200');
                    });
                }
            };
            
            const createCarousel = () => {
                        const carouselContainer = document.createElement('div');
                        carouselContainer.className = 'md:col-span-1 relative';

                    const frame = document.createElement('img');
                    frame.id = 'carouselFrame';
                    frame.src = trailerImages.length > 0 ? trailerImages[0] : '';
                    frame.className = 'rounded-lg border shadow-md w-full h-auto cursor-pointer max-h-[60vh] object-contain bg-black/5';
                    frame.alt = 'Trailer 1';
                frame.addEventListener('click', () => openImageZoomModal());

                const prevBtn = document.createElement('button');
                prevBtn.className = 'absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75';
                prevBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>';
                prevBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentFrameIndex = (currentFrameIndex - 1 + trailerImages.length) % trailerImages.length;
                    updateTrailerCarousel();
                });
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75';
                nextBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>';
                 nextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentFrameIndex = (currentFrameIndex + 1) % trailerImages.length;
                    updateTrailerCarousel();
                });

                const frameCounter = document.createElement('div');
                frameCounter.id = 'frameCounter';
                frameCounter.className = 'absolute top-2 left-1/2 -translate-x-1/2 bg-black bg-opacity-70 text-white text-xs font-semibold px-2 py-1 rounded-full';
                
                carouselContainer.append(frame, prevBtn, nextBtn, frameCounter);
                // Desktop chips container appended in updateTrailerCarousel

                if (trailerImages.length <= 1) {
                    prevBtn.classList.add('hidden');
                    nextBtn.classList.add('hidden');
                }
                
                updateTrailerCarousel();
                return carouselContainer;
            };

            let trailersHtml = `
                    <table class="w-full text-sm mt-1 border-collapse" id="trailersTable">
                        <thead>
                           <tr class="border-b bg-gray-50">
                                <th class="p-2 text-left font-semibold text-gray-700">Trailer ID</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Carrier</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Location</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Type</th>
                                <th class="p-2 text-left font-semibold text-gray-700">Size (ft)</th>
                                <th class="p-2 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${trailers.map((trailer, idx) => `
                            <tr class="border-b" data-row="${idx}" data-frame="${trailer.image_identifier || ''}">
                                <td class="p-2 editable-table-cell" data-col="trailer_id">${trailer.trailer_id || 'N/A'}</td>
                                <td class="p-2 editable-table-cell" data-col="carrier">${trailer.carrier || 'N/A'}</td>
                                <td class="p-2 editable-table-cell" data-col="location">${trailer.location || 'N/A'}</td>
                                <td class="p-2 editable-table-cell" data-col="trailer_type">${trailer.trailer_type || 'N/A'}</td>
                                <td class="p-2 editable-table-cell" data-col="trailer_size">${trailer.trailer_size || 'N/A'}</td>
                                <td class="p-2 text-right">
                                    <button class="confirm-row-btn inline-flex items-center gap-1 bg-emerald-600 text-white hover:bg-emerald-700 text-sm px-2 py-1 rounded-full mr-2">Confirm</button>
                                    <button class="remove-row-btn inline-flex items-center gap-1 text-red-600 hover:text-red-700 text-sm px-2 py-1 rounded-full hover:bg-red-50" title="Remove row">
                                        <span>&minus;</span><span class="hidden sm:inline">Remove</span>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                    <div class="mt-2 text-right">
                        <button id="addRowBtn" class="inline-flex items-center gap-1 bg-blue-100 text-blue-700 font-semibold px-3 py-1 rounded-full hover:bg-blue-200 transition text-sm">+ Add Trailer</button>
                    </div>
            `;

            // Mobile cards view
            let trailersCardsHtml = `
                <div id="trailersListMobile" class="space-y-3">
                    ${trailers.map((trailer, idx) => {
                        const frameNumber = parseInt(trailer.image_identifier);
                        const frameImg = (!isNaN(frameNumber) && frameNumber >= 1 && frameNumber <= videoFrames.length) ? videoFrames[frameNumber - 1] : null;
                        return `
                        <div class=\"rounded-lg border border-gray-200 bg-white p-3 shadow-sm\" data-row=\"${idx}\" data-frame=\"${trailer.image_identifier || ''}\"> 
                            ${frameImg ? `<img src=\"${frameImg}\" alt=\"Frame ${frameNumber}\" class=\"w-full h-auto rounded mb-2 max-h-[40vh] object-contain bg-black/5\" />` : ''}
                            <div class=\"flex items-center justify-between mb-2\">
                                <div class=\"font-semibold text-gray-800 truncate\">${trailer.trailer_id || 'N/A'}</div>
                                
                            </div>
                            <div class=\"grid grid-cols-2 gap-2 text-sm\">
                                <div>
                                    <div class=\"text-gray-500\">Trailer ID</div>
                                    <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"trailer_id\">${trailer.trailer_id || 'N/A'}</span></div>
                                </div>
                                <div>
                                    <div class=\"text-gray-500\">Carrier</div>
                                    <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"carrier\">${trailer.carrier || 'N/A'}</span></div>
                                </div>
                                <div>
                                    <div class=\"text-gray-500\">Loaded</div>
                                    <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"is_loaded\">${trailer.is_loaded ? 'Yes' : 'No'}</span></div>
                                </div>
                                <div>
                                    <div class=\"text-gray-500\">Location</div>
                                    <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"location\">${trailer.location || 'N/A'}</span></div>
                                </div>
                                <div>
                                    <div class=\"text-gray-500\">Type</div>
                                    <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"trailer_type\">${trailer.trailer_type || 'N/A'}</span></div>
                                </div>
                                <div>
                                    <div class=\"text-gray-500\">Size (ft)</div>
                                    <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"trailer_size\">${trailer.trailer_size || 'N/A'}</span></div>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                    <div class="text-right">
                        <button id="addCardBtn" class="bg-blue-100 text-blue-700 font-semibold px-3 py-1 rounded hover:bg-blue-200 transition">+ Add Trailer</button>
                    </div>
                </div>
            `;

            const mainDiv = document.createElement('div');
            mainDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6';
            mainDiv.innerHTML = `
                <div class="md:col-span-1 order-2 md:order-1">
                    <div id="mainCarouselContainer" class="relative hidden md:block">
                        </div>
                </div>
                 <div class="md:col-span-2 order-1 md:order-2">
                    <div class="mb-2 md:mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1 md:mb-2">Yard Audit Results</h3>
                        <p id="auditDuration" class="text-sm text-gray-600"></p>
                    </div>
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Trailers Identified</label>
                        <!-- Desktop/Table view -->
                        <div class="hidden md:block p-3 bg-gray-50 rounded-lg border mt-1 overflow-x-auto">
                            <div class="min-w-[640px]">${trailersHtml}</div>
                        </div>
                        <!-- Mobile/Cards view with inline image above card -->
                        <div class="block md:hidden mt-1">
                            <div class="space-y-3" id="mobileCardsContainer"></div>
                            <div class="flex items-center justify-end gap-3 mt-2">
                                <button id="confirmCardBtn" class="inline-flex items-center gap-1 bg-emerald-600 text-white hover:bg-emerald-700 px-3 py-2 rounded-full text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>
                                    <span class="confirm-label">Confirm</span>
                                </button>
                                <button id="removeCardBtnBottom" class="remove-card-btn inline-flex items-center gap-1 bg-red-600 text-white hover:bg-red-700 px-3 py-2 rounded-full text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            bolResultCard.appendChild(mainDiv);
            if (trailerImages.length > 0) {
                bolResultCard.querySelector('#mainCarouselContainer').appendChild(createCarousel());
            }
            
            // Re-attach listeners for dynamically created elements
            bolResultCard.querySelectorAll('#carouselFrame').forEach(frame => {
                 frame.addEventListener('click', () => openImageZoomModal());
            });

            // Mobile cards interactions (edit and remove)
            if (window.matchMedia && window.matchMedia('(max-width: 767px)').matches) {
                const list = bolResultCard.querySelector('#trailersListMobile');
                const cardsContainer = bolResultCard.querySelector('#mobileCardsContainer');
                const stepCounter = bolResultCard.querySelector('#stepCounter');
                const prevBtnTop = bolResultCard.querySelector('#prevCardBtnTop');
                const nextBtnTop = bolResultCard.querySelector('#nextCardBtnTop');
                const prevBtnBottom = bolResultCard.querySelector('#prevCardBtn2');
                const nextBtnBottom = null;
                const confirmBtn = bolResultCard.querySelector('#confirmCardBtn');
                let currentCardIndex = 0;
                let confirmedSet = new Set();

                // Build a single-card carousel view
                const buildCardAt = (idx) => {
                    if (!cardsContainer) return;
                    const trailer = trailers[idx];
                    const frameNumber = parseInt(trailer?.image_identifier);
                    const frameImg = (!isNaN(frameNumber) && frameNumber >= 1 && frameNumber <= videoFrames.length) ? videoFrames[frameNumber - 1] : null;
                    const selectedFrameInit = (!isNaN(frameNumber) ? frameNumber : 1);
                    const cardHtml = `
                        <div class=\"space-y-2\"> 
                            ${frameImg ? `<img src=\"${frameImg}\" alt=\"Frame ${frameNumber}\" data-frame=\"${frameNumber}\" class=\"trailer-thumb w-full max-h-[50vh] rounded object-contain bg-black/5 cursor-zoom-in\" />` : ''}
                            <div class=\"mt-1 flex items-center justify-center gap-3\">
                                <button data-frame-prev class=\"inline-flex items-center justify-center bg-gray-100 text-gray-800 hover:bg-gray-200 p-2 rounded-full text-xs\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-chevron-left\"><path d=\"m15 18-6-6 6-6\"/></svg></button>
                                <span class=\"text-xs text-gray-600 frame-indicator\">Frame ${selectedFrameInit}</span>
                                <button data-frame-next class=\"inline-flex items-center justify-center bg-gray-100 text-gray-800 hover:bg-gray-200 p-2 rounded-full text-xs\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-chevron-right\"><path d=\"m9 18 6-6-6-6\"/></svg></button>
                            </div>
                            ${Array.isArray(trailer?.supporting_frame_identifiers) && trailer.supporting_frame_identifiers.length ? `<div class=\"mt-2 flex flex-wrap gap-1 text-xs justify-center\">${trailer.supporting_frame_identifiers.slice(0,3).map(n => `<button data-frame-sel=\"${n}\" class=\"px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 border\">Frame ${n}</button>`).join('')}</div>` : ''}
                            <div class=\"mobile-trailer-card rounded-lg border border-gray-200 bg-white p-3 shadow-sm relative transition-colors\" data-row=\"${idx}\" data-frame=\"${trailer?.image_identifier || ''}\"> 
                                <div class=\"confirmed-badge hidden absolute top-2 right-2 bg-emerald-600 text-white text-xs font-semibold px-2 py-1 rounded-full shadow\">Confirmed</div>
                                <div class=\"flex items-center justify-between mb-2\"> 
                                    <div class=\"font-semibold text-gray-800 truncate\">${trailer?.trailer_id || 'N/A'}</div>
                                </div>
                                <div class=\"grid grid-cols-2 gap-2 text-sm\"> 
                                    <div>
                                        <div class=\"text-gray-500\">Trailer ID</div>
                                        <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"trailer_id\">${(trailer?.trailer_id ?? '') || 'N/A'}</span></div>
                                    </div>
                                    <div>
                                        <div class=\"text-gray-500\">Carrier</div>
                                        <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"carrier\">${(trailer?.carrier ?? '') || 'N/A'}</span></div>
                                    </div>
                                    
                                    <div>
                                        <div class=\"text-gray-500\">Location</div>
                                        <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"location\">${(trailer?.location ?? '') || 'N/A'}</span></div>
                                    </div>
                                    <div>
                                        <div class=\"text-gray-500\">Type</div>
                                        <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"trailer_type\">${(trailer?.trailer_type ?? '') || 'N/A'}</span></div>
                                    </div>
                                    <div>
                                        <div class=\"text-gray-500\">Size (ft)</div>
                                        <div class=\"mt-1 p-2 bg-gray-50 rounded border\"><span class=\"editable-field\" data-col=\"trailer_size\">${(trailer?.trailer_size ?? '') || 'N/A'}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    cardsContainer.innerHTML = cardHtml;
                    const cardEl2 = cardsContainer.querySelector('.mobile-trailer-card');
                    if (cardEl2) cardEl2.setAttribute('data-selected-frame', String(selectedFrameInit));
                };

                const updateStepper = () => {
                    if (!cardsContainer) return;
                    // Render just the current card
                    buildCardAt(currentCardIndex);
                    if (stepCounter) stepCounter.textContent = `${Math.min(currentCardIndex + 1, trailers.length)} / ${trailers.length}`;
                    const atStart = currentCardIndex <= 0;
                    const atEnd = currentCardIndex >= trailers.length - 1;
                    if (prevBtnTop) prevBtnTop.disabled = atStart;
                    if (nextBtnTop) nextBtnTop.disabled = atEnd;
                    if (prevBtnBottom) prevBtnBottom.disabled = atStart;
                    
                    if (confirmBtn) confirmBtn.classList.toggle('bg-emerald-700', confirmedSet.has(currentCardIndex));
                    if (confirmBtn) {
                        const labelEl = confirmBtn.querySelector('.confirm-label');
                        if (labelEl) labelEl.textContent = confirmedSet.has(currentCardIndex) ? 'Undo' : 'Confirm';
                    }
                    const cardEl = cardsContainer.querySelector('.mobile-trailer-card');
                    if (cardEl) {
                        if (confirmedSet.has(currentCardIndex)) {
                            cardEl.classList.add('ring-2','ring-emerald-400','bg-emerald-50');
                            const badge = cardEl.querySelector('.confirmed-badge'); if (badge) badge.classList.remove('hidden');
                        } else {
                            cardEl.classList.remove('ring-2','ring-emerald-400','bg-emerald-50');
                            const badge = cardEl.querySelector('.confirmed-badge'); if (badge) badge.classList.add('hidden');
                        }
                    }
                    // Update header counter
                    const confirmCounter = document.getElementById('confirmCounter');
                    const durEl2 = document.getElementById('auditDuration');
                    if (durEl2 && lastAuditDurationText) {
                        durEl2.textContent = `Completed in ${lastAuditDurationText}`;
                    }
                };

                const goPrev = () => {
                    currentCardIndex = Math.max(0, currentCardIndex - 1);
                    updateStepper();
                };
                const goNext = () => {
                    currentCardIndex = Math.min(trailers.length - 1, currentCardIndex + 1);
                    updateStepper();
                };
                if (prevBtnTop) prevBtnTop.addEventListener('click', goPrev);
                if (nextBtnTop) nextBtnTop.addEventListener('click', goNext);
                if (prevBtnBottom) prevBtnBottom.addEventListener('click', goPrev);
                
                if (confirmBtn) confirmBtn.addEventListener('click', () => {
                    // Persist visible edits into trailers[currentCardIndex]
                    const card = cardsContainer.querySelector('[data-row]');
                    if (card && trailers[currentCardIndex]) {
                        const getVal = (sel) => (card.querySelector(sel)?.textContent || '').trim();
                        const t = trailers[currentCardIndex];
                        t.trailer_id = getVal('[data-col="trailer_id"]') || null;
                        t.carrier = getVal('[data-col="carrier"]') || null;
                        const selectedFrameAttr = card.getAttribute('data-selected-frame');
                        const selectedFrameNum = selectedFrameAttr ? parseInt(selectedFrameAttr) : NaN;
                        if (!isNaN(selectedFrameNum)) t.image_identifier = selectedFrameNum;
                        t.location = getVal('[data-col="location"]') || null;
                        t.trailer_type = getVal('[data-col="trailer_type"]') || null;
                        const sizeTxt = getVal('[data-col="trailer_size"]');
                        t.trailer_size = sizeTxt && !isNaN(parseInt(sizeTxt)) ? parseInt(sizeTxt) : sizeTxt || null;
                    }
                    if (confirmedSet.has(currentCardIndex)) confirmedSet.delete(currentCardIndex); else confirmedSet.add(currentCardIndex);
                    updateStepper();
                });
                setTimeout(updateStepper, 0);
                if (list || cardsContainer) {
                    (list || cardsContainer).addEventListener('click', (e) => {
                        const confirmClick = e.target.closest && e.target.closest('#confirmCardBtn');
                        if (confirmClick) {
                            const card = cardsContainer.querySelector('[data-row]');
                            if (card && trailers[currentCardIndex]) {
                                const getVal = (sel) => (card.querySelector(sel)?.textContent || '').trim();
                                const t = trailers[currentCardIndex];
                                t.trailer_id = getVal('[data-col="trailer_id"]') || null;
                                t.carrier = getVal('[data-col="carrier"]') || null;
                                
                                t.location = getVal('[data-col="location"]') || null;
                                t.trailer_type = getVal('[data-col="trailer_type"]') || null;
                                const sizeTxt = getVal('[data-col="trailer_size"]');
                                t.trailer_size = sizeTxt && !isNaN(parseInt(sizeTxt)) ? parseInt(sizeTxt) : sizeTxt || null;
                            }
                            if (confirmedSet.has(currentCardIndex)) confirmedSet.delete(currentCardIndex); else confirmedSet.add(currentCardIndex);
                            updateStepper();
                            return;
                        }
                        const thumb = e.target.closest('img.trailer-thumb');
                        if (thumb && thumb.dataset.frame) {
                            const frameNum = parseInt(thumb.dataset.frame);
                            const idx = trailerImageFrameNumbers ? trailerImageFrameNumbers.indexOf(frameNum) : -1;
                            if (idx >= 0) {
                                currentFrameIndex = idx;
                                // Sync hidden desktop carousel too
                                if (typeof updateTrailerCarousel === 'function') {
                                    updateTrailerCarousel();
                                }
                                openImageZoomModal();
                            } else if (!isNaN(frameNum)) {
                                // Fallback: choose the nearest available trailer image frame for syncing
                                if (Array.isArray(trailerImageFrameNumbers) && trailerImageFrameNumbers.length > 0) {
                                    let nearestIdx = 0;
                                    let minDiff = Math.abs(trailerImageFrameNumbers[0] - frameNum);
                                    for (let i = 1; i < trailerImageFrameNumbers.length; i++) {
                                        const diff = Math.abs(trailerImageFrameNumbers[i] - frameNum);
                                        if (diff < minDiff) { minDiff = diff; nearestIdx = i; }
                                    }
                                    currentFrameIndex = nearestIdx;
                                    if (typeof updateTrailerCarousel === 'function') {
                                        updateTrailerCarousel();
                                    }
                                }
                                // Directly switch the visible image on the card to the selected frame
                                const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
                                const cardThumb = cardsContainer.querySelector('img.trailer-thumb');
                                if (cardThumb && imagesToShow[currentFrameIndex]) cardThumb.src = imagesToShow[currentFrameIndex];
                                const indicator = cardsContainer.querySelector('.frame-indicator');
                                if (indicator) indicator.textContent = `Frame ${currentFrameIndex + 1}`;
                                const cardEl2 = cardsContainer.querySelector('.mobile-trailer-card');
                                if (cardEl2) cardEl2.setAttribute('data-selected-frame', String(currentFrameIndex + 1));
                            }
                            return;
                        }
                        const removeBtn = e.target.closest('#removeCardBtnBottom');
                        if (removeBtn) {
                            const ok = confirm('Remove this trailer from results?');
                            if (!ok) return;
                            const indexToRemove = currentCardIndex;
                            trailers.splice(indexToRemove, 1);
                            confirmedSet = new Set(Array.from(confirmedSet).filter(i => i !== indexToRemove).map(i => i > indexToRemove ? i - 1 : i));
                            currentCardIndex = Math.min(currentCardIndex, Math.max(0, trailers.length - 1));
                            updateStepper();
                            return;
                        }
                        const frameSel = e.target.closest('button[data-frame-sel]');
                        if (frameSel && frameSel.getAttribute) {
                            const n = parseInt(frameSel.getAttribute('data-frame-sel'));
                            if (!isNaN(n) && n >= 1 && n <= videoFrames.length) {
                                currentFrameIndex = Math.max(0, n - 1);
                                const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
                                const carouselFrame = bolResultCard.querySelector('#carouselFrame');
                                if (carouselFrame && imagesToShow[currentFrameIndex]) carouselFrame.src = imagesToShow[currentFrameIndex];
                                const cardThumb = cardsContainer.querySelector('img.trailer-thumb');
                                if (cardThumb && imagesToShow[currentFrameIndex]) cardThumb.src = imagesToShow[currentFrameIndex];
                                const indicator = cardsContainer.querySelector('.frame-indicator');
                                if (indicator) indicator.textContent = `Frame ${currentFrameIndex + 1}`;
                                const cardEl2 = cardsContainer.querySelector('.mobile-trailer-card');
                                if (cardEl2) cardEl2.setAttribute('data-selected-frame', String(currentFrameIndex + 1));
                            }
                            return;
                        }
                        const prevChip = e.target.closest('[data-frame-prev]');
                        if (prevChip) {
                            currentFrameIndex = Math.max(0, currentFrameIndex - 1);
                            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
                            const cardThumb = cardsContainer.querySelector('img.trailer-thumb');
                            if (cardThumb && imagesToShow[currentFrameIndex]) cardThumb.src = imagesToShow[currentFrameIndex];
                            const indicator = cardsContainer.querySelector('.frame-indicator');
                            if (indicator) indicator.textContent = `Frame ${currentFrameIndex + 1}`;
                            const cardEl2 = cardsContainer.querySelector('.mobile-trailer-card');
                            if (cardEl2) cardEl2.setAttribute('data-selected-frame', String(currentFrameIndex + 1));
                            return;
                        }
                        const nextChip = e.target.closest('[data-frame-next]');
                        if (nextChip) {
                            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
                            currentFrameIndex = Math.min(imagesToShow.length - 1, currentFrameIndex + 1);
                            const cardThumb = cardsContainer.querySelector('img.trailer-thumb');
                            if (cardThumb && imagesToShow[currentFrameIndex]) cardThumb.src = imagesToShow[currentFrameIndex];
                            const indicator = cardsContainer.querySelector('.frame-indicator');
                            if (indicator) indicator.textContent = `Frame ${currentFrameIndex + 1}`;
                            const cardEl2 = cardsContainer.querySelector('.mobile-trailer-card');
                            if (cardEl2) cardEl2.setAttribute('data-selected-frame', String(currentFrameIndex + 1));
                            return;
                        }
                        const editable = e.target.closest('.editable-field');
                        if (editable) {
                            const currentValue = editable.textContent === 'N/A' ? '' : editable.textContent;
                            const input = document.createElement('input');
                            input.value = currentValue;
                            input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                            input.addEventListener('blur', function() {
                                editable.textContent = input.value || 'N/A';
                                editable.style.display = '';
                                input.replaceWith(editable);
                                // Persist to current trailer on blur so export/raw reflect edits
                                if (trailers[currentCardIndex]) {
                                    const t = trailers[currentCardIndex];
                                    const col = editable.getAttribute('data-col');
                                    if (col) {
                                        let val = editable.textContent.trim();
                                        if (col === 'is_loaded') { val = /^y(es)?$/i.test(val); }
                                        else if (col === 'trailer_size') { val = val && !isNaN(parseInt(val)) ? parseInt(val) : (val || null); }
                                        else { val = val || null; }
                                        t[col] = val;
                                    }
                                }
                            });
                            input.addEventListener('keydown', function(ev) {
                                if (ev.key === 'Enter') input.blur();
                            });
                            editable.parentNode.replaceChild(input, editable);
                            input.focus();
                            input.select();
                        }
                    });
                }
            }
            
            resultsWrapper.classList.remove('hidden');
            bolResultContainer.classList.remove('hidden');
            attachTrailersTableListeners();
        }

        function createDisplayField(id, label, value) {
            return `
                <div>
                    <label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label>
                    <div class="mt-1 flex items-center p-2 border bg-gray-50 rounded-md">
                        <span class="text-sm text-gray-900 editable-field" data-field-id="${id}" tabindex="0">${value || 'N/A'}</span>
                    </div>
                </div>`;
        }
        
        function openEditModal(fieldId, fieldLabel, currentValue) {
            editModalTitle.textContent = `Edit ${fieldLabel}`;
            editModalContent.innerHTML = `<textarea id="edit-input" class="w-full rounded-md border-gray-300 shadow-sm" rows="3">${currentValue === 'N/A' ? '' : currentValue}</textarea>`;
            saveEditBtn.dataset.fieldId = fieldId;
            fieldEditModal.classList.remove('hidden');
            fieldEditModal.classList.add('flex');
        }
        
        function openImageZoomModal() {
            // Use trailer images if available, otherwise fall back to video frames
            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
            if (imagesToShow.length > 0) {
                zoomedImage.src = imagesToShow[currentFrameIndex];
            }
            imageZoomModal.classList.remove('hidden');
            imageZoomModal.classList.add('flex');
        }

        zoomPrevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
            if (imagesToShow.length > 0) {
                currentFrameIndex = (currentFrameIndex - 1 + imagesToShow.length) % imagesToShow.length;
                zoomedImage.src = imagesToShow[currentFrameIndex];
                const carouselFrame = bolResultCard.querySelector('#carouselFrame');
                if (carouselFrame) carouselFrame.src = imagesToShow[currentFrameIndex];
                const frameCounter = bolResultCard.querySelector('#frameCounter');
                if (frameCounter) frameCounter.textContent = `${currentFrameIndex + 1} / ${imagesToShow.length}`;
                const fp = document.getElementById('framePicker'); if (fp) fp.classList.add('hidden');
            }
        });
        zoomNextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
            if (imagesToShow.length > 0) {
                currentFrameIndex = (currentFrameIndex + 1) % imagesToShow.length;
                zoomedImage.src = imagesToShow[currentFrameIndex];
                const carouselFrame = bolResultCard.querySelector('#carouselFrame');
                if (carouselFrame) carouselFrame.src = imagesToShow[currentFrameIndex];
                const frameCounter = bolResultCard.querySelector('#frameCounter');
                if (frameCounter) frameCounter.textContent = `${currentFrameIndex + 1} / ${imagesToShow.length}`;
                const fp = document.getElementById('framePicker'); if (fp) fp.classList.add('hidden');
            }
        });

        // Enable +/- 5 frame picker when tapping image in zoom
        zoomedImage.addEventListener('click', () => {
            const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
            if (!imagesToShow.length) return;
            const fp = document.getElementById('framePicker');
            if (!fp) return;
            const start = Math.max(0, currentFrameIndex - 5);
            const end = Math.min(imagesToShow.length - 1, currentFrameIndex + 5);
            const items = [];
            for (let i = start; i <= end; i++) {
                items.push(`<button data-idx="${i}" class="mx-0.5 px-1.5 py-0.5 rounded ${i===currentFrameIndex? 'bg-white text-black' : 'bg-white/20'}">${i+1}</button>`);
            }
            fp.innerHTML = items.join('');
            fp.classList.remove('hidden');
        });
        document.addEventListener('click', (e) => {
            const fp = document.getElementById('framePicker');
            if (!fp || fp.classList.contains('hidden')) return;
            if (e.target.closest && e.target.closest('#framePicker')) {
                const btn = e.target.closest('button[data-idx]');
                if (!btn) return;
                const idx = parseInt(btn.getAttribute('data-idx'));
                const imagesToShow = trailerImages.length > 0 ? trailerImages : videoFrames;
                if (isNaN(idx) || idx < 0 || idx >= imagesToShow.length) return;
                currentFrameIndex = idx;
                zoomedImage.src = imagesToShow[currentFrameIndex];
                const carouselFrame = bolResultCard.querySelector('#carouselFrame');
                if (carouselFrame) carouselFrame.src = imagesToShow[currentFrameIndex];
                const frameCounter = bolResultCard.querySelector('#frameCounter');
                if (frameCounter) frameCounter.textContent = `${currentFrameIndex + 1} / ${imagesToShow.length}`;
                // also update the thumb in the current mobile card if exists
                const thumb = bolResultCard.querySelector('img.trailer-thumb');
                if (thumb) thumb.src = imagesToShow[currentFrameIndex];
                fp.classList.add('hidden');
            } else if (!e.target.closest('#imageZoomModal')) {
                fp.classList.add('hidden');
            }
        });

        function handleExportBolData() {
            const card = document.getElementById('bolResultCard');
            if (!card) return;

            const headers = ["Trailer ID", "Carrier", "Location", "Type", "Size (ft)"];
            const rows = [];
            
            const trailerRows = card.querySelectorAll('tbody > tr');
            if (trailerRows.length > 0 && trailerRows[0].cells.length > 1) {
                 trailerRows.forEach(row => {
                    rows.push([
                        row.cells[0] ? row.cells[0].innerText : 'N/A', // Trailer ID
                        row.cells[1] ? row.cells[1].innerText : 'N/A', // Carrier
                        row.cells[2] ? row.cells[2].innerText : 'N/A', // Location
                        row.cells[3] ? row.cells[3].innerText : 'N/A', // Type
                        row.cells[4] ? row.cells[4].innerText : 'N/A'  // Size
                    ].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
                });
            } else {
                 rows.push(['N/A', 'N/A', 'N/A', 'N/A', 'N/A', 'N/A'].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
            }

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "yard_audit_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function getApiKey() {
            const isGpt = modelSelector.value.startsWith('gpt');
            const isClaude = modelSelector.value.startsWith('claude');
            const key = (isGpt || isClaude) ? openaiApiKeyInput.value.trim() : googleApiKeyInput.value.trim();
            if (!key) throw new Error(`Please provide an ${(isGpt || isClaude) ? 'OpenAI' : 'Google AI'} API Key.`);
            return key;
        }
        
        function resetUI() {
            loading.classList.add('hidden');
            parseBolBtn.disabled = true;
            resultsWrapper.classList.add('hidden');
            messageContainer.classList.add('hidden');
            bolResultContainer.classList.add('hidden');
            setProgress(0, '');
            stopProgressAnimation();
        }
        
        function displayMessage(msg) {
            messageContainer.classList.remove('hidden');
            message.innerText = msg;
        }

        const howToBtnOpenAI = document.getElementById('howToBtnOpenAI');
        if (howToBtnOpenAI) {
            howToBtnOpenAI.addEventListener('click', () => {
                updateKeyHelpPanel();
                sidePanel.classList.remove('translate-x-full');
                sidePanelOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('editable-field')) {
                const span = e.target;
                const currentValue = span.textContent === 'N/A' ? '' : span.textContent;
                const input = document.createElement(span.dataset.fieldId === 'origin' || span.dataset.fieldId === 'destination' ? 'textarea' : 'input');
                input.value = currentValue;
                input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                input.style.minHeight = span.dataset.fieldId === 'origin' || span.dataset.fieldId === 'destination' ? '2.5em' : '';
                input.addEventListener('blur', function() {
                    span.textContent = input.value || 'N/A';
                    span.style.display = '';
                    input.replaceWith(span);
                });
                input.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter' && input.tagName !== 'TEXTAREA') {
                        input.blur();
                    }
                });
                span.parentNode.replaceChild(input, span);
                input.focus();
                input.select();
            }
            // Table cell editing
            if (e.target.classList.contains('editable-table-cell')) {
                const td = e.target;
                const currentValue = td.textContent === 'N/A' ? '' : td.textContent;
                const input = document.createElement('input');
                input.value = currentValue;
                input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                input.addEventListener('blur', function() {
                    td.textContent = input.value || 'N/A';
                    td.style.display = '';
                    input.replaceWith(td);
                });
                input.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter') {
                        input.blur();
                    }
                });
                td.parentNode.replaceChild(input, td);
                input.focus();
                input.select();
            }
            // Add row
            if (e.target.id === 'addRowBtn') {
                const table = document.getElementById('trailersTable').getElementsByTagName('tbody')[0];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2 editable-table-cell" data-col="trailer_id">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="carrier">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="is_loaded">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="location">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="trailer_type">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="trailer_size">N/A</td>
                    <td class="p-2 editable-table-cell" data-col="image_identifier">N/A</td>
                    <td class="p-2 text-center"><button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg" title="Remove row">&minus;</button></td>
                `;
                table.appendChild(row);
            }
            // Remove row
            if (e.target.classList.contains('remove-row-btn')) {
                const row = e.target.closest('tr');
                row.parentNode.removeChild(row);
            }
        });

        function attachTrailersTableListeners() {
            const table = document.getElementById('trailersTable');
            if (!table) return;
            // Remove any previous event listeners by cloning
            const newTable = table.cloneNode(true);
            table.parentNode.replaceChild(newTable, table);
            // Use only event delegation on the table
            newTable.addEventListener('click', function(e) {
                if (e.target.classList.contains('editable-table-cell')) {
                    const td = e.target;
                    const currentValue = td.textContent === 'N/A' ? '' : td.textContent;
                    const input = document.createElement('input');
                    input.value = currentValue;
                    input.className = 'w-full rounded-md border border-blue-300 focus:ring-blue-500 focus:border-blue-500 p-1 bg-white editable-input';
                    input.addEventListener('blur', function() {
                        td.textContent = input.value || 'N/A';
                        td.style.display = '';
                        input.replaceWith(td);
                    });
                    input.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter') {
                            input.blur();
                        }
                    });
                    td.parentNode.replaceChild(input, td);
                    input.focus();
                    input.select();
                }
                if (e.target.classList.contains('remove-row-btn')) {
                    const row = e.target.closest('tr');
                    row.parentNode.removeChild(row);
                }
                if (e.target.classList.contains('confirm-row-btn')) {
                    const row = e.target.closest('tr');
                    row.classList.toggle('bg-emerald-50');
                    e.target.textContent = row.classList.contains('bg-emerald-50') ? 'Undo' : 'Confirm';
                }
                if (e.target.id === 'addRowBtn') {
                    const tbody = newTable.getElementsByTagName('tbody')[0];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2 editable-table-cell" data-col="trailer_id">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="carrier">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="is_loaded">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="location">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="trailer_type">N/A</td>
                        <td class="p-2 editable-table-cell" data-col="trailer_size">N/A</td>
                        <td class="p-2 text-center"><button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg" title="Remove row">&minus;</button></td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // Hide AI config section initially and toggle on triple-click of logo
        const aiConfigSection = document.getElementById('aiConfigSection');
        const vectorLogo = document.getElementById('vectorLogo');
        let logoClickCount = 0;
        let logoClickTimer = null;
        function toggleAIConfigSection() {
            aiConfigSection.classList.toggle('hidden');
        }
        vectorLogo.addEventListener('click', function() {
            logoClickCount++;
            if (logoClickTimer) clearTimeout(logoClickTimer);
            logoClickTimer = setTimeout(() => { logoClickCount = 0; }, 1000);
            if (logoClickCount === 3) {
                toggleAIConfigSection();
                logoClickCount = 0;
            }
        });

        // Raw Results Modal Listeners
        showRawResultsBtn.addEventListener('click', () => {
            if (rawModelResponse) {
                rawResultsText.textContent = rawModelResponse;
                rawResultsModal.classList.remove('hidden');
                rawResultsModal.classList.add('flex');
            }
        });

        const closeRawResultsModal = () => {
            rawResultsModal.classList.add('hidden');
            rawResultsModal.classList.remove('flex');
        };

        closeRawResultsBtn.addEventListener('click', closeRawResultsModal);
        closeRawResultsBtn2.addEventListener('click', closeRawResultsModal);
        rawResultsModal.addEventListener('click', (e) => {
            if (e.target === rawResultsModal) {
                closeRawResultsModal();
            }
        });

        // Share modal (lightweight prompt)
        document.addEventListener('click', async (e) => {
            if (e.target && (e.target.id === 'shareBtn' || (e.target.closest && e.target.closest('#shareBtn')))) {
                try {
                    const email = prompt('Enter email address to share results:');
                    if (!email) return;
                    const type = confirm('OK = Share CSV\nCancel = Share JSON') ? 'csv' : 'json';
                    let blob; let filename;
                    if (type === 'csv') {
                        // Reuse export logic to build CSV
                        const card = document.getElementById('bolResultCard');
                        const headers = ["Trailer ID","Carrier","Location","Type","Size (ft)"];
                        const trailerRows = card ? card.querySelectorAll('tbody > tr') : [];
                        const rows = [];
                        if (trailerRows.length) {
                            trailerRows.forEach(row => rows.push([
                                row.cells[0]?.innerText || 'N/A',
                                row.cells[1]?.innerText || 'N/A',
                                row.cells[2]?.innerText || 'N/A',
                                row.cells[3]?.innerText || 'N/A',
                                row.cells[4]?.innerText || 'N/A',
                                row.cells[5]?.innerText || 'N/A'
                            ].map(d => `"${String(d).replace(/"/g,'""')}"`).join(',')));
                        }
                        const csv = headers.join(',') + "\n" + rows.join("\n");
                        blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                        filename = 'yard_audit_results.csv';
                    } else {
                        // Use rawModelResponse if present; else build JSON from table
                        let jsonText = rawModelResponse;
                        if (!jsonText) {
                            const card = document.getElementById('bolResultCard');
                            const trailerRows = card ? card.querySelectorAll('tbody > tr') : [];
                            const trailers = [];
                            trailerRows.forEach(row => trailers.push({
                                trailer_id: row.cells[0]?.innerText || null,
                                carrier: row.cells[1]?.innerText || null,
                                location: row.cells[2]?.innerText || null,
                                trailer_type: row.cells[3]?.innerText || null,
                                trailer_size: row.cells[4]?.innerText || null
                            }));
                            jsonText = JSON.stringify(trailers, null, 2);
                        }
                        blob = new Blob([jsonText], { type: 'application/json' });
                        filename = 'yard_audit_results.json';
                    }
                    // Download locally as a first step (email send would require a backend)
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert(`Prepared ${type.toUpperCase()} for ${email}. To enable email sending, connect a backend endpoint (e.g., serverless function).`);
                } catch (err) {
                    alert('Failed to prepare share: ' + (err?.message || err));
                }
            }
        });

        copyRawResultsBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(rawModelResponse).then(() => {
                const originalText = copyRawResultsBtn.innerHTML;
                copyRawResultsBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><polyline points="20 6 9 17 4 12"/></svg>
                    Copied!
                `;
                setTimeout(() => {
                    copyRawResultsBtn.innerHTML = originalText;
                }, 2000);
            });
        });

        // Comparison Modal Listeners
        compareYardBtn.addEventListener('click', () => {
            compareYardModal.classList.remove('hidden');
            compareYardModal.classList.add('flex');
            
            // Store the current trailers as the "current" state for comparison
            // The uploaded file will become the "previous" state
            const currentTrailersForComparison = [...currentTrailers]; // Create a copy
            window.currentTrailersForComparison = currentTrailersForComparison;

            // Reset the modal to show the API data source UI
            const uploadSection = document.getElementById('compareUploadSection');
            uploadSection.innerHTML = `
                <h4 class="text-lg font-semibold mb-3">Choose Comparison Method</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 border rounded-lg bg-blue-50">
                        <h5 class="font-semibold text-blue-800 mb-3">Compare Against API</h5>
                        <p class="text-sm text-gray-600 mb-3">Fetch live data from the Vector API for comparison</p>
                        <button id="fetchCompareBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-sm">
                            Fetch & Compare
                        </button>
                    </div>
                    <div class="p-4 border rounded-lg bg-green-50">
                        <h5 class="font-semibold text-green-800 mb-3">Upload CSV File</h5>
                        <p class="text-sm text-gray-600 mb-3">Upload a CSV file with trailer data for comparison</p>
                        <label for="compareCsvUpload" class="w-full inline-block text-center py-2 px-4 bg-green-600 text-white rounded-lg cursor-pointer hover:bg-green-700 transition">
                            Upload CSV
                        </label>
                        <input type="file" id="compareCsvUpload" class="hidden" accept=".csv">
                        <p id="csvFileName" class="text-sm text-green-600 font-semibold mt-2"></p>
                    </div>
                </div>
                <div id="comparisonApiStatus" class="mt-4 text-center"></div>
            `;
            
            comparisonResults.classList.add('hidden');
        });

        // Use event delegation for the comparison modal
        compareYardModal.addEventListener('click', (event) => {
            if (event.target.id === 'fetchCompareBtn') {
                fetchComparisonData();
            }
        });
        
        compareYardModal.addEventListener('change', (event) => {
            if (event.target.id === 'compareCsvUpload') {
                handleCsvUpload(event);
            }
        });

        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileNameDisplay = document.getElementById('csvFileName');
            fileNameDisplay.textContent = file.name;

            const statusDiv = document.getElementById('comparisonApiStatus');
            statusDiv.innerHTML = `<div class="flex items-center justify-center text-blue-600"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>Processing CSV...</div>`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    const lines = csvData.split('\n');
                    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                    const trailers = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                            const trailer = {};
                            headers.forEach((header, index) => {
                                trailer[header.toLowerCase().replace(/\s+/g, '_')] = values[index] || '';
                            });
                            trailers.push(trailer);
                        }
                    }
                    
                    previousTrailers = trailers;
                    statusDiv.innerHTML = `<p class="text-green-600 font-semibold">âœ“ CSV processed successfully. Found ${trailers.length} trailers.</p>`;

                    // Now that data is loaded, run the comparison
                    runComparison();

                } catch (error) {
                    statusDiv.innerHTML = `<p class="text-red-600 font-semibold">Error processing CSV: ${error.message}</p>`;
                    console.error("CSV processing error:", error);
                }
            };
            reader.readAsText(file);
        }

        async function fetchComparisonData() {
            const statusDiv = document.getElementById('comparisonApiStatus');
            statusDiv.innerHTML = `<div class="flex items-center justify-center text-blue-600"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>Fetching comparison data...</div>`;

            // Get bearer token and API endpoint from the main UI section
            const bearerToken = document.getElementById('mainBearerTokenInput').value;
            const apiEndpoint = document.getElementById('apiEndpointInput').value;
            
            const requestBody = {
              "computations": {},
              "filters": [
                {
                  "type": "containsEdge",
                  "path": "mixins.active",
                  "values": [
                    {
                      "entityId": "1ad2e51a-74a8-41a8-b321-9f15332b6609"
                    }
                  ]
                },
                {
                  "path": "core_yms_trailer.facility",
                  "type": "matchEdge",
                  "label": "Facility",
                  "values": [
                    {
                      "entityId": "619cb73a-2ce0-4b93-b4a2-bc8f61de53cf",
                      "displayName": "Council Bluffs",
                      "denormalizedProperties": {
                        "location.address": {
                          "region": "IA",
                          "locality": "Council Bluffs",
                          "postalCode": "51503",
                          "timezoneId": "America/Chicago",
                          "countryName": "United States",
                          "geolocation": {
                            "latitude": 41.252221,
                            "longitude": -95.850577
                          },
                          "streetAddress": "1023 S 4th St"
                        },
                        "core_yms_facility.map": {
                          "files": [
                            {
                              "uri": "https://auth.withvector.com/619cb73a-2ce0-4b93-b4a2-bc8f61de53cf/component/image/1707945377632/11ed6c6b-52cf-4cc0-a260-8b70b371fddd/original.jpg",
                              "name": "Council Bluffs Map Final 2.9.jpg",
                              "text": "https://auth.withvector.com/619cb73a-2ce0-4b93-b4a2-bc8f61de53cf/component/image/1707945377632/11ed6c6b-52cf-4cc0-a260-8b70b371fddd/Council_Bluffs_Map_Final_2.9.txt",
                              "type": "image",
                              "width": 838,
                              "height": 1602,
                              "source": [
                                {
                                  "uri": "https://auth.withvector.com/fit-in/838x1602/619cb73a-2ce0-4b93-b4a2-bc8f61de53cf/component/image/1707945377632/11ed6c6b-52cf-4cc0-a260-8b70b371fddd/original.jpg",
                                  "width": 838,
                                  "height": 1602
                                },
                                {
                                  "uri": "https://auth.withvector.com/fit-in/640x480/619cb73a-2ce0-4b93-b4a2-bc8f61de53cf/component/image/1707945377632/11ed6c6b-52cf-4cc0-a260-8b70b371fddd/original.jpg",
                                  "width": 640,
                                  "height": 480
                                },
                                {
                                  "uri": "https://auth.withvector.com/fit-in/64x64/619cb73a-2ce0-4b93-b4a2-bc8f61de53cf/component/image/1707945377632/11ed6c6b-52cf-4cc0-a260-8b70b371fddd/original.jpg",
                                  "width": 64,
                                  "height": 64
                                }
                              ],
                              "uniqueId": "11ed6c6b-52cf-4cc0-a260-8b70b371fddd"
                            }
                          ],
                          "version": 1707945377,
                          "aggregate": {
                            "uri": "https://api.withvector.com/1.0/entities/actions/fileset/downloadPdf/619cb73a-2ce0-4b93-b4a2-bc8f61de53cf/core_yms_facility/map",
                            "name": "aggregate.pdf",
                            "type": "pdf",
                            "pages": 0,
                            "uniqueId": "f06fc2f5-14cf-4b0b-b248-127732061144"
                          }
                        },
                        "core_yms_facility.isGiCiEnabled": true,
                        "core_yms_facility.checkInPlanSettings": {
                          "entityId": "a8d5ffae-f439-45ae-a856-ccd7b5be6df8",
                          "displayName": "Council Bluffs Settings",
                          "denormalizedProperties": {
                            "basebowl_facility_settings.checkInPlan": {
                              "plan": {
                                "entityId": "640a766d-12a5-4af9-9bb2-a9b72a7a727b",
                                "displayName": "Conagra Facility Check-In",
                                "denormalizedProperties": {
                                  "owner.firm": {
                                    "entityId": "9cbd095e-2fb1-40e5-ae61-d33bb9f5bb92",
                                    "displayName": "Conagra Brands, Inc."
                                  }
                                }
                              },
                              "container": {
                                "entityId": "12189b3e-7322-419c-baaa-82fe2e86db2c",
                                "displayName": "Conagra Facility Check-In Container",
                                "denormalizedProperties": {
                                  "core_storyboard_plansContainer.activePlan": {
                                    "entityId": "640a766d-12a5-4af9-9bb2-a9b72a7a727b",
                                    "displayName": "Conagra Facility Check-In",
                                    "denormalizedProperties": {
                                      "id": "/1.0/entities/metadata/conagra_brands_plan.json",
                                      "owner.firm": {
                                        "entityId": "9cbd095e-2fb1-40e5-ae61-d33bb9f5bb92",
                                        "displayName": "Conagra Brands, Inc."
                                      },
                                      "core_storyboard_plan.execution": {
                                        "entityId": "f1b2aa6f-cd52-42c9-85f0-6c563aa21dcf",
                                        "displayName": "Conagra Facility Check-In"
                                      }
                                    }
                                  }
                                }
                              },
                              "execution": {
                                "entityId": "f1b2aa6f-cd52-42c9-85f0-6c563aa21dcf",
                                "displayName": "Conagra Facility Check-In"
                              }
                            }
                          }
                        },
                        "core_yms_facility.checkInPlanContainer": {
                          "entityId": "12189b3e-7322-419c-baaa-82fe2e86db2c",
                          "displayName": "Conagra Facility Check-In Container",
                          "denormalizedProperties": {
                            "core_storyboard_plansContainer.activePlan": {
                              "entityId": "640a766d-12a5-4af9-9bb2-a9b72a7a727b",
                              "displayName": "Conagra Facility Check-In",
                              "denormalizedProperties": {
                                "id": "/1.0/entities/metadata/conagra_brands_plan.json",
                                "owner.firm": {
                                  "entityId": "9cbd095e-2fb1-40e5-ae61-d33bb9f5bb92",
                                  "displayName": "Conagra Brands, Inc."
                                },
                                "core_storyboard_plan.execution": {
                                  "entityId": "f1b2aa6f-cd52-42c9-85f0-6c563aa21dcf",
                                  "displayName": "Conagra Facility Check-In"
                                }
                              }
                            }
                          }
                        },
                        "core_yms_facility.enableSpotDriverInstructions": true
                      }
                    }
                  ]
                },
                {
                  "path": "core_yms_trailer.spot",
                  "type": "notExists",
                  "label": "Spot",
                  "entityType": "/1.0/entities/metadata/core_yms_trailer.json",
                  "isNegation": true
                }
              ],
              "groups": [],
              "orders": [
                {
                  "path": "modifiedDate",
                  "type": "descending"
                }
              ],
              "metadata": {
                "offset": 0,
                "shouldIncludeLeafEntities": true,
                "size": 80,
                "maxSizePerGroup": 10
              },
              "debug": {
                "context": "view--Trailers"
              }
            };

            try {
                // Try direct API call first, then fallback to CORS proxy if needed
                let response;
                
                try {
                    response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${bearerToken}`,
                            'Origin': 'localhost'
                        },
                        body: JSON.stringify(requestBody)
                    });
                } catch (corsError) {
                    // If CORS fails, try with allorigins proxy
                    statusDiv.innerHTML = `<div class="flex items-center justify-center text-blue-600"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>Retrying with CORS proxy...</div>`;
                    
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiEndpoint)}`;
                    response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${bearerToken}`,
                            'Origin': 'localhost'
                        },
                        body: JSON.stringify(requestBody)
                    });
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 403 && errorText.includes('corsdemo')) {
                        throw new Error(`CORS proxy access required. Please visit https://cors-anywhere.herokuapp.com/corsdemo to request temporary access, then try again.`);
                    }
                    throw new Error(`API call failed: ${response.status} ${errorText}`);
                }

                const responseData = await response.json();
                previousTrailers = transformApiData(responseData);
                
                statusDiv.innerHTML = `<p class="text-green-600 font-semibold">âœ“ API data loaded successfully. Found ${previousTrailers.length} trailers.</p>`;

                // Now that data is loaded, run the comparison
                runComparison();

            } catch (error) {
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMessage = 'CORS error: The API server does not allow requests from this domain. Please try uploading a CSV file instead, or contact the API provider to whitelist this domain.';
                } else if (error.message.includes('corsdemo')) {
                    errorMessage = error.message + ' Alternatively, you can upload a CSV file for comparison.';
                }
                statusDiv.innerHTML = `<p class="text-red-600 font-semibold">Error: ${errorMessage}</p>`;
                console.error("API call error:", error);
            }
        }
        
        function transformApiData(apiData) {
            if (!apiData || !apiData.children) return [];

            return apiData.children.map(child => {
                const trailerData = child.data?.core_yms_trailer || {};
                
                let trailer_type = trailerData.type || '';
                let trailer_size = null;

                const sizeMatch = trailer_type.match(/\((\d+)/);
                if (sizeMatch && sizeMatch[1]) {
                    trailer_size = parseInt(sizeMatch[1], 10);
                    trailer_type = trailer_type.replace(sizeMatch[0], '').replace('()', '').trim();
                }

                return {
                    trailer_id: trailerData.name,
                    carrier: trailerData.carrier?.displayName,
                    is_loaded: trailerData.status !== 'Empty',
                    location: trailerData.spot?.displayName,
                    trailer_type: trailer_type,
                    trailer_size: trailer_size
                };
            });
        }
        
        function runComparison() {
            console.log('runComparison called');
            console.log('Current trailers for comparison:', window.currentTrailersForComparison);
            console.log('Previous trailers:', previousTrailers);
            
            if (!window.currentTrailersForComparison || !previousTrailers) {
                displayMessage("Please ensure both current and previous yard states are available.");
                return;
            }

            // Create maps for efficient lookup
            const currentMap = new Map();
            const previousMap = new Map();
            
            window.currentTrailersForComparison.forEach(trailer => {
                if (trailer.trailer_id) {
                    currentMap.set(trailer.trailer_id, trailer);
                }
            });
            
            previousTrailers.forEach(trailer => {
                if (trailer.trailer_id) {
                    previousMap.set(trailer.trailer_id, trailer);
                }
            });

            // Find added, removed, and remaining trailers
            const addedTrailers = [];
            const removedTrailers = [];
            const remainingTrailers = [];

            // Find added trailers (in current but not in previous)
            window.currentTrailersForComparison.forEach(trailer => {
                if (trailer.trailer_id && !previousMap.has(trailer.trailer_id)) {
                    addedTrailers.push(trailer);
                }
            });

            // Find removed trailers (in previous but not in current)
            previousTrailers.forEach(trailer => {
                if (trailer.trailer_id && !currentMap.has(trailer.trailer_id)) {
                    removedTrailers.push(trailer);
                }
            });

            // Find remaining trailers (in both)
            window.currentTrailersForComparison.forEach(trailer => {
                if (trailer.trailer_id && previousMap.has(trailer.trailer_id)) {
                    remainingTrailers.push(trailer);
                }
            });

            console.log('Comparison results:', { added: addedTrailers.length, removed: removedTrailers.length, remaining: remainingTrailers.length });

            // Update the comparison results display
            comparisonResults.classList.remove('hidden');
            
            const addedCount = document.getElementById('addedCount');
            const removedCount = document.getElementById('removedCount');
            const remainingCount = document.getElementById('remainingCount');
            const addedTrailersList = document.getElementById('addedTrailers');
            const removedTrailersList = document.getElementById('removedTrailers');
            const remainingTrailersList = document.getElementById('remainingTrailers');

            addedCount.textContent = addedTrailers.length;
            removedCount.textContent = removedTrailers.length;
            remainingCount.textContent = remainingTrailers.length;

            // Update detailed lists
            addedTrailersList.innerHTML = addedTrailers.length > 0 ? 
                addedTrailers.map(trailer => `
                    <div class="flex items-center justify-between p-2 bg-green-100 rounded mb-2">
                        <span class="font-semibold text-green-800">${trailer.trailer_id || 'N/A'}</span>
                        <span class="text-sm text-green-600">${trailer.carrier || 'N/A'}</span>
                    </div>
                `).join('') : 
                '<p class="text-sm text-green-700 text-center">No new trailers found</p>';

            removedTrailersList.innerHTML = removedTrailers.length > 0 ? 
                removedTrailers.map(trailer => `
                    <div class="flex items-center justify-between p-2 bg-red-100 rounded mb-2">
                        <span class="font-semibold text-red-800">${trailer.trailer_id || 'N/A'}</span>
                        <span class="text-sm text-red-600">${trailer.carrier || 'N/A'}</span>
                    </div>
                `).join('') : 
                '<p class="text-sm text-red-700 text-center">No trailers removed</p>';

            remainingTrailersList.innerHTML = remainingTrailers.length > 0 ? 
                remainingTrailers.map(trailer => `
                    <div class="flex items-center justify-between p-2 bg-blue-100 rounded mb-2">
                        <span class="font-semibold text-blue-800">${trailer.trailer_id || 'N/A'}</span>
                        <span class="text-sm text-blue-600">${trailer.carrier || 'N/A'}</span>
                    </div>
                `).join('') : 
                '<p class="text-sm text-blue-700 text-center">No trailers remaining</p>';
        }

        // Update progress bar for comparison
        const comparisonProgressBar = document.getElementById('comparisonProgressBar');
        const comparisonProgressText = document.getElementById('comparisonProgressText');

        function updateComparisonProgress(percent, text) {
            comparisonProgressBar.style.width = percent + '%';
            comparisonProgressText.textContent = text;
        }

        // Close comparison modal
        closeCompareYardBtn.addEventListener('click', () => {
            compareYardModal.classList.add('hidden');
            compareYardModal.classList.remove('flex');
        });

        compareYardModal.addEventListener('click', (e) => {
            if (e.target === compareYardModal) {
                compareYardModal.classList.add('hidden');
                compareYardModal.classList.remove('flex');
            }
        });

        // Export comparison results
        exportComparisonBtn.addEventListener('click', () => {
            const headers = ["Status", "Trailer ID", "Carrier", "Loaded", "Location", "Type", "Size (ft)"];
            const rows = [];
            
            // Get the comparison results from the current state
            const addedTrailers = [];
            const removedTrailers = [];
            const remainingTrailers = [];
            
            if (window.currentTrailersForComparison && previousTrailers) {
                const currentMap = new Map();
                const previousMap = new Map();
                
                window.currentTrailersForComparison.forEach(trailer => {
                    if (trailer.trailer_id) {
                        currentMap.set(trailer.trailer_id, trailer);
                    }
                });
                
                previousTrailers.forEach(trailer => {
                    if (trailer.trailer_id) {
                        previousMap.set(trailer.trailer_id, trailer);
                    }
                });

                // Find added trailers (in current but not in previous)
                window.currentTrailersForComparison.forEach(trailer => {
                    if (trailer.trailer_id && !previousMap.has(trailer.trailer_id)) {
                        addedTrailers.push(trailer);
                    }
                });

                // Find removed trailers (in previous but not in current)
                previousTrailers.forEach(trailer => {
                    if (trailer.trailer_id && !currentMap.has(trailer.trailer_id)) {
                        removedTrailers.push(trailer);
                    }
                });

                // Find remaining trailers (in both)
                window.currentTrailersForComparison.forEach(trailer => {
                    if (trailer.trailer_id && previousMap.has(trailer.trailer_id)) {
                        remainingTrailers.push(trailer);
                    }
                });
            }
            
            // Add added trailers
            addedTrailers.forEach(trailer => {
                rows.push([
                    "Added",
                    trailer.trailer_id || 'N/A',
                    trailer.carrier || 'N/A',
                    trailer.is_loaded ? 'Yes' : 'No',
                    trailer.location || 'N/A',
                    trailer.trailer_type || 'N/A',
                    trailer.trailer_size || 'N/A'
                ].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
            });
            
            // Add removed trailers
            removedTrailers.forEach(trailer => {
                rows.push([
                    "Removed",
                    trailer.trailer_id || 'N/A',
                    trailer.carrier || 'N/A',
                    trailer.is_loaded ? 'Yes' : 'No',
                    trailer.location || 'N/A',
                    trailer.trailer_type || 'N/A',
                    trailer.trailer_size || 'N/A'
                ].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
            });
            
            // Add remaining trailers
            remainingTrailers.forEach(trailer => {
                rows.push([
                    "Remaining",
                    trailer.trailer_id || 'N/A',
                    trailer.carrier || 'N/A',
                    trailer.is_loaded ? 'Yes' : 'No',
                    trailer.location || 'N/A',
                    trailer.trailer_type || 'N/A',
                    trailer.trailer_size || 'N/A'
                ].map(d => `"${String(d).replace(/"/g, '""')}"`).join(','));
            });

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "yard_comparison_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Add event listener for the original runComparisonBtn
        // runComparisonBtn.addEventListener('click', runComparison);
    </script>
</body>
</html>