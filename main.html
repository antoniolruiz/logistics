<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yard Auditor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Roboto as a readily available proxy for Google Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-google-sans {
            font-family: 'Roboto', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #message {
            white-space: pre-wrap;
            text-align: left;
            background-color: #fef2f2;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
            color: #b91c1c;
        }
        .translate-x-full {
             transform: translateX(100%);
        }
        /* Tab styles */
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .side-panel-tab.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
            <header class="mb-8 text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 font-google-sans">Yard Auditor</h1>
                <p class="mt-2 text-gray-600">Choose your AI model, upload media, and generate intelligent reports.</p>
            </header>

            <div class="space-y-6">
                 <!-- Universal Controls: Model and API Keys -->
                <div>
                    <label for="modelSelector" class="block text-lg font-medium text-gray-700 mb-2 font-google-sans">Choose AI Model</label>
                    <select id="modelSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (Highest Quality)</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Fast & Efficient)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="gpt-4o">OpenAI GPT-4o</option>
                    </select>
                </div>
                <div id="googleKeyContainer">
                    <div class="flex items-center justify-between mb-2">
                         <label for="googleApiKeyInput" class="block text-lg font-medium text-gray-700 font-google-sans">Google AI API Key</label>
                         <button id="howToBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">How to get a key?</button>
                    </div>
                    <input type="password" id="googleApiKeyInput" placeholder="Enter your Google AI API Key" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div id="openaiKeyContainer" class="hidden">
                    <label for="openaiApiKeyInput" class="block text-lg font-medium text-gray-700 mb-2 font-google-sans">OpenAI API Key</label>
                    <input type="password" id="openaiApiKeyInput" placeholder="Enter your OpenAI API Key" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                
                 <!-- Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="tabVideo" class="tab-btn active shrink-0 border-b-2 py-4 px-1 text-base font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">Video Analysis</button>
                        <button id="tabInventory" class="tab-btn shrink-0 border-b-2 border-transparent py-4 px-1 text-base font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">Inventory Report</button>
                    </nav>
                </div>
                
                 <!-- Tab Content -->
                <div id="videoContent" class="tab-content">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-lg font-medium text-gray-700 font-google-sans">Upload Video</label>
                        <button id="editVideoPromptBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">Edit Prompt</button>
                    </div>
                    <div class="flex items-center justify-center w-full">
                         <label for="videoUpload" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                             <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                 <svg class="w-10 h-10 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                                 <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                 <p class="text-xs text-gray-500">MP4, MOV, AVI, etc. (MAX. 50MB)</p>
                                 <p id="fileName" class="text-sm text-green-600 font-semibold mt-2"></p>
                             </div>
                             <input id="videoUpload" type="file" class="hidden" accept="video/*" />
                         </label>
                    </div>
                    <div class="text-center mt-8 mb-8">
                        <button id="analyzeBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">Analyze Video</button>
                    </div>
                </div>

                <div id="inventoryContent" class="tab-content hidden">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-lg font-medium text-gray-700 font-google-sans">Upload Screenshots</label>
                        <button id="editInventoryPromptBtn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors">Edit Prompt</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Screenshot 1 -->
                        <div class="flex flex-col items-center">
                            <h3 class="font-semibold mb-2">Before Image</h3>
                            <label for="screenshot1" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                                <div id="ss1-prompt" class="flex flex-col items-center justify-center p-5 text-center">
                                    <svg class="w-10 h-10 mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14"></path></svg>
                                    <p class="text-sm text-gray-500">Upload "Before" Screenshot</p>
                                </div>
                                <img id="ss1-preview" class="hidden w-full h-full object-contain rounded-lg"/>
                                <input id="screenshot1" type="file" class="hidden" accept="image/*" />
                            </label>
                        </div>
                         <!-- Screenshot 2 -->
                        <div class="flex flex-col items-center">
                            <h3 class="font-semibold mb-2">After Image</h3>
                            <label for="screenshot2" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                                <div id="ss2-prompt" class="flex flex-col items-center justify-center p-5 text-center">
                                    <svg class="w-10 h-10 mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14"></path></svg>
                                    <p class="text-sm text-gray-500">Upload "After" Screenshot</p>
                                </div>
                                <img id="ss2-preview" class="hidden w-full h-full object-contain rounded-lg"/>
                                <input id="screenshot2" type="file" class="hidden" accept="image/*" />
                            </label>
                        </div>
                    </div>
                     <div class="text-center mt-8 mb-8">
                        <button id="compareBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">Generate Inventory Report</button>
                    </div>
                </div>
            </div>
            
            <div id="loading" class="text-center my-4 hidden"><div class="inline-block loader w-12 h-12 border-4 rounded-full"></div><p class="mt-4 text-lg font-medium text-gray-600">Analyzing... This may take a moment.</p></div>
            <div id="messageContainer" class="hidden">
                 <div id="message" class="text-red-600 font-medium"></div>
            </div>
            
            <!-- Universal Results Section -->
            <div id="resultsWrapper" class="hidden">
                 <!-- Results Table (for Video Analysis) -->
                <div id="resultsContainer" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 font-google-sans">Analysis Results</h2>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y-2 divide-gray-200 bg-white text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="whitespace-nowrap px-4 py-3 font-semibold text-left text-gray-900">Trailer ID</th><th class="whitespace-nowrap px-4 py-3 font-semibold text-left text-gray-900">Carrier</th><th class="whitespace-nowrap px-4 py-3 font-semibold text-left text-gray-900">Is Loaded</th><th class="whitespace-nowrap px-4 py-3 font-semibold text-left text-gray-900">Location</th><th class="whitespace-nowrap px-4 py-3 font-semibold text-left text-gray-900">Trailer Type</th><th class="whitespace-nowrap px-4 py-3 font-semibold text-left text-gray-900">Trailer Size</th><th class="whitespace-nowrap px-4 py-3 font-semibold text-left text-gray-900">Image</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                 <!-- Actions Section -->
                <div id="aiActionsContainer" class="hidden mt-10">
                     <h2 class="text-2xl font-bold text-gray-800 mb-4 font-google-sans">Actions</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <button id="seeOriginalAnswerBtn" class="flex items-center justify-center gap-2 bg-gray-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:shadow-lg hover:bg-gray-700 transform hover:-translate-y-0.5 transition-all duration-300 ease-in-out">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-braces"><path d="M8 3H7a2 2 0 0 0-2 2v5a2 2 0 0 1-2 2 2 2 0 0 1 2 2v5c0 1.1.9 2 2 2h1"/><path d="M16 21h1a2 2 0 0 0 2-2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5a2 2 0 0 0-2-2h-1"/></svg>
                            See Original Answer
                        </button>
                        <button id="downloadDataBtn" class="flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transform hover:-translate-y-0.5 transition-all duration-300 ease-in-out">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Download Data
                        </button>
                        <button id="generateSummaryBtn" class="flex items-center justify-center gap-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:shadow-lg hover:from-green-600 hover:to-emerald-700 transform hover:-translate-y-0.5 transition-all duration-300 ease-in-out">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                            Generate Summary
                        </button>
                     </div>
                     <textarea id="aiResultText" class="w-full h-48 p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500" placeholder="AI-generated content will appear here..."></textarea>
                </div>
                <!-- Inventory Report Result -->
                <div id="inventoryResultContainer" class="hidden mt-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 font-google-sans">Inventory Change Report</h2>
                    <div id="inventoryReportVisual" class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                        <div>
                            <h3 class="text-lg font-semibold text-green-600 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                                Arrived
                            </h3>
                            <div id="addedTrailersContainer" class="space-y-3">
                                <!-- Cards for added trailers will be injected here -->
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-blue-600 mb-4 flex items-center gap-2">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-anchor"><circle cx="12" cy="12" r="8"/><path d="M12 22V8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>
                                Remained
                            </h3>
                            <div id="remainedTrailersContainer" class="space-y-3">
                                <!-- Cards for remained trailers will be injected here -->
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-red-600 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-minus-circle"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                                Departed
                            </h3>
                            <div id="removedTrailersContainer" class="space-y-3">
                                <!-- Cards for removed trailers will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Key Helper Side Panel -->
    <div id="sidePanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="sidePanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-google-sans font-bold">API Key Help</h2>
                <button id="closePanelBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
             <!-- Side Panel Tabs -->
            <div class="border-b border-gray-200">
                <nav class="flex" aria-label="Side Panel Tabs">
                    <button id="panelTabKey" class="side-panel-tab active flex-1 border-b-2 py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Get API Key</button>
                    <button id="panelTabBilling" class="side-panel-tab flex-1 border-b-2 border-transparent py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Enable Billing</button>
                </nav>
            </div>
            <!-- Side Panel Content -->
            <div id="panelContentKey" class="p-6 overflow-y-auto flex-grow">
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google AI Studio</h3>
                        <p class="mb-3 text-sm">Navigate to <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 hover:underline">aistudio.google.com</a> and sign in with your Google account.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-1.png" alt="Google AI Studio Homepage" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Get API Key</h3>
                        <p class="mb-3 text-sm">Once in AI Studio, click **"Get API key"** from the left-hand menu.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-2.png" alt="Get API Key button" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Create API key in a new project</h3>
                        <p class="mb-3 text-sm">A dialog will appear. Click on **"Create API key in new project"**.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-3.png" alt="Create API Key in new project" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Copy Your Key</h3>
                        <p class="mb-3 text-sm">Your new API key will be displayed. Click the copy icon to copy the key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-4.png" alt="Copy new API key" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 5: Paste it Here</h3>
                        <p class="mb-3 text-sm">Return to this page and paste the key into the "Google AI API Key" input field.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/tutorial-api-key-5.png" alt="Paste key into the application" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            </div>
            <div id="panelContentBilling" class="p-6 overflow-y-auto flex-grow hidden">
                 <div class="space-y-6">
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 1: Go to Google Cloud Console</h3>
                        <p class="mb-3 text-sm">Navigate to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a> and select the project associated with your API key.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-1.png" alt="Google Cloud Console" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 2: Open Billing Menu</h3>
                        <p class="mb-3 text-sm">Click the main navigation menu (hamburger icon) and select **"Billing"**.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-2.png" alt="Billing Menu" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 3: Link a Billing Account</h3>
                        <p class="mb-3 text-sm">If your project doesn't have a billing account, you'll see a prompt to **"Link a billing account"**. Click it. If you need to create one, select **"Manage billing accounts"** and then **"Create account"**.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-3.png" alt="Link billing account" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                    <div>
                        <h3 class="font-bold font-google-sans text-lg mb-2">Step 4: Set Up Payment</h3>
                        <p class="mb-3 text-sm">Follow the on-screen instructions to provide your payment information and complete the setup.</p>
                        <img src="https://storage.googleapis.com/gemini-codelab-images/billing-4.png" alt="Payment information" class="rounded-lg border shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/334155?text=Image+Not+Found';">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Editor Side Panel -->
    <div id="promptSidePanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="promptSidePanel" class="fixed top-0 right-0 h-full w-full max-w-lg bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-google-sans font-bold">Edit Prompts</h2>
                <button id="closePromptPanelBtn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                </button>
            </div>
            <!-- Prompt Panel Tabs -->
            <div class="border-b border-gray-200">
                <nav class="flex" aria-label="Prompt Panel Tabs">
                    <button id="promptPanelTabVideo" class="side-panel-tab active flex-1 border-b-2 py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Video Analysis</button>
                    <button id="promptPanelTabInventory" class="side-panel-tab flex-1 border-b-2 border-transparent py-3 px-1 text-center text-sm font-medium text-gray-500 hover:text-gray-700">Inventory Report</button>
                </nav>
            </div>
            <!-- Prompt Panel Content -->
            <div id="promptPanelContentVideo" class="p-6 overflow-y-auto flex-grow flex flex-col">
                <label for="videoPromptTextarea" class="font-semibold mb-2">Video Analysis Prompt</label>
                <textarea id="videoPromptTextarea" class="w-full flex-grow p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"></textarea>
                 <div class="mt-4 flex gap-4">
                    <button id="saveVideoPromptBtn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Save</button>
                    <button id="resetVideoPromptBtn" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Reset to Default</button>
                </div>
            </div>
            <div id="promptPanelContentInventory" class="p-6 overflow-y-auto flex-grow hidden flex-col">
                <label for="inventoryPromptTextarea" class="font-semibold mb-2">Inventory Report Prompt</label>
                <textarea id="inventoryPromptTextarea" class="w-full flex-grow p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"></textarea>
                 <div class="mt-4 flex gap-4">
                    <button id="saveInventoryPromptBtn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Save</button>
                    <button id="resetInventoryPromptBtn" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Reset to Default</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Hidden elements for frame capture -->
    <video id="videoPlayer" class="hidden" muted playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        // DOM Elements
        const modelSelector = document.getElementById('modelSelector');
        const googleKeyContainer = document.getElementById('googleKeyContainer');
        const openaiKeyContainer = document.getElementById('openaiKeyContainer');
        const googleApiKeyInput = document.getElementById('googleApiKeyInput');
        const openaiApiKeyInput = document.getElementById('openaiApiKeyInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const messageContainer = document.getElementById('messageContainer');
        const message = document.getElementById('message');
        const resultsWrapper = document.getElementById('resultsWrapper');
        
        // Video Tab Elements
        const videoUpload = document.getElementById('videoUpload');
        const fileNameDisplay = document.getElementById('fileName');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const aiActionsContainer = document.getElementById('aiActionsContainer');
        const generateSummaryBtn = document.getElementById('generateSummaryBtn');
        const downloadDataBtn = document.getElementById('downloadDataBtn');
        const seeOriginalAnswerBtn = document.getElementById('seeOriginalAnswerBtn');
        const aiResultText = document.getElementById('aiResultText');
        const aiResultLoading = document.getElementById('aiResultLoading');
        
        // Inventory Tab Elements
        const compareBtn = document.getElementById('compareBtn');
        const screenshot1Input = document.getElementById('screenshot1');
        const screenshot2Input = document.getElementById('screenshot2');
        const ss1Preview = document.getElementById('ss1-preview');
        const ss2Preview = document.getElementById('ss2-preview');
        const ss1Prompt = document.getElementById('ss1-prompt');
        const ss2Prompt = document.getElementById('ss2-prompt');
        const inventoryResultContainer = document.getElementById('inventoryResultContainer');
        const addedTrailersContainer = document.getElementById('addedTrailersContainer');
        const removedTrailersContainer = document.getElementById('removedTrailersContainer');
        const remainedTrailersContainer = document.getElementById('remainedTrailersContainer');

        
        // Tab Elements
        const tabVideo = document.getElementById('tabVideo');
        const tabInventory = document.getElementById('tabInventory');
        const videoContent = document.getElementById('videoContent');
        const inventoryContent = document.getElementById('inventoryContent');

        // Side Panel Elements
        const howToBtn = document.getElementById('howToBtn');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const panelTabKey = document.getElementById('panelTabKey');
        const panelTabBilling = document.getElementById('panelTabBilling');
        const panelContentKey = document.getElementById('panelContentKey');
        const panelContentBilling = document.getElementById('panelContentBilling');
        
        // Prompt Panel Elements
        const editVideoPromptBtn = document.getElementById('editVideoPromptBtn');
        const editInventoryPromptBtn = document.getElementById('editInventoryPromptBtn');
        const promptSidePanelOverlay = document.getElementById('promptSidePanelOverlay');
        const promptSidePanel = document.getElementById('promptSidePanel');
        const closePromptPanelBtn = document.getElementById('closePromptPanelBtn');
        const promptPanelTabVideo = document.getElementById('promptPanelTabVideo');
        const promptPanelTabInventory = document.getElementById('promptPanelTabInventory');
        const promptPanelContentVideo = document.getElementById('promptPanelContentVideo');
        const promptPanelContentInventory = document.getElementById('promptPanelContentInventory');
        const videoPromptTextarea = document.getElementById('videoPromptTextarea');
        const inventoryPromptTextarea = document.getElementById('inventoryPromptTextarea');
        const saveVideoPromptBtn = document.getElementById('saveVideoPromptBtn');
        const resetVideoPromptBtn = document.getElementById('resetVideoPromptBtn');
        const saveInventoryPromptBtn = document.getElementById('saveInventoryPromptBtn');
        const resetInventoryPromptBtn = document.getElementById('resetInventoryPromptBtn');
        
        const videoPlayer = document.getElementById('videoPlayer');
        const canvas = document.getElementById('canvas');

        let videoFile = null;
        let screenshot1File = null;
        let screenshot2File = null;
        let analysisData = [];
        let rawApiResponse = '';

        const defaultVideoPrompt = `You are a highly attentive logistics analyst specializing in visual recognition. Your task is to meticulously scan a truck yard and identify every unique semi-trailer that appears.
For each unique trailer, provide the following information in a strict JSON array of objects.

1. trailer_id: The primary alphanumeric identification number on the side of the trailer.
- CRITICAL: This ID is for tracking. Do NOT include physical dimensions like "53'" or "48'". These belong in the \`trailer_size\` field.
- PRIORITY: Your primary goal for this field is to find the main registration or tracking number, often a mix of letters and numbers.
- Example: If you see "XTRZ 123456" and "53'" nearby, the trailer_id is "XTRZ 123456".
2. carrier: The name of the trucking company, identified from any logos or text on the trailer.
3. is_loaded: A boolean value. This must be \`true\` if you see a plastic or metal seal on the trailer door handle, and \`false\` otherwise.
4. location: A string, representing the loading door number or physical location where the trailer is parked.
5. trailer_type: A string. Determine if the trailer is a "dry van" (a standard box trailer) or a "reefer" (a refrigerated trailer, which will have a large cooling unit on the front).
6. trailer_size: A number. Estimate the length of the trailer in feet. Look for numbers like 53 or 48.
7. image: the best frame for identification of the trailer.

Core Rules:

- Be Thorough: Analyze the entire input. Your main goal is to catalog EVERY unique trailer possible. You should AT LEAST analyze 10 frames per second in the video. 
- Accuracy is Key: Pay very close attention to the difference between trailer_id and trailer_size.
- Uniqueness: Only list each unique trailer_id once.
- Use Null: If you cannot determine information, use a null value for that field.
- Output Format: Your final output must be only the JSON array of objects, with no other text or markdown.`;
        
        const defaultInventoryPrompt = `You are a logistics yard auditor. Your task is to analyze the two provided images, a 'before' and 'after' state of loading doors.
Your goal is to identify which trailers have arrived, which have departed, and which have remained.

Respond with a single JSON object with three keys: "added", "removed", and "remained".
- "added": An array of objects, where each object represents a trailer that is present in the 'after' image but not the 'before' image.
- "removed": An array of objects, where each object represents a trailer that is present in the 'before' image but not the 'after' image.
- "remained": An array of objects, where each object represents a trailer that is present in BOTH the 'before' and 'after' images.

Each trailer object in the arrays must have the following keys:
- "trailer_id": The primary alphanumeric identification number on the side of the trailer. Be as precise as possible.
- "location": The door number or parking location where the change occurred.

Example of a perfect response:
{
  "added": [
    { "trailer_id": "HZCU 456789", "location": "Door 3" }
  ],
  "removed": [
    { "trailer_id": "XYZ 123456", "location": "Door 4" }
  ],
  "remained": [
    { "trailer_id": "ABC 789101", "location": "Door 1" }
  ]
}

Only output the JSON object. Do not include any other text, explanations, or markdown formatting.`;
        
        videoPromptTextarea.value = defaultVideoPrompt;
        inventoryPromptTextarea.value = defaultInventoryPrompt;

        // --- Event Listeners ---
        modelSelector.addEventListener('input', () => {
            const isGpt = modelSelector.value.startsWith('gpt');
            googleKeyContainer.classList.toggle('hidden', isGpt);
            openaiKeyContainer.classList.toggle('hidden', !isGpt);
            checkAllInputs();
        });

        googleApiKeyInput.addEventListener('input', checkAllInputs);
        openaiApiKeyInput.addEventListener('input', checkAllInputs);

        videoUpload.addEventListener('change', (event) => {
            videoFile = event.target.files[0];
            handleFileUpload(videoFile, fileNameDisplay, null, null);
            checkAllInputs();
        });
        
        screenshot1Input.addEventListener('change', (event) => {
            screenshot1File = event.target.files[0];
            handleFileUpload(screenshot1File, null, ss1Preview, ss1Prompt);
            checkAllInputs();
        });

        screenshot2Input.addEventListener('change', (event) => {
            screenshot2File = event.target.files[0];
            handleFileUpload(screenshot2File, null, ss2Preview, ss2Prompt);
            checkAllInputs();
        });
        
        analyzeBtn.addEventListener('click', handleAnalysis);
        compareBtn.addEventListener('click', handleInventory);
        generateSummaryBtn.addEventListener('click', handleGenerateSummary);
        downloadDataBtn.addEventListener('click', handleDownloadData);
        seeOriginalAnswerBtn.addEventListener('click', () => {
            aiResultText.value = rawApiResponse ? `--- RAW MODEL OUTPUT ---\n\n${rawApiResponse}` : 'No raw response available. Please run an analysis first.';
        });

        howToBtn.addEventListener('click', () => {
            sidePanel.classList.remove('translate-x-full');
            sidePanelOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });

        const closePanel = () => {
            sidePanel.classList.add('translate-x-full');
            sidePanelOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        };
        closePanelBtn.addEventListener('click', closePanel);
        sidePanelOverlay.addEventListener('click', closePanel);
        
        // Prompt Panel Listeners
        editVideoPromptBtn.addEventListener('click', () => openPromptPanel('video'));
        editInventoryPromptBtn.addEventListener('click', () => openPromptPanel('inventory'));

        const openPromptPanel = (tab) => {
            promptSidePanel.classList.remove('translate-x-full');
            promptSidePanelOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            switchPromptPanelTab(tab);
        };
        
        const closePromptPanel = () => {
            promptSidePanel.classList.add('translate-x-full');
            promptSidePanelOverlay.classList.add('hidden');
            document.body.style.overflow = '';
        };

        closePromptPanelBtn.addEventListener('click', closePromptPanel);
        promptSidePanelOverlay.addEventListener('click', closePromptPanel);
        saveVideoPromptBtn.addEventListener('click', closePromptPanel);
        saveInventoryPromptBtn.addEventListener('click', closePromptPanel);
        resetVideoPromptBtn.addEventListener('click', () => { videoPromptTextarea.value = defaultVideoPrompt; });
        resetInventoryPromptBtn.addEventListener('click', () => { inventoryPromptTextarea.value = defaultInventoryPrompt; });

        // Tab switching
        tabVideo.addEventListener('click', () => switchTab('video'));
        tabInventory.addEventListener('click', () => switchTab('inventory'));

        // Side Panel Tab switching
        panelTabKey.addEventListener('click', () => switchSidePanelTab('key'));
        panelTabBilling.addEventListener('click', () => switchSidePanelTab('billing'));
        promptPanelTabVideo.addEventListener('click', () => switchPromptPanelTab('video'));
        promptPanelTabInventory.addEventListener('click', () => switchPromptPanelTab('inventory'));


        // --- Core Functions ---
        
        function switchTab(tabName) {
            if (tabName === 'video') {
                tabVideo.classList.add('active');
                tabInventory.classList.remove('active');
                videoContent.classList.remove('hidden');
                inventoryContent.classList.add('hidden');
            } else {
                tabVideo.classList.remove('active');
                tabInventory.classList.add('active');
                videoContent.classList.add('hidden');
                inventoryContent.classList.remove('hidden');
            }
             resetOnTabSwitch();
              checkAllInputs();
        }

        function switchSidePanelTab(tabName) {
            if (tabName === 'key') {
                panelTabKey.classList.add('active');
                panelTabBilling.classList.remove('active');
                panelContentKey.classList.remove('hidden');
                panelContentBilling.classList.add('hidden');
            } else {
                panelTabKey.classList.remove('active');
                panelTabBilling.classList.add('active');
                panelContentKey.classList.add('hidden');
                panelContentBilling.classList.remove('hidden');
            }
        }
        
         function switchPromptPanelTab(tabName) {
            if (tabName === 'video') {
                promptPanelTabVideo.classList.add('active');
                promptPanelTabInventory.classList.remove('active');
                promptPanelContentVideo.classList.remove('hidden');
                promptPanelContentVideo.classList.add('flex');
                promptPanelContentInventory.classList.add('hidden');
                promptPanelContentInventory.classList.remove('flex');

            } else {
                promptPanelTabVideo.classList.remove('active');
                promptPanelTabInventory.classList.add('active');
                promptPanelContentVideo.classList.add('hidden');
                promptPanelContentVideo.classList.remove('flex');
                promptPanelContentInventory.classList.remove('hidden');
                promptPanelContentInventory.classList.add('flex');
            }
        }
        
        function hasApiKey() {
            const model = modelSelector.value;
            const googleKey = googleApiKeyInput.value.trim();
            const openaiKey = openaiApiKeyInput.value.trim();
            return model.startsWith('gpt') ? !!openaiKey : !!googleKey;
        }

        function checkAllInputs() {
            const hasKey = hasApiKey();
            analyzeBtn.disabled = !(hasKey && videoFile);
            compareBtn.disabled = !(hasKey && screenshot1File && screenshot2File);
        }

        function handleFileUpload(file, nameDisplay, previewEl, promptEl) {
            if (!file) return;
            if (file.size > 50 * 1024 * 1024) {
                displayMessage('File is too large. Please select a file smaller than 50MB.');
                return null;
            }
            if (nameDisplay) {
                nameDisplay.textContent = file.name;
            }
            if (previewEl && promptEl) {
                const reader = new FileReader();
                reader.onload = e => {
                    previewEl.src = e.target.result;
                    previewEl.classList.remove('hidden');
                    promptEl.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
            if (file.type.startsWith('video/')) {
                 const videoUrl = URL.createObjectURL(file);
                 videoPlayer.src = videoUrl;
            }
            messageContainer.classList.add('hidden');
            return file;
        }

        async function handleAnalysis() {
            resetUI(true);
            loading.classList.remove('hidden');
            const selectedModel = modelSelector.value;
            try {
                if (selectedModel.startsWith('gemini')) {
                    await analyzeWithGemini(selectedModel);
                } else {
                    await analyzeWithGPT4o(selectedModel);
                }
            } catch (error) {
                displayMessage(error.message);
            } finally {
                loading.classList.add('hidden');
                checkAllInputs();
            }
        }
        
        async function handleInventory() {
            resetUI(false);
            loading.classList.remove('hidden');
            const selectedModel = modelSelector.value;
            try {
                const apiKey = getApiKey();
                const prompt = inventoryPromptTextarea.value;
                
                const ss1_b64 = await fileToBase64(screenshot1File);
                const ss2_b64 = await fileToBase64(screenshot2File);
                
                let resultText = '';
                if (selectedModel.startsWith('gemini')) {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                    const payload = { 
                        contents: [{ parts: [
                            {text: prompt},
                            {inlineData: { mimeType: screenshot1File.type, data: ss1_b64 }},
                            {inlineData: { mimeType: screenshot2File.type, data: ss2_b64 }}
                        ]}],
                        generationConfig: {
                            "response_mime_type": "application/json",
                        }
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`${response.status}: ${await response.text()}`);
                    const result = await response.json();
                    resultText = result.candidates[0].content.parts[0].text;
                } else { // GPT-4o
                    const apiUrl = "https://api.openai.com/v1/chat/completions";
                    const payload = { 
                        model: selectedModel, 
                        response_format: { "type": "json_object" },
                        messages: [{ role: 'user', content: [
                            { type: 'text', text: prompt },
                            { type: 'image_url', image_url: { url: `data:${screenshot1File.type};base64,${ss1_b64}` }},
                            { type: 'image_url', image_url: { url: `data:${screenshot2File.type};base64,${ss2_b64}` }}
                        ]}]
                    };
                     const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`${response.status}: ${await response.text()}`);
                    const result = await response.json();
                    resultText = result.choices[0].message.content;
                }
                
                const reportData = JSON.parse(resultText);
                displayInventoryReport(reportData);

            } catch (error) {
                 displayMessage(error.message);
            } finally {
                loading.classList.add('hidden');
                checkAllInputs();
            }
        }
        
        async function analyzeWithGemini(model) {
            const apiKey = getApiKey();
            const base64Video = await fileToBase64(videoFile);
            const prompt = videoPromptTextarea.value;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            // Enable JSON mode for Gemini models
            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: videoFile.type, data: base64Video } }] }],
                generationConfig: {
                    "response_mime_type": "application/json",
                }
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            rawApiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || JSON.stringify(result, null, 2);

            if (!response.ok) {
                 throw new Error(`API Error: ${response.status} ${response.statusText}\n\nResponse:\n${rawApiResponse}`);
            }
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                // Since we're in JSON mode, the text is guaranteed to be a JSON string.
                processApiResponse(rawApiResponse);
            } else {
                throw new Error(`No content found in Gemini API response. Full Response:\n${rawApiResponse}`);
            }
        }
        
        async function analyzeWithGPT4o(model) {
            const apiKey = getApiKey();
            const frames = await extractFrames(videoPlayer, 10); 
            if (frames.length === 0) throw new Error("Could not extract frames from video.");
            
            const prompt = videoPromptTextarea.value;
            const apiUrl = `https://api.openai.com/v1/chat/completions`;
            const contentPayload = [{ type: "text", text: prompt }, ...frames.map(f => ({type: "image_url", image_url: {url: f, detail: "high"}}))];
            const payload = { model: model, messages: [{ role: "user", content: contentPayload }], max_tokens: 4096 };
            
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            const result = await response.json();

            rawApiResponse = result.choices?.[0]?.message?.content || JSON.stringify(result, null, 2);

            if (!response.ok) {
                 throw new Error(`API Error: ${response.status} ${response.statusText}\n\nResponse:\n${rawApiResponse}`);
            }
            if (result.choices?.[0]?.message?.content) {
                processApiResponse(rawApiResponse);
            } else {
                 throw new Error(`No content found in OpenAI API response. Full Response:\n${rawApiResponse}`);
            }
        }
        
        function processApiResponse(responseText) {
            // This function is designed to be highly robust in extracting a JSON array (our dataframe)
            // from a potentially messy LLM response that might include extra text.

            // 1. Find the first opening square bracket '[' or brace '{'.
            const firstBracket = responseText.indexOf('[');
            const firstBrace = responseText.indexOf('{');
            let startChar = '';
            let endChar = '';
            let startIndex = -1;

            if (firstBracket !== -1 && (firstBrace === -1 || firstBracket < firstBrace)) {
                 startIndex = firstBracket;
                 startChar = '[';
                 endChar = ']';
            } else if (firstBrace !== -1) {
                startIndex = firstBrace;
                startChar = '{';
                endChar = '}';
            }

            if (startIndex === -1) {
                 throw new Error(`Could not find a valid JSON object or array in the API response. Raw response:\n\n${responseText}`);
            }

            // 2. Find the last closing character that matches the starting one.
            const lastBracket = responseText.lastIndexOf(endChar);

            if (lastBracket === -1 || lastBracket < startIndex) {
                throw new Error(`Could not find a complete JSON structure in the API response. Raw response:\n\n${responseText}`);
            }

            // 3. Extract the text between them.
            const jsonString = responseText.substring(startIndex, lastBracket + 1);

            let parsedData;
            try {
                // 4. Attempt to parse the extracted string as JSON.
                parsedData = JSON.parse(jsonString);
            } catch (e) {
                throw new Error(`Found what looks like JSON, but it was not valid. Error: ${e.message}\n\nExtracted Text:\n${jsonString}`);
            }

            // 5. The video analysis expects an array, so we handle that case.
            if (Array.isArray(parsedData)) {
                analysisData = parsedData;
                displayResults(analysisData);
            } else {
                throw new Error(`The extracted data was valid JSON but was not an array (dataframe) format as expected.\n\nParsed Data:\n${JSON.stringify(parsedData, null, 2)}`);
            }
        }

        async function handleGenerateSummary() {
            aiResultText.value = 'Generating summary...';
            messageContainer.classList.add('hidden');
            
            // The `analysisData` is a JavaScript array (our dataframe).
            // We must convert it to a string for the API prompt. JSON is a perfect format for this.
            const dataAsString = JSON.stringify(analysisData, null, 2);
            const prompt = `You are a logistics coordinator. Based on the following trailer data, write a brief, professional summary for the morning shift. Mention the total number of trailers, how many are loaded vs. unloaded, a breakdown of trailer types (dry vs. reefer), and list the carriers present. Here is the data:\n${dataAsString}`;
            
            try {
                const selectedModel = modelSelector.value;
                const apiKey = getApiKey();
                let generatedText = '';

                if (selectedModel.startsWith('gemini')) {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error((await response.json()).error.message);
                    const result = await response.json();
                    generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                } else { // GPT-4o
                    const apiUrl = `https://api.openai.com/v1/chat/completions`;
                    const payload = { model: selectedModel, messages: [{ role: "user", content: prompt }], max_tokens: 500 };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error((await response.json()).error.message);
                    const result = await response.json();
                    generatedText = result.choices?.[0]?.message?.content;
                }
                aiResultText.value = generatedText || "Could not generate text from AI.";
            } catch (error) {
                displayMessage(`AI Action Error: ${error.message}`);
                aiResultText.value = 'Failed to generate summary.';
            }
        }

        function handleDownloadData() {
            if (analysisData.length === 0) { displayMessage("No data to download."); return; }
            const headers = ["Trailer ID", "Carrier", "Is Loaded", "Location", "Trailer Type", "Trailer Size", "Image"];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" 
                + analysisData.map(row => [`"${row.trailer_id || ''}"`, `"${row.carrier || ''}"`, `"${row.is_loaded || 'false'}"`, `"${row.location || ''}"`, `"${row.trailer_type || ''}"`, `"${row.trailer_size || ''}"`, `"${row.image || ''}"`].join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "trailer_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getApiKey() {
            const isGpt = modelSelector.value.startsWith('gpt');
            const key = isGpt ? openaiApiKeyInput.value.trim() : googleApiKeyInput.value.trim();
            if (!key) throw new Error(`Please provide an ${isGpt ? 'OpenAI' : 'Google AI'} API Key.`);
            return key;
        }
        
        function resetOnTabSwitch() {
            resultsWrapper.classList.add('hidden');
            messageContainer.classList.add('hidden');
            loading.classList.add('hidden');
        }

        function resetUI(isVideoTab) {
            loading.classList.add('hidden');
            if (isVideoTab) {
                analyzeBtn.disabled = true;
            } else {
                compareBtn.disabled = true;
            }
            resetOnTabSwitch();
            rawApiResponse = ''; 
        }
        
        function getPromptText(isImageAnalysis = false) {
            return videoPromptTextarea.value;
        }
        
        function extractFrames(videoEl, framesPerSecond) {
            return new Promise(async (resolve, reject) => {
                if (!videoEl.duration || videoEl.duration === Infinity) {
                    videoEl.addEventListener('loadedmetadata', () => resolve(extractFrames(videoEl, framesPerSecond)), { once: true });
                    videoEl.addEventListener('error', () => reject('Video metadata could not be loaded.'), { once: true });
                    return;
                }
                const frames = [], maxFrames = 100, duration = videoEl.duration; // Capped max frames
                let totalFramesToCapture = Math.floor(duration * framesPerSecond);
                let interval;

                if (totalFramesToCapture > maxFrames) {
                    displayMessage(`Note: For performance, analysis is capped at ${maxFrames} frames.`, true);
                    totalFramesToCapture = maxFrames;
                }
                
                if (totalFramesToCapture <= 1) {
                    interval = 0;
                     totalFramesToCapture = 1;
                } else {
                     interval = duration / (totalFramesToCapture - 1);
                }

                if (totalFramesToCapture === 0) { resolve([]); return; }

                const canvas = document.getElementById('canvas'), context = canvas.getContext('2d');
                canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
                for (let i = 0; i < totalFramesToCapture; i++) {
                    videoEl.currentTime = Math.min(i * interval, duration);
                    await new Promise(r => videoEl.addEventListener('seeked', r, { once: true }));
                    context.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
                    frames.push(canvas.toDataURL('image/jpeg'));
                }
                resolve(frames);
            });
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function displayMessage(msg, isNote = false) {
            messageContainer.classList.remove('hidden');
            message.innerText = msg;
            message.style.color = isNote ? '#1f2937' : '#b91c1c';
            message.style.backgroundColor = isNote ? '#f3f4f6' : '#fef2f2';
            message.style.borderColor = isNote ? '#d1d5db' : '#fecaca';
        }

        function displayResults(trailers) {
            if (trailers.length === 0) { displayMessage("No trailers were identified."); return; }
            resultsTableBody.innerHTML = '';
            trailers.forEach(trailer => {
                const row = document.createElement('tr');
                const isLoaded = trailer.is_loaded === true || String(trailer.is_loaded).toLowerCase() === 'true';
                const loadedStatus = isLoaded
                    ? `<span class="inline-flex items-center justify-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-emerald-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Loaded</span>` 
                    : `<span class="inline-flex items-center justify-center rounded-full bg-red-100 px-2.5 py-0.5 text-red-700"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Not Loaded</span>`;
                row.innerHTML = `
                    <td class="whitespace-nowrap px-4 py-3 font-medium text-gray-900">${trailer.trailer_id || 'N/A'}</td><td class="whitespace-nowrap px-4 py-3 text-gray-700">${trailer.carrier || 'N/A'}</td><td class="whitespace-nowrap px-4 py-3 text-gray-700">${loadedStatus}</td><td class="whitespace-nowrap px-4 py-3 text-gray-700">${trailer.location || 'N/A'}</td><td class="whitespace-nowrap px-4 py-3 text-gray-700">${trailer.trailer_type || 'N/A'}</td><td class="whitespace-nowrap px-4 py-3 text-gray-700">${trailer.trailer_size || 'N/A'}</td><td class="whitespace-nowrap px-4 py-3 text-gray-700">${trailer.image || 'N/A'}</td>`;
                resultsTableBody.appendChild(row);
            });
            resultsWrapper.classList.remove('hidden');
            resultsContainer.classList.remove('hidden');
            aiActionsContainer.classList.remove('hidden');
        }

        function displayInventoryReport(data) {
            // Clear previous results
            addedTrailersContainer.innerHTML = '';
            remainedTrailersContainer.innerHTML = '';
            removedTrailersContainer.innerHTML = '';

            const createCard = (trailer, type) => {
                const card = document.createElement('div');
                card.className = 'p-4 rounded-lg shadow-sm border';
                card.innerHTML = `
                    <p class="font-semibold text-gray-800">${trailer.trailer_id || 'ID Unknown'}</p>
                    <p class="text-sm text-gray-500">Location: ${trailer.location || 'N/A'}</p>
                `;
                if (type === 'added') {
                    card.classList.add('bg-green-50', 'border-green-200');
                } else if (type === 'removed') {
                    card.classList.add('bg-red-50', 'border-red-200');
                } else { // remained
                     card.classList.add('bg-blue-50', 'border-blue-200');
                }
                return card;
            };

            if (data.added && data.added.length > 0) {
                data.added.forEach(trailer => {
                    addedTrailersContainer.appendChild(createCard(trailer, 'added'));
                });
            } else {
                addedTrailersContainer.innerHTML = '<p class="text-sm text-gray-500">No new trailers arrived.</p>';
            }

            if (data.remained && data.remained.length > 0) {
                data.remained.forEach(trailer => {
                    remainedTrailersContainer.appendChild(createCard(trailer, 'remained'));
                });
            } else {
                remainedTrailersContainer.innerHTML = '<p class="text-sm text-gray-500">No trailers remained.</p>';
            }

            if (data.removed && data.removed.length > 0) {
                data.removed.forEach(trailer => {
                    removedTrailersContainer.appendChild(createCard(trailer, 'removed'));
                });
            } else {
                removedTrailersContainer.innerHTML = '<p class="text-sm text-gray-500">No trailers departed.</p>';
            }
            
            resultsWrapper.classList.remove('hidden');
            inventoryResultContainer.classList.remove('hidden');
            aiActionsContainer.classList.add('hidden'); // Hide the general actions for this specific report
        }

    </script>
</body>
</html>
